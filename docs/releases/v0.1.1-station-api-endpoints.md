# Release v0.1.1 – Station API Endpoints

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Release Date:** 2025-12-12
>
> **Git Tag:** `v0.1.1`

---

## Overview

This release adds **REST API endpoints** for Station CRUD operations. These endpoints enable programmatic creation, retrieval, updating, and listing of stations in the print shop scheduling system.

### Why This Matters

- **Frontend integration**: The scheduling UI needs APIs to display and manage stations
- **System configuration**: Administrators can set up the workshop through the API
- **Testing foundation**: API endpoints enable integration testing
- **Future automation**: External systems can integrate with station management

---

## Prerequisites

- [x] `v0.1.0` released (Station Entity with repository and tests)
- [x] Docker containers running (MariaDB, PHP-FPM, Nginx)
- [x] Symfony 7 project with Doctrine ORM configured

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| POST /api/v1/stations | Create a new station |
| GET /api/v1/stations | List all stations with optional filters |
| GET /api/v1/stations/{id} | Get single station by ID |
| PUT /api/v1/stations/{id} | Update an existing station |
| DELETE /api/v1/stations/{id} | Delete a station (soft or hard TBD) |
| DTO Classes | Request/Response data transfer objects |
| Input Validation | Request validation with error messages |
| Integration Tests | API endpoint tests |
| OpenAPI Documentation | nelmio/api-doc-bundle integration |

### Out of Scope

| Item | Reason |
|------|--------|
| Operating Schedule endpoints | Covered in v0.1.2 |
| Schedule Exceptions endpoints | Covered in v0.1.3 |
| StationCategory CRUD | Covered in v0.1.4 |
| StationGroup CRUD | Covered in v0.1.5 |
| Authentication/Authorization | Covered in v1.0.0 |

---

## Related Documentation

| Document | Sections |
|----------|----------|
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 1: Station Management API |
| [v0.1.0 Release](v0.1.0-station-entity.md) | Station Entity implementation |
| [Business Rules](../domain-model/business-rules.md) | BR-STATION-* rules |

---

## API Specification

### Base URL

```
/api/v1/stations
```

### Content Type

All endpoints accept and return `application/json`.

---

### POST /api/v1/stations

Create a new station.

**Request Body:**

```json
{
  "name": "Komori G37",
  "categoryId": "550e8400-e29b-41d4-a716-446655440001",
  "groupId": "550e8400-e29b-41d4-a716-446655440002",
  "capacity": 1,
  "status": "active"
}
```

| Field | Type | Required | Validation |
|-------|------|----------|------------|
| `name` | string | Yes | Non-empty, max 100 chars, unique |
| `categoryId` | UUID | Yes | Must exist in station_categories |
| `groupId` | UUID | Yes | Must exist in station_groups |
| `capacity` | integer | No | Min 1, default 1 |
| `status` | string | No | One of: active, inactive, out_of_service, maintenance. Default: active |

**Response (201 Created):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Komori G37",
  "categoryId": "550e8400-e29b-41d4-a716-446655440001",
  "groupId": "550e8400-e29b-41d4-a716-446655440002",
  "capacity": 1,
  "status": "active",
  "operatingSchedule": null,
  "createdAt": "2025-12-12T10:00:00+00:00",
  "updatedAt": "2025-12-12T10:00:00+00:00"
}
```

**Error Responses:**

| Status | Code | Description |
|--------|------|-------------|
| 400 | VALIDATION_ERROR | Invalid input (see details) |
| 409 | CONFLICT | Station name already exists |
| 404 | NOT_FOUND | Category or Group not found |

**Example Error (409):**

```json
{
  "error": {
    "code": "CONFLICT",
    "message": "Station with name 'Komori G37' already exists",
    "details": {
      "field": "name",
      "value": "Komori G37"
    }
  }
}
```

---

### GET /api/v1/stations

List all stations with optional filtering.

**Query Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `status` | string | Filter by status (active, inactive, out_of_service, maintenance) |
| `categoryId` | UUID | Filter by category |
| `groupId` | UUID | Filter by group |
| `search` | string | Search in name (partial match) |
| `page` | integer | Page number (default: 1) |
| `limit` | integer | Items per page (default: 20, max: 100) |

**Response (200 OK):**

```json
{
  "items": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Komori G37",
      "categoryId": "550e8400-e29b-41d4-a716-446655440001",
      "groupId": "550e8400-e29b-41d4-a716-446655440002",
      "capacity": 1,
      "status": "active",
      "createdAt": "2025-12-12T10:00:00+00:00",
      "updatedAt": "2025-12-12T10:00:00+00:00"
    }
  ],
  "total": 15,
  "page": 1,
  "limit": 20,
  "pages": 1
}
```

---

### GET /api/v1/stations/{id}

Get a single station by ID.

**Path Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `id` | UUID | Station ID |

**Response (200 OK):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Komori G37",
  "categoryId": "550e8400-e29b-41d4-a716-446655440001",
  "groupId": "550e8400-e29b-41d4-a716-446655440002",
  "capacity": 1,
  "status": "active",
  "operatingSchedule": null,
  "createdAt": "2025-12-12T10:00:00+00:00",
  "updatedAt": "2025-12-12T10:00:00+00:00"
}
```

**Error Responses:**

| Status | Code | Description |
|--------|------|-------------|
| 404 | NOT_FOUND | Station not found |

---

### PUT /api/v1/stations/{id}

Update an existing station.

**Path Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `id` | UUID | Station ID |

**Request Body (partial updates supported):**

```json
{
  "name": "Komori G37 XL",
  "status": "maintenance",
  "capacity": 2
}
```

| Field | Type | Required | Validation |
|-------|------|----------|------------|
| `name` | string | No | Non-empty, max 100 chars, unique |
| `categoryId` | UUID | No | Must exist in station_categories |
| `groupId` | UUID | No | Must exist in station_groups |
| `capacity` | integer | No | Min 1 |
| `status` | string | No | One of: active, inactive, out_of_service, maintenance |

**Response (200 OK):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Komori G37 XL",
  "categoryId": "550e8400-e29b-41d4-a716-446655440001",
  "groupId": "550e8400-e29b-41d4-a716-446655440002",
  "capacity": 2,
  "status": "maintenance",
  "operatingSchedule": null,
  "createdAt": "2025-12-12T10:00:00+00:00",
  "updatedAt": "2025-12-12T11:30:00+00:00"
}
```

**Error Responses:**

| Status | Code | Description |
|--------|------|-------------|
| 400 | VALIDATION_ERROR | Invalid input |
| 404 | NOT_FOUND | Station not found |
| 409 | CONFLICT | Name already exists |

---

### DELETE /api/v1/stations/{id}

Delete a station.

**Path Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `id` | UUID | Station ID |

**Response (204 No Content):**

Empty response body.

**Error Responses:**

| Status | Code | Description |
|--------|------|-------------|
| 404 | NOT_FOUND | Station not found |
| 409 | CONFLICT | Station has assigned tasks (future) |

> **Note:** For MVP, this is a hard delete. Soft delete may be added in future releases.

---

## File Structure

```
services/php-api/
├── src/
│   ├── Controller/
│   │   └── Api/
│   │       └── V1/
│   │           └── StationController.php    # REST controller
│   ├── DTO/
│   │   ├── Station/
│   │   │   ├── CreateStationRequest.php     # Create request DTO
│   │   │   ├── UpdateStationRequest.php     # Update request DTO
│   │   │   ├── StationResponse.php          # Single station response
│   │   │   └── StationListResponse.php      # Paginated list response
│   │   └── ErrorResponse.php                # Standard error format
│   ├── Service/
│   │   └── StationService.php               # Business logic layer
│   └── Exception/
│       ├── ValidationException.php          # Input validation errors
│       ├── NotFoundException.php            # Resource not found
│       └── ConflictException.php            # Duplicate/conflict errors
├── config/
│   └── packages/
│       └── nelmio_api_doc.yaml              # OpenAPI configuration
└── tests/
    └── Controller/
        └── Api/
            └── V1/
                └── StationControllerTest.php # Integration tests
```

---

## Implementation Details

### Controller Design

The controller should:
- Use constructor injection for dependencies
- Delegate business logic to StationService
- Return appropriate HTTP status codes
- Use DTO classes for type-safe request/response handling

```php
#[Route('/api/v1/stations', name: 'api_v1_stations_')]
class StationController extends AbstractController
{
    public function __construct(
        private readonly StationService $stationService,
    ) {}

    #[Route('', name: 'create', methods: ['POST'])]
    public function create(CreateStationRequest $request): JsonResponse
    {
        $station = $this->stationService->create($request);
        return $this->json(
            StationResponse::fromEntity($station),
            Response::HTTP_CREATED
        );
    }
    // ...
}
```

### DTO Validation

Use Symfony Validator component:

```php
class CreateStationRequest
{
    #[Assert\NotBlank(message: 'Station name is required')]
    #[Assert\Length(max: 100, maxMessage: 'Name cannot exceed 100 characters')]
    public string $name;

    #[Assert\NotBlank(message: 'Category ID is required')]
    #[Assert\Uuid(message: 'Invalid category ID format')]
    public string $categoryId;

    #[Assert\NotBlank(message: 'Group ID is required')]
    #[Assert\Uuid(message: 'Invalid group ID format')]
    public string $groupId;

    #[Assert\Positive(message: 'Capacity must be at least 1')]
    public int $capacity = 1;

    #[Assert\Choice(
        choices: ['active', 'inactive', 'out_of_service', 'maintenance'],
        message: 'Invalid status'
    )]
    public string $status = 'active';
}
```

### Service Layer

The StationService handles:
- Entity creation with UUID generation
- Validation of foreign key references
- Unique name constraint checking
- Repository interactions

```php
class StationService
{
    public function __construct(
        private readonly StationRepository $stationRepository,
        private readonly StationCategoryRepository $categoryRepository,
        private readonly StationGroupRepository $groupRepository,
    ) {}

    public function create(CreateStationRequest $request): Station
    {
        // Validate category exists
        $category = $this->categoryRepository->find($request->categoryId);
        if (!$category) {
            throw new NotFoundException('Station category not found');
        }

        // Validate group exists
        $group = $this->groupRepository->find($request->groupId);
        if (!$group) {
            throw new NotFoundException('Station group not found');
        }

        // Check name uniqueness
        if ($this->stationRepository->findByName($request->name)) {
            throw new ConflictException('Station name already exists');
        }

        // Create and persist
        $station = new Station(
            id: Uuid::v4()->toRfc4122(),
            name: $request->name,
            categoryId: $request->categoryId,
            groupId: $request->groupId,
            status: StationStatus::from($request->status),
            capacity: $request->capacity,
        );

        $this->stationRepository->save($station);

        return $station;
    }
}
```

### Error Handling

Create a global exception listener for consistent error responses:

```php
class ApiExceptionListener
{
    public function onKernelException(ExceptionEvent $event): void
    {
        $exception = $event->getThrowable();

        $response = match (true) {
            $exception instanceof ValidationException => new JsonResponse(
                ['error' => ['code' => 'VALIDATION_ERROR', 'message' => $exception->getMessage(), 'details' => $exception->getErrors()]],
                Response::HTTP_BAD_REQUEST
            ),
            $exception instanceof NotFoundException => new JsonResponse(
                ['error' => ['code' => 'NOT_FOUND', 'message' => $exception->getMessage()]],
                Response::HTTP_NOT_FOUND
            ),
            $exception instanceof ConflictException => new JsonResponse(
                ['error' => ['code' => 'CONFLICT', 'message' => $exception->getMessage()]],
                Response::HTTP_CONFLICT
            ),
            default => null,
        };

        if ($response) {
            $event->setResponse($response);
        }
    }
}
```

---

## OpenAPI Documentation

Install and configure nelmio/api-doc-bundle:

```bash
composer require nelmio/api-doc-bundle
```

Use PHP attributes for documentation:

```php
#[OA\Post(
    path: '/api/v1/stations',
    summary: 'Create a new station',
    requestBody: new OA\RequestBody(
        required: true,
        content: new OA\JsonContent(ref: '#/components/schemas/CreateStationRequest')
    ),
    responses: [
        new OA\Response(
            response: 201,
            description: 'Station created',
            content: new OA\JsonContent(ref: '#/components/schemas/StationResponse')
        ),
        new OA\Response(response: 400, description: 'Validation error'),
        new OA\Response(response: 409, description: 'Name conflict'),
    ]
)]
public function create(CreateStationRequest $request): JsonResponse
```

---

## Feature Checklist

### Controller Layer

- [x] **Create StationController**
  - File: `src/Controller/Api/V1/StationController.php`
  - Endpoints: POST, GET (list), GET (single), PUT, DELETE

### DTO Layer

- [x] **Create CreateStationRequest DTO**
  - File: `src/DTO/Station/CreateStationRequest.php`
  - Validation constraints

- [x] **Create UpdateStationRequest DTO**
  - File: `src/DTO/Station/UpdateStationRequest.php`
  - All fields optional

- [x] **Create StationResponse DTO**
  - File: `src/DTO/Station/StationResponse.php`
  - Static factory method from entity

- [x] **Create StationListResponse DTO**
  - File: `src/DTO/Station/StationListResponse.php`
  - Pagination metadata

- [x] **Create ErrorResponse DTO**
  - File: `src/DTO/ErrorResponse.php`
  - Standard error format

### Service Layer

- [x] **Create StationService**
  - File: `src/Service/StationService.php`
  - Methods: create, update, delete, findById, findAll

### Exception Handling

- [x] **Create custom exceptions**
  - Files: `src/Exception/ValidationException.php`, `NotFoundException.php`, `ConflictException.php`

- [x] **Create ApiExceptionListener**
  - File: `src/EventListener/ApiExceptionListener.php`
  - Register in services.yaml

### Repository Updates

- [x] **Add save() method to StationRepository**
  - Persist and flush entity

- [x] **Add delete() method to StationRepository**
  - Remove entity

- [x] **Add findByName() method to StationRepository**
  - For uniqueness check

- [x] **Add pagination support to findAll()**
  - Accept page, limit parameters

### OpenAPI Documentation

- [x] **Install nelmio/api-doc-bundle**
  - Configure in config/packages/nelmio_api_doc.yaml

- [x] **Add OpenAPI attributes to controller**
  - Document all endpoints

- [x] **Configure Swagger UI route**
  - Accessible at /api/doc

### Testing

- [x] **Create StationControllerTest**
  - File: `tests/Integration/Controller/Api/V1/StationControllerTest.php`
  - Test cases:
    - Create station success
    - Create station validation errors
    - Create station duplicate name
    - List stations
    - List stations with filters
    - Get single station
    - Get non-existent station
    - Update station success
    - Update station not found
    - Delete station success
    - Delete station not found

---

## Testing Requirements

### Integration Tests

| Test Case | Expected Result |
|-----------|-----------------|
| POST valid station | 201, station created |
| POST empty name | 400, validation error |
| POST duplicate name | 409, conflict |
| POST invalid categoryId | 404, category not found |
| POST invalid groupId | 404, group not found |
| GET list | 200, array of stations |
| GET list with status filter | 200, filtered results |
| GET list with pagination | 200, correct page |
| GET by ID | 200, station object |
| GET non-existent ID | 404, not found |
| PUT valid update | 200, updated station |
| PUT non-existent ID | 404, not found |
| PUT duplicate name | 409, conflict |
| DELETE existing | 204, no content |
| DELETE non-existent | 404, not found |

### Test Data Setup

Tests need seed data:
- At least one StationCategory
- At least one StationGroup

```php
protected function setUp(): void
{
    parent::setUp();

    // Create test category
    $this->categoryId = Uuid::v4()->toRfc4122();
    $this->entityManager->getConnection()->executeStatement(
        "INSERT INTO station_categories (id, name) VALUES (?, ?)",
        [$this->categoryId, 'Test Category']
    );

    // Create test group
    $this->groupId = Uuid::v4()->toRfc4122();
    $this->entityManager->getConnection()->executeStatement(
        "INSERT INTO station_groups (id, name, max_concurrent) VALUES (?, ?, ?)",
        [$this->groupId, 'Test Group', null]
    );
}
```

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All integration tests passing
- [x] OpenAPI documentation accessible at /api/doc
- [x] Manual testing via curl/Postman successful
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 5+)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.1`

---

## Dependencies to Install

```bash
cd services/php-api

# API documentation
composer require nelmio/api-doc-bundle

# Serializer (if not already installed)
composer require symfony/serializer

# Validator (if not already installed)
composer require symfony/validator

# UID component (already installed in v0.1.0)
# composer require symfony/uid
```

---

## Release Notes Draft

```markdown
## v0.1.1 – Station API Endpoints

**Release Date:** 2025-12-12

### Summary

Adds REST API endpoints for Station CRUD operations, enabling programmatic
management of print shop workstations.

### What's New

- **POST /api/v1/stations** - Create new station
- **GET /api/v1/stations** - List stations with filtering and pagination
- **GET /api/v1/stations/{id}** - Get single station
- **PUT /api/v1/stations/{id}** - Update station
- **DELETE /api/v1/stations/{id}** - Delete station
- **OpenAPI documentation** at /api/doc
- **Consistent error handling** with standard error format
- **Input validation** with detailed error messages

### API Documentation

Access the interactive API documentation at:
```
http://localhost:8080/api/doc
```

### Breaking Changes

None.

### Migration Guide

No migration required. New endpoints are additive.
```

---

## Post-Release

- [x] Verify API documentation accessible
- [x] Test endpoints with curl/Postman
- [ ] Update frontend mock data to match API response format
- [ ] Proceed to v0.1.2 (Operating Schedule)

---

## Appendix: curl Examples

### Create Station

```bash
curl -X POST http://localhost:8080/api/v1/stations \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Komori G37",
    "categoryId": "550e8400-e29b-41d4-a716-446655440001",
    "groupId": "550e8400-e29b-41d4-a716-446655440002",
    "capacity": 1
  }'
```

### List Stations

```bash
curl http://localhost:8080/api/v1/stations?status=active&limit=10
```

### Get Station

```bash
curl http://localhost:8080/api/v1/stations/550e8400-e29b-41d4-a716-446655440000
```

### Update Station

```bash
curl -X PUT http://localhost:8080/api/v1/stations/550e8400-e29b-41d4-a716-446655440000 \
  -H "Content-Type: application/json" \
  -d '{
    "status": "maintenance"
  }'
```

### Delete Station

```bash
curl -X DELETE http://localhost:8080/api/v1/stations/550e8400-e29b-41d4-a716-446655440000
```
