# Release v0.1.11 – Task Entity

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Target Date:** 2025-12-13
>
> **Git Tag:** `v0.1.11`

---

## Overview

This release implements the Task entity as part of the Job aggregate. Tasks represent individual production operations that can be performed either on internal workshop stations or outsourced to external providers. This is a foundational release that creates the domain model without API endpoints.

---

## Prerequisites

- [x] `v0.1.9` released (Job Entity)
- [x] `v0.1.10` released (Job CRUD API)

---

## Scope

### In Scope

- Task entity (part of Job aggregate)
- TaskStatus enum (Defined/Ready/Assigned/Completed/Cancelled)
- TaskType enum (Internal/Outsourced)
- Duration value object (setupMinutes, runMinutes, durationOpenDays)
- Task-to-Job relationship (one-to-many)
- Task sequence/order within Job
- Database migration for tasks table
- Unit tests for Task entity and value objects

### Out of Scope

- Task CRUD API endpoints (future release)
- DSL parsing for task creation (v0.1.12)
- Task assignment to schedules (v0.2.x)
- Precedence validation (v0.2.x)

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | Task, TaskDSL |
| [Business Rules](../domain-model/business-rules.md) | BR-TASK-001 through BR-TASK-009 |

### Architecture

| Document | Sections |
|----------|----------|
| [Release Roadmap](../roadmap/release-roadmap.md) | v0.1.11 - Task Entity |

---

## Technical Notes

### Task Types

**Internal Task:**
- Performed on a workshop station
- Duration: setupMinutes + runMinutes
- References: stationId (nullable until DSL parsing implemented)

**Outsourced Task:**
- Performed by external provider
- Duration: durationOpenDays (business days)
- References: providerId, actionType (nullable until DSL parsing implemented)

### Task Status Flow

```
Defined → Ready → Assigned → Completed
                      ↓
                  Cancelled
```

- **Defined**: Task created but dependencies not yet satisfied
- **Ready**: Dependencies satisfied, can be scheduled
- **Assigned**: Scheduled to a specific time slot
- **Completed**: Work finished
- **Cancelled**: Task cancelled (terminal state)

### Database Schema

```sql
CREATE TABLE tasks (
    id CHAR(36) PRIMARY KEY,
    job_id CHAR(36) NOT NULL,
    sequence_order INT NOT NULL,
    task_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'defined',

    -- Internal task fields
    station_id CHAR(36) NULL,
    setup_minutes INT NULL,
    run_minutes INT NULL,

    -- Outsourced task fields
    provider_id CHAR(36) NULL,
    action_type VARCHAR(50) NULL,
    duration_open_days INT NULL,

    -- Common fields
    comment TEXT NULL,
    raw_dsl VARCHAR(255) NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,

    FOREIGN KEY (job_id) REFERENCES jobs(id) ON DELETE CASCADE,
    INDEX idx_task_job_id (job_id),
    INDEX idx_task_status (status)
);
```

### Aggregate Design

Task is a child entity within the Job aggregate. All Task operations should go through the Job aggregate root:
- `Job::addTask(Task $task)`
- `Job::getTasks(): array`
- `Job::getTaskBySequence(int $sequence): ?Task`

---

## Feature Checklist

### Enums

- [x] **TaskStatus**
  - Description: Workflow states for tasks
  - Values: Defined, Ready, Assigned, Completed, Cancelled
  - Methods: label(), canBeScheduled(), isTerminal(), isActive()
  - Files: `src/Entity/TaskStatus.php`
  - Tests: `tests/Unit/Entity/TaskStatusTest.php` (20 tests)

- [x] **TaskType**
  - Description: Distinguishes internal vs outsourced tasks
  - Values: Internal, Outsourced
  - Methods: label(), isInternal(), isOutsourced()
  - Files: `src/Entity/TaskType.php`
  - Tests: `tests/Unit/Entity/TaskTypeTest.php` (7 tests)

### Value Objects

- [x] **Duration**
  - Description: Represents task duration (setup+run or open days)
  - Factory methods: forInternal(setup, run), forOutsourced(openDays), fromArray()
  - Methods: getTotalMinutes(), getSetupMinutes(), getRunMinutes(), getOpenDays(), isInternal(), equals()
  - Validation: positive values, type-appropriate fields (BR-TASK-002)
  - Files: `src/ValueObject/Duration.php`
  - Tests: `tests/Unit/ValueObject/DurationTest.php` (29 tests)

### Entity

- [x] **Task**
  - Description: Production operation within a Job
  - Fields: id, job, sequenceOrder, taskType, status, stationId, providerId, actionType, duration, comment, rawDsl, timestamps
  - Factory methods: createInternal(), createOutsourced()
  - Methods: changeStatus(), markReady(), markAssigned(), markCompleted(), markCancelled(), updateComment(), getDuration()
  - Validation: BR-TASK-001, BR-TASK-002, BR-TASK-003
  - Files: `src/Entity/Task.php`
  - Tests: `tests/Unit/Entity/TaskTest.php` (29 tests)

### Repository

- [x] **TaskRepository**
  - Description: Repository for Task entity
  - Methods: save(), remove(), findByJob(), findByStatus(), getNextSequenceOrder(), countByJob()
  - Files: `src/Repository/TaskRepository.php`

### Job Integration

- [x] **Job task methods**
  - Description: Add task to job with auto-incrementing sequence
  - Methods: addInternalTask(), addOutsourcedTask(), getTasks(), getTasksArray(), getTaskCount(), hasTasks()
  - Files: `src/Entity/Job.php` (modified)
  - Tests: `tests/Unit/Entity/JobTest.php` (9 new tests)

### Migration

- [x] **Database Migration**
  - Description: Create tasks table with foreign key to jobs
  - Files: `migrations/Version20251213010000.php`

---

## Testing Requirements

### Unit Tests

- [x] TaskStatus enum tests (20 tests - all values, helper methods)
- [x] TaskType enum tests (7 tests - all values, helper methods)
- [x] Duration value object tests (29 tests - factory methods, validation, getters)
- [x] Task entity tests (29 tests - creation, status changes, validation)
- [x] Job addTask integration tests (9 tests)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (604 tests, 1607 assertions)
- [x] PHPStan level 8 passing
- [x] Database migration created
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.11`

---

## Release Notes Draft

```markdown
## v0.1.11 – Task Entity

**Release Date:** 2025-12-13

### Summary

Task entity implementation as part of the Job aggregate, supporting both internal workshop tasks and outsourced provider tasks.

### What's New

- Task entity with job relationship
- TaskStatus enum (Defined, Ready, Assigned, Completed, Cancelled)
- TaskType enum (Internal, Outsourced)
- Duration value object for setup/run times and open days
- Job::addTask() method for adding tasks
- Database migration for tasks table

### Technical Details

- Task is a child entity within Job aggregate
- Internal tasks have setup + run minutes
- Outsourced tasks have duration in open days
- Tasks maintain sequence order within their job
```

---

## Post-Release

- [x] GitHub release created
- [x] Documentation updated
- [x] CI passing
