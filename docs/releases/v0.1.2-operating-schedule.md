# Release v0.1.2 – Operating Schedule

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Release Date:** 2025-12-12
>
> **Git Tag:** `v0.1.2`

---

## Overview

This release implements the **Operating Schedule** feature for stations. An operating schedule defines when a station is available for task assignments through a weekly pattern of time slots. This is essential for the scheduling system to calculate valid assignment times and detect availability conflicts.

### Why This Matters

- **Scheduling accuracy**: Tasks can only be scheduled during operating hours
- **Duration calculation**: Task end times must account for non-operating periods (stretching)
- **Conflict detection**: The validator uses operating schedules to detect availability conflicts
- **Real-world modeling**: Print shops have specific working hours per station

---

## Prerequisites

- [x] `v0.1.0` released (Station Entity with `operatingSchedule` JSON column)
- [x] `v0.1.1` released (Station API Endpoints)
- [x] Station entity has `operatingSchedule` nullable JSON column (ready for data)

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| TimeSlot value object | Start/end time validation (HH:MM format) |
| DaySchedule value object | Day configuration with time slots |
| OperatingSchedule value object | Full weekly pattern (Mon-Sun) |
| Station::setOperatingSchedule() | Domain method with validation |
| PUT /api/v1/stations/{id}/schedule | API endpoint to update schedule |
| Time slot overlap validation | BR-STATION-005 enforcement |
| Default schedule generation | Helper for common patterns |
| Unit tests | Value object and validation tests |
| Integration tests | API endpoint tests |

### Out of Scope

| Item | Reason |
|------|--------|
| Schedule Exceptions | Covered in v0.1.3 |
| Duration stretching logic | Covered in v0.2.x (Assignment Service) |
| UI schedule editor | Covered in M3 (Frontend) |
| Holiday calendar | Covered in v0.2.16 (Business Calendar) |

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-STATION-004, BR-STATION-005 |
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | OperatingSchedule, DaySchedule, TimeSlot |

### Types Package

| File | Types |
|------|-------|
| `packages/types/src/station.ts` | `TimeSlot`, `DaySchedule`, `OperatingSchedule` |

### API

| Document | Sections |
|----------|----------|
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 1: Station Management API |

---

## Domain Model Reference

### OperatingSchedule Structure

```
┌─────────────────────────────────────────────────────────────┐
│                    OperatingSchedule                         │
├─────────────────────────────────────────────────────────────┤
│  monday: DaySchedule                                        │
│  tuesday: DaySchedule                                       │
│  wednesday: DaySchedule                                     │
│  thursday: DaySchedule                                      │
│  friday: DaySchedule                                        │
│  saturday: DaySchedule                                      │
│  sunday: DaySchedule                                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      DaySchedule                             │
├─────────────────────────────────────────────────────────────┤
│  isOperating: boolean                                       │
│  slots: TimeSlot[]                                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       TimeSlot                               │
├─────────────────────────────────────────────────────────────┤
│  start: string (HH:MM)                                      │
│  end: string (HH:MM)                                        │
└─────────────────────────────────────────────────────────────┘
```

### Example Schedule

```json
{
  "monday": {
    "isOperating": true,
    "slots": [
      {"start": "06:00", "end": "12:00"},
      {"start": "13:00", "end": "17:00"}
    ]
  },
  "tuesday": {
    "isOperating": true,
    "slots": [
      {"start": "06:00", "end": "12:00"},
      {"start": "13:00", "end": "17:00"}
    ]
  },
  "wednesday": {
    "isOperating": true,
    "slots": [
      {"start": "06:00", "end": "12:00"},
      {"start": "13:00", "end": "17:00"}
    ]
  },
  "thursday": {
    "isOperating": true,
    "slots": [
      {"start": "06:00", "end": "12:00"},
      {"start": "13:00", "end": "17:00"}
    ]
  },
  "friday": {
    "isOperating": true,
    "slots": [
      {"start": "06:00", "end": "12:00"},
      {"start": "13:00", "end": "17:00"}
    ]
  },
  "saturday": {
    "isOperating": false,
    "slots": []
  },
  "sunday": {
    "isOperating": false,
    "slots": []
  }
}
```

---

## Business Rules

| Rule ID | Description | Enforcement |
|---------|-------------|-------------|
| **BR-STATION-004** | Station operating schedule required | API: Schedule can be set, but not required until assignment |
| **BR-STATION-005** | Schedule slots cannot overlap | Value object: Validation in `DaySchedule` constructor |

### Time Slot Validation Rules

| Rule | Description | Example |
|------|-------------|---------|
| Valid format | Times must be HH:MM (24h) | "06:00", "17:30" |
| Start before end | Start time must be before end time | "06:00" < "12:00" |
| No overlap | Slots within a day cannot overlap | ["06:00-12:00", "13:00-17:00"] OK |
| Sorted order | Slots should be in chronological order | Automatic sorting on set |
| Midnight handling | End time "24:00" allowed for end-of-day | "22:00-24:00" |

### Overlap Detection Algorithm

```
For each pair of slots (A, B) in the same day:
  Overlap exists if: A.start < B.end AND B.start < A.end
```

---

## API Design

### PUT /api/v1/stations/{id}/schedule

Update the operating schedule for a station.

**Request:**
```json
{
  "operatingSchedule": {
    "monday": {
      "isOperating": true,
      "slots": [
        {"start": "06:00", "end": "12:00"},
        {"start": "13:00", "end": "17:00"}
      ]
    },
    "tuesday": {
      "isOperating": true,
      "slots": [
        {"start": "06:00", "end": "12:00"},
        {"start": "13:00", "end": "17:00"}
      ]
    },
    "wednesday": {
      "isOperating": true,
      "slots": [
        {"start": "06:00", "end": "12:00"},
        {"start": "13:00", "end": "17:00"}
      ]
    },
    "thursday": {
      "isOperating": true,
      "slots": [
        {"start": "06:00", "end": "12:00"},
        {"start": "13:00", "end": "17:00"}
      ]
    },
    "friday": {
      "isOperating": true,
      "slots": [
        {"start": "06:00", "end": "12:00"},
        {"start": "13:00", "end": "17:00"}
      ]
    },
    "saturday": {
      "isOperating": false,
      "slots": []
    },
    "sunday": {
      "isOperating": false,
      "slots": []
    }
  }
}
```

**Response (200):**
```json
{
  "id": "station-123",
  "name": "Komori G37",
  "categoryId": "cat-offset",
  "groupId": "grp-offset",
  "capacity": 1,
  "status": "Available",
  "operatingSchedule": {
    "monday": {...},
    "tuesday": {...},
    ...
  }
}
```

**Error Response (400) - Overlap:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Time slots overlap",
    "details": {
      "day": "monday",
      "slots": [
        {"start": "06:00", "end": "14:00"},
        {"start": "12:00", "end": "17:00"}
      ]
    }
  }
}
```

**Error Response (400) - Invalid Time:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid time format",
    "details": {
      "field": "monday.slots[0].start",
      "value": "6:00",
      "expected": "HH:MM format (e.g., 06:00)"
    }
  }
}
```

---

## Value Object Design

### TimeSlot

```php
namespace App\ValueObject;

final readonly class TimeSlot implements \JsonSerializable
{
    public function __construct(
        public string $start,
        public string $end,
    ) {
        $this->validateFormat($start, 'start');
        $this->validateFormat($end, 'end');
        $this->validateOrder();
    }

    public function overlaps(TimeSlot $other): bool
    {
        return $this->start < $other->end && $other->start < $this->end;
    }

    public function jsonSerialize(): array
    {
        return ['start' => $this->start, 'end' => $this->end];
    }

    public static function fromArray(array $data): self
    {
        return new self($data['start'], $data['end']);
    }

    private function validateFormat(string $time, string $field): void
    {
        if (!preg_match('/^([01]\d|2[0-4]):([0-5]\d)$/', $time)) {
            throw new \InvalidArgumentException(
                "Invalid time format for {$field}: {$time}. Expected HH:MM."
            );
        }
    }

    private function validateOrder(): void
    {
        if ($this->start >= $this->end && $this->end !== '24:00') {
            throw new \InvalidArgumentException(
                "Start time ({$this->start}) must be before end time ({$this->end})."
            );
        }
    }
}
```

### DaySchedule

```php
namespace App\ValueObject;

final readonly class DaySchedule implements \JsonSerializable
{
    /** @var TimeSlot[] */
    public array $slots;

    /**
     * @param TimeSlot[] $slots
     */
    public function __construct(
        public bool $isOperating,
        array $slots = [],
    ) {
        // Sort slots by start time
        usort($slots, fn(TimeSlot $a, TimeSlot $b) => $a->start <=> $b->start);

        $this->validateNoOverlap($slots);
        $this->slots = $slots;
    }

    public function jsonSerialize(): array
    {
        return [
            'isOperating' => $this->isOperating,
            'slots' => array_map(fn(TimeSlot $s) => $s->jsonSerialize(), $this->slots),
        ];
    }

    public static function fromArray(array $data): self
    {
        $slots = array_map(
            fn(array $s) => TimeSlot::fromArray($s),
            $data['slots'] ?? []
        );
        return new self($data['isOperating'], $slots);
    }

    public static function nonOperating(): self
    {
        return new self(false, []);
    }

    /**
     * @param TimeSlot[] $slots
     */
    private function validateNoOverlap(array $slots): void
    {
        for ($i = 0; $i < count($slots) - 1; $i++) {
            if ($slots[$i]->overlaps($slots[$i + 1])) {
                throw new \InvalidArgumentException(
                    "Time slots overlap: {$slots[$i]->start}-{$slots[$i]->end} " .
                    "and {$slots[$i + 1]->start}-{$slots[$i + 1]->end}"
                );
            }
        }
    }
}
```

### OperatingSchedule

```php
namespace App\ValueObject;

final readonly class OperatingSchedule implements \JsonSerializable
{
    public function __construct(
        public DaySchedule $monday,
        public DaySchedule $tuesday,
        public DaySchedule $wednesday,
        public DaySchedule $thursday,
        public DaySchedule $friday,
        public DaySchedule $saturday,
        public DaySchedule $sunday,
    ) {}

    public function jsonSerialize(): array
    {
        return [
            'monday' => $this->monday->jsonSerialize(),
            'tuesday' => $this->tuesday->jsonSerialize(),
            'wednesday' => $this->wednesday->jsonSerialize(),
            'thursday' => $this->thursday->jsonSerialize(),
            'friday' => $this->friday->jsonSerialize(),
            'saturday' => $this->saturday->jsonSerialize(),
            'sunday' => $this->sunday->jsonSerialize(),
        ];
    }

    public static function fromArray(array $data): self
    {
        return new self(
            DaySchedule::fromArray($data['monday']),
            DaySchedule::fromArray($data['tuesday']),
            DaySchedule::fromArray($data['wednesday']),
            DaySchedule::fromArray($data['thursday']),
            DaySchedule::fromArray($data['friday']),
            DaySchedule::fromArray($data['saturday']),
            DaySchedule::fromArray($data['sunday']),
        );
    }

    public function getForDay(string $dayName): DaySchedule
    {
        return match (strtolower($dayName)) {
            'monday' => $this->monday,
            'tuesday' => $this->tuesday,
            'wednesday' => $this->wednesday,
            'thursday' => $this->thursday,
            'friday' => $this->friday,
            'saturday' => $this->saturday,
            'sunday' => $this->sunday,
            default => throw new \InvalidArgumentException("Invalid day: {$dayName}"),
        };
    }

    /**
     * Get schedule for a specific date.
     */
    public function getForDate(\DateTimeInterface $date): DaySchedule
    {
        $dayName = strtolower($date->format('l'));
        return $this->getForDay($dayName);
    }

    /**
     * Create default Mon-Fri 06:00-12:00, 13:00-17:00 schedule.
     */
    public static function defaultWeekday(): self
    {
        $workDay = new DaySchedule(true, [
            new TimeSlot('06:00', '12:00'),
            new TimeSlot('13:00', '17:00'),
        ]);
        $weekend = DaySchedule::nonOperating();

        return new self(
            monday: $workDay,
            tuesday: $workDay,
            wednesday: $workDay,
            thursday: $workDay,
            friday: $workDay,
            saturday: $weekend,
            sunday: $weekend,
        );
    }

    /**
     * Create extended hours schedule (05:00-21:00 Mon-Fri, Sat morning).
     */
    public static function extended(): self
    {
        $workDay = new DaySchedule(true, [
            new TimeSlot('05:00', '21:00'),
        ]);
        $saturday = new DaySchedule(true, [
            new TimeSlot('06:00', '12:00'),
        ]);
        $sunday = DaySchedule::nonOperating();

        return new self(
            monday: $workDay,
            tuesday: $workDay,
            wednesday: $workDay,
            thursday: $workDay,
            friday: $workDay,
            saturday: $saturday,
            sunday: $sunday,
        );
    }
}
```

---

## File Structure

```
services/php-api/
├── src/
│   ├── ValueObject/
│   │   ├── TimeSlot.php              # Time slot value object
│   │   ├── DaySchedule.php           # Day schedule value object
│   │   └── OperatingSchedule.php     # Weekly schedule value object
│   ├── DTO/
│   │   └── Station/
│   │       └── UpdateScheduleRequest.php  # Request DTO
│   ├── Controller/
│   │   └── Api/V1/
│   │       └── StationController.php # Add updateSchedule action
│   ├── Entity/
│   │   └── Station.php               # Update setOperatingSchedule()
│   └── Service/
│       └── StationService.php        # Add updateSchedule method
└── tests/
    ├── Unit/
    │   └── ValueObject/
    │       ├── TimeSlotTest.php
    │       ├── DayScheduleTest.php
    │       └── OperatingScheduleTest.php
    └── Integration/
        └── Controller/Api/V1/
            └── StationScheduleTest.php
```

---

## Feature Checklist

### Value Objects

- [x] **Create TimeSlot value object**
  - File: `src/ValueObject/TimeSlot.php`
  - Validation: HH:MM format, start < end
  - Method: `overlaps(TimeSlot $other): bool`
  - Tests: `tests/Unit/ValueObject/TimeSlotTest.php` (23 tests)

- [x] **Create DaySchedule value object**
  - File: `src/ValueObject/DaySchedule.php`
  - Validation: No overlapping slots (BR-STATION-005)
  - Method: `nonOperating()`, `standardWorkday()` factories
  - Tests: `tests/Unit/ValueObject/DayScheduleTest.php` (16 tests)

- [x] **Create OperatingSchedule value object**
  - File: `src/ValueObject/OperatingSchedule.php`
  - Methods: `getForDay()`, `getForDate()`, `defaultWeekday()`, `extended()`, `twentyFourSeven()`
  - Tests: `tests/Unit/ValueObject/OperatingScheduleTest.php` (27 tests)

### DTO Layer

- [x] **Create UpdateScheduleRequest DTO**
  - File: `src/DTO/Station/UpdateScheduleRequest.php`
  - Validation: Required fields, nested validation

### Service Layer

- [x] **Add StationService::updateSchedule()**
  - File: `src/Service/StationService.php`
  - Logic: Convert DTO to value object, persist

### Controller Layer

- [x] **Add StationController::updateSchedule()**
  - File: `src/Controller/Api/V1/StationController.php`
  - Route: `PUT /api/v1/stations/{id}/schedule`
  - OpenAPI documentation with DaySchedule and TimeSlot schemas

### Entity Update

- [x] **Update Station::setOperatingSchedule()**
  - File: `src/Entity/Station.php`
  - Accept: `OperatingSchedule` value object array
  - Convert to JSON for storage

### Testing

- [x] **Unit tests for value objects** (66 tests total)
  - TimeSlot: Format validation, overlap detection
  - DaySchedule: Overlap validation, sorting
  - OperatingSchedule: Day access, factory methods

- [x] **Integration tests for API** (10 tests)
  - Update schedule success
  - Validation errors (overlap, invalid format)
  - Station not found
  - Extended hours and 24/7 schedules

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `TimeSlotTest` | Valid HH:MM format accepted |
| | Invalid format rejected (e.g., "6:00", "25:00") |
| | Start time must be before end time |
| | "24:00" allowed as end time |
| | `overlaps()` detects overlapping slots |
| | `overlaps()` returns false for non-overlapping |
| `DayScheduleTest` | Valid slots accepted |
| | Overlapping slots rejected |
| | Slots are sorted by start time |
| | Empty slots allowed when not operating |
| | `nonOperating()` creates correct instance |
| `OperatingScheduleTest` | All seven days required |
| | `getForDay()` returns correct day |
| | `getForDate()` returns correct day for date |
| | `defaultWeekday()` creates Mon-Fri schedule |
| | `extended()` creates extended hours schedule |
| | JSON serialization/deserialization |

### Integration Tests

| Test Class | Test Cases |
|------------|------------|
| `StationScheduleTest` | Update schedule success (200) |
| | Returns updated station with schedule |
| | Validation error - overlapping slots (400) |
| | Validation error - invalid time format (400) |
| | Station not found (404) |
| | Partial update preserves other fields |

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (142 tests, 340 assertions)
- [x] All integration tests passing
- [x] OpenAPI documentation updated
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 8)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.2`

---

## Technical Notes

### JSON Storage

The `operating_schedule` column stores the schedule as JSON. The value object handles serialization:

```php
// Entity stores array from JSON column
$this->operatingSchedule = $schedule->jsonSerialize();

// Reading back
if ($this->operatingSchedule !== null) {
    return OperatingSchedule::fromArray($this->operatingSchedule);
}
```

### Time Format Validation

Use regex for HH:MM validation:
```php
// Matches 00:00 to 24:00
preg_match('/^([01]\d|2[0-4]):([0-5]\d)$/', $time)
```

### Overlap Detection

Adjacent slots (end of one = start of next) are NOT considered overlapping:
- `["06:00-12:00", "12:00-17:00"]` - OK (contiguous)
- `["06:00-12:30", "12:00-17:00"]` - Overlap (30 min)

### Null Schedule Handling

Until a schedule is set, `operatingSchedule` is null. The system should:
- Allow station creation without schedule
- Require schedule before task assignment (enforced in v0.2.x)

---

## Release Notes Draft

```markdown
## v0.1.2 – Operating Schedule

**Release Date:** 2025-12-12

### Summary

Adds operating schedule management for stations. Stations can now have
weekly operating patterns defined, specifying when they are available
for task assignments.

### What's New

- **TimeSlot value object** - Represents a time range (HH:MM format)
- **DaySchedule value object** - Day configuration with time slots
- **OperatingSchedule value object** - Full weekly pattern (Mon-Sun)
- **PUT /api/v1/stations/{id}/schedule** - Endpoint to update schedule
- **Overlap validation** - Prevents overlapping time slots (BR-STATION-005)
- **Default schedules** - Factory methods for common patterns
- **Unit tests** - Comprehensive value object tests
- **Integration tests** - API endpoint tests

### API Changes

New endpoint:
- `PUT /api/v1/stations/{id}/schedule` - Update station operating schedule

### Breaking Changes

None

### Migration Guide

No migration required. The `operating_schedule` column already exists from v0.1.0.
```

---

## Post-Release

- [x] Verify API documentation updated
- [ ] Test schedule update via curl/Postman
- [ ] Update mock data generators to use OperatingSchedule
- [ ] Proceed to v0.1.3 (Schedule Exceptions)

---

## Appendix: Common Schedule Patterns

### Standard Weekday (Mon-Fri, with lunch break)

```json
{
  "isOperating": true,
  "slots": [
    {"start": "06:00", "end": "12:00"},
    {"start": "13:00", "end": "17:00"}
  ]
}
```

### Extended Hours (single shift)

```json
{
  "isOperating": true,
  "slots": [
    {"start": "05:00", "end": "21:00"}
  ]
}
```

### Saturday Morning Only

```json
{
  "isOperating": true,
  "slots": [
    {"start": "06:00", "end": "12:00"}
  ]
}
```

### Non-Operating Day

```json
{
  "isOperating": false,
  "slots": []
}
```

### 24-Hour Operation

```json
{
  "isOperating": true,
  "slots": [
    {"start": "00:00", "end": "24:00"}
  ]
}
```
