# Release v0.3.15 – Tile Swap

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-16
>
> **Git Tag:** `v0.3.15`

---

## Overview

This release implements tile swap functionality, allowing users to quickly reorder adjacent tiles on the same station without dragging. Clicking the swap up/down buttons on a tile exchanges its position with the adjacent tile above or below.

---

## Prerequisites

- [x] v0.3.14 - Drop Handling released
- [x] SwapButtons component exists (hover buttons)
- [x] Tile component has onSwapUp/onSwapDown props
- [x] SchedulingGrid passes swap callbacks

---

## Scope

### In Scope

- **Swap utility function** - Exchange positions of two adjacent tiles
- **Wire up callbacks** - Connect App.tsx to swap operations
- **Snapshot update** - Modify assignments to swap scheduledStart/scheduledEnd
- **Visual feedback** - Tiles update immediately (optimistic)
- **Edge case handling** - First/last tile only shows relevant button

### Out of Scope

- Swap validation (deferred - currently no validation on swap)
- Swap animation with transitions (MVP: instant swap)
- Swap across stations (tiles must be on same station)
- Undo functionality

---

## Related Documentation

### UX/UI Specification

| Document | Sections |
|----------|----------|
| [Tile Swap](../ux-ui/01-interaction-patterns/tile-swap.md) | Activation, Behavior, Edge Cases |
| [Tile Component](../ux-ui/05-components/tile-component.md) | Swap button placement |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-ASSIGN-* (scheduling constraints) |

---

## Technical Notes

### Swap Logic

Given two adjacent assignments A and B on the same station:
1. Find both assignments in the snapshot
2. Exchange their `scheduledStart` and `scheduledEnd` values
3. Update snapshot with modified assignments

```typescript
// Swap two adjacent assignments
function applySwap(
  assignments: TaskAssignment[],
  assignmentId: string,
  direction: 'up' | 'down'
): SwapResult {
  // Find adjacent assignment based on direction
  const adjacent = findAdjacentAssignment(assignments, assignmentId, direction);
  if (!adjacent) return { assignments, swapped: false, swappedWithId: null };

  // Calculate new times preserving durations
  // The tile moving "up" takes the earlier start time
  // The tile moving "down" starts after the one above ends
  // ...
}
```

### Finding Adjacent Tiles

Adjacent means same station, consecutive in time order:
1. Filter assignments by station
2. Sort by scheduledStart
3. Find index of target assignment
4. Get assignment at index ± 1

---

## Feature Checklist

### Swap Utility

- [x] **Create swap utility function**
  - Description: `applySwap(assignments, assignmentId, direction)` function
  - Files: `apps/web/src/utils/swap.ts`

- [x] **Find adjacent assignment helper**
  - Description: Get assignment above/below target on same station
  - Files: `apps/web/src/utils/swap.ts`

### App Integration

- [x] **Add handleSwapUp callback**
  - Description: Handle swap up button click
  - Files: `apps/web/src/App.tsx`

- [x] **Add handleSwapDown callback**
  - Description: Handle swap down button click
  - Files: `apps/web/src/App.tsx`

- [x] **Pass callbacks to SchedulingGrid**
  - Description: Wire onSwapUp/onSwapDown props
  - Files: `apps/web/src/App.tsx`

### Optimistic Update

- [x] **Update snapshot on swap**
  - Description: Use updateSnapshot to apply swap
  - Files: `apps/web/src/App.tsx`

- [x] **Trigger re-render**
  - Description: Increment snapshotVersion
  - Files: `apps/web/src/App.tsx`

---

## Testing Requirements

### Unit Tests

- [x] Swap correctly exchanges positions
- [x] Swap up with first tile returns unchanged
- [x] Swap down with last tile returns unchanged
- [x] Swap preserves other assignments
- [x] Duration is preserved after swap

### Integration Tests

- [x] Click swap up moves tile up visually (via callback wiring)
- [x] Click swap down moves tile down visually (via callback wiring)
- [x] Swap buttons hidden appropriately (first/last tile)

### Manual Testing

- [ ] Swap up on middle tile works
- [ ] Swap down on middle tile works
- [ ] First tile only shows swap down
- [ ] Last tile only shows swap up
- [ ] Rapid swaps work correctly

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (414 tests)
- [x] TypeScript compiles without errors
- [x] Lint passes
- [x] Documentation updated
- [x] Merged to ux-ui-development branch

---

## Release Notes Draft

```markdown
## v0.3.15 – Tile Swap

**Release Date:** 2025-12-16

### Summary

Tile swap functionality for quick reordering of adjacent tiles. Click the up/down arrows on a tile to swap its position with the tile above or below.

### What's New

- Swap up button exchanges tile with one above
- Swap down button exchanges tile with one below
- Instant optimistic UI update
- Edge case handling (first/last tile)

### Technical

- applySwap utility function with duration preservation
- findAdjacentAssignment helper
- Snapshot update with swapped assignments
```

---

## File Structure

```
apps/web/src/
├── App.tsx                              # Swap handlers, callback wiring
├── utils/
│   ├── swap.ts                          # NEW: Swap utility function
│   ├── swap.test.ts                     # NEW: Unit tests (16 tests)
│   └── index.ts                         # Export swap
├── components/
│   ├── Tile/
│   │   ├── Tile.tsx                     # (exists) Has onSwapUp/onSwapDown props
│   │   └── SwapButtons.tsx              # (exists) UI buttons
│   └── SchedulingGrid/
│       └── SchedulingGrid.tsx           # (exists) Passes swap callbacks
```
