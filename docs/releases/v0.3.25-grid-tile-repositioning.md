# Release v0.3.25 â€“ Grid Tile Repositioning

> **Status:** ğŸ”´ Not Started
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** TBD
>
> **Git Tag:** `v0.3.25`

---

## Overview

Enable drag-and-drop repositioning of scheduled tiles on the grid. Users can drag a tile up or down within its station column to change the scheduled time. The tile stays on the same station â€” only the time changes.

---

## Prerequisites

- [x] v0.3.20 - Tile-Based Drop Position (grab offset calculation)
- [x] Drag-drop infrastructure (v0.3.11)
- [x] Drop handling with push-down (v0.3.14)
- [x] Real-time validation during drag (v0.3.13)

---

## Scope

### In Scope

- **Drag scheduled tiles** within the same station column
- **Reschedule** to new time position on drop
- **Push-down behavior** when dropping onto/between other tiles
- **Precedence validation** during drag (real-time feedback)
- **Alt-key bypass** for precedence (same as new placements)

### Out of Scope

- Cross-station drag (changing station) â€” task is bound to station
- Multi-tile drag (select and move multiple)
- Drag to left panel (use recall instead)

---

## Related Documentation

### UX/UI Specification

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Grid tile drag |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-003 (Precedence) |

---

## Technical Notes

### Drag Behavior

1. **Drag start:** User grabs a scheduled tile on the grid
2. **During drag:**
   - Tile follows cursor (with grab offset from v0.3.20)
   - Original position shows ghost/placeholder
   - Real-time validation shows valid/invalid drop zones
   - Other tiles on same station are non-interactive (pointer-events: none)
3. **Drop:**
   - Calculate new `scheduledStart` from drop position
   - Apply push-down if overlapping with other tiles
   - Update assignment via API

### Constraints

| Constraint | Behavior |
|------------|----------|
| Same station only | Tile cannot leave its column |
| Precedence | Auto-snap to valid position (or Alt bypass) |
| No past scheduling | Cannot drop before current time |
| 30-min snap | Snaps to nearest 30-minute boundary |

### Visual Feedback During Drag

```
Original position:        During drag:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œ â”€ â”€ â”€ â”€ â”  â† Ghost (dashed outline)
â”‚  Tile   â”‚               â”‚  ghost  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”” â”€ â”€ â”€ â”€ â”˜

                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† Dragged tile at cursor
                          â”‚  Tile   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Integration

On drop, call reschedule mutation:

```typescript
// Mutation to update assignment
rescheduleAssignment({
  assignmentId: assignment.id,
  newScheduledStart: calculatedDropTime,
});
```

Backend recalculates `scheduledEnd` using EndTimeCalculator.

---

## Feature Checklist

### Tile Component

- [ ] **Make scheduled tiles draggable**
  - Description: Enable drag on tiles rendered in grid
  - Files: `apps/web/src/components/Tile/Tile.tsx`

- [ ] **Drag start handler**
  - Description: Record grab offset, set drag data
  - Files: `apps/web/src/components/Tile/Tile.tsx`

- [ ] **Ghost placeholder**
  - Description: Show dashed outline at original position during drag
  - Files: `apps/web/src/components/Tile/Tile.tsx`

### Station Column

- [ ] **Accept drops from grid tiles**
  - Description: Handle drop of existing tiles (not just from sidebar)
  - Files: `apps/web/src/components/SchedulingGrid/StationColumn.tsx`

- [ ] **Distinguish reschedule vs new placement**
  - Description: Detect if dropped tile is existing assignment or new
  - Files: `apps/web/src/components/SchedulingGrid/StationColumn.tsx`

### Drop Handling

- [ ] **Reschedule on drop**
  - Description: Update scheduledStart for existing assignment
  - Files: `apps/web/src/App.tsx`

- [ ] **Push-down integration**
  - Description: Apply push-down logic for repositioned tiles
  - Files: `apps/web/src/utils/pushDown.ts`

### Validation

- [ ] **Real-time precedence check during drag**
  - Description: Show valid/invalid zones while dragging
  - Files: `apps/web/src/components/SchedulingGrid/StationColumn.tsx`

---

## Testing Requirements

### Unit Tests

- [ ] Drag data includes assignment ID for existing tiles
- [ ] Drop handler distinguishes new vs reschedule
- [ ] Push-down works for repositioned tiles
- [ ] Grab offset is applied correctly

### E2E Tests

Location: `apps/web/cypress/e2e/grid-tile-repositioning.cy.ts`

- [ ] Can drag scheduled tile up/down within column
- [ ] Tile snaps to 30-minute boundaries on drop
- [ ] Ghost placeholder visible during drag
- [ ] Push-down works when dropping onto other tiles
- [ ] Tile position updates after drop
- [ ] Cannot drag tile outside its station column

### Manual Testing

- [ ] Can drag scheduled tile up/down within column
- [ ] Tile snaps to 30-minute boundaries
- [ ] Ghost shows at original position during drag
- [ ] Push-down works when dropping onto other tiles
- [ ] Precedence validation shows during drag
- [ ] Alt-key bypasses precedence safeguard
- [ ] Cannot drag tile to another column
- [ ] Cannot drag tile to past time

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [ ] All feature checklist items completed
- [ ] All unit tests passing
- [ ] All E2E tests passing
- [ ] TypeScript compiles without errors
- [ ] Lint passes
- [ ] Documentation updated
- [ ] Merged to ux-ui-development branch

---

## Release Notes Draft

```markdown
## v0.3.25 â€“ Grid Tile Repositioning

**Release Date:** TBD

### Summary

Drag-and-drop repositioning for scheduled tiles. Drag any tile up or down within its station column to reschedule it to a different time.

### What's New

- Drag scheduled tiles to reposition within station column
- Ghost placeholder shows original position during drag
- Push-down behavior when dropping onto other tiles
- Real-time precedence validation during drag

### Technical

- Reuses tile-based drop position calculation
- Integrates with existing push-down logic
- Reschedule mutation updates backend
```

---

## File Structure

```
apps/web/src/
â”œâ”€â”€ App.tsx                              # Reschedule handler
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ pushDown.ts                      # Push-down for repositioned tiles
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Tile/
â”‚   â”‚   â””â”€â”€ Tile.tsx                     # Draggable, ghost placeholder
â”‚   â””â”€â”€ SchedulingGrid/
â”‚       â””â”€â”€ StationColumn.tsx            # Drop handler for grid tiles
```
