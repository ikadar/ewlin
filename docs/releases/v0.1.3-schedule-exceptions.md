# Release v0.1.3 – Schedule Exceptions

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Release Date:** 2025-12-12
>
> **Git Tag:** `v0.1.3`

---

## Overview

This release implements **Schedule Exceptions** for stations. Schedule exceptions allow overriding the regular weekly operating schedule for specific dates (holidays, maintenance days, special operating hours).

### Why This Matters

- **Holiday handling**: Stations can be marked as closed on specific holidays
- **Maintenance windows**: Schedule planned maintenance without changing the weekly pattern
- **Special hours**: Override operating hours for specific dates (e.g., extended hours before deadlines)
- **Flexibility**: Real-world scheduling requires exception handling beyond weekly patterns

---

## Prerequisites

- [x] `v0.1.2` released (Operating Schedule with TimeSlot, DaySchedule, OperatingSchedule value objects)
- [x] Station entity has `schedule_exceptions` JSON column ready

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| ScheduleException value object | Date-specific schedule override |
| ExceptionType enum | CLOSED, MODIFIED (different handling) |
| Station::addScheduleException() | Domain method to add exception |
| Station::removeScheduleException() | Domain method to remove exception |
| POST /api/v1/stations/{id}/exceptions | Add schedule exception |
| GET /api/v1/stations/{id}/exceptions | List schedule exceptions |
| DELETE /api/v1/stations/{id}/exceptions/{date} | Remove schedule exception |
| Exception override logic | getEffectiveSchedule(date) method |
| Unit tests | Value object and logic tests |
| Integration tests | API endpoint tests |

### Out of Scope

| Item | Reason |
|------|--------|
| Bulk exception import | Future enhancement |
| Recurring exceptions (every year) | Post-MVP |
| Exception templates | Post-MVP |
| UI exception editor | Covered in M3 (Frontend) |

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-STATION-008 |

### API

| Document | Sections |
|----------|----------|
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 1: Station Management API |

---

## Domain Model Reference

### ScheduleException Structure

```
┌─────────────────────────────────────────────────────────────┐
│                   ScheduleException                          │
├─────────────────────────────────────────────────────────────┤
│  date: string (YYYY-MM-DD)                                  │
│  type: ExceptionType (CLOSED | MODIFIED)                    │
│  schedule: DaySchedule|null (only for MODIFIED)             │
│  reason: string|null (optional description)                 │
└─────────────────────────────────────────────────────────────┘
```

### Exception Types

| Type | Description | schedule field |
|------|-------------|----------------|
| **CLOSED** | Station is completely closed | null (ignored) |
| **MODIFIED** | Station has different hours | DaySchedule required |

### Example Exceptions

```json
[
  {
    "date": "2025-12-25",
    "type": "CLOSED",
    "schedule": null,
    "reason": "Christmas Day"
  },
  {
    "date": "2025-12-24",
    "type": "MODIFIED",
    "schedule": {
      "isOperating": true,
      "slots": [
        {"start": "06:00", "end": "12:00"}
      ]
    },
    "reason": "Christmas Eve - morning only"
  }
]
```

---

## Business Rules

| Rule ID | Description | Enforcement |
|---------|-------------|-------------|
| **BR-STATION-008** | Schedule exceptions override regular schedule | getEffectiveSchedule() method |

### Exception Validation Rules

| Rule | Description |
|------|-------------|
| Valid date format | Date must be YYYY-MM-DD |
| Future or today | Cannot add exceptions for past dates (MVP: relaxed) |
| No duplicates | Only one exception per date per station |
| MODIFIED requires schedule | If type is MODIFIED, schedule must be provided |
| CLOSED ignores schedule | If type is CLOSED, schedule is set to null |

---

## API Design

### POST /api/v1/stations/{id}/exceptions

Add a schedule exception for a specific date.

**Request:**
```json
{
  "date": "2025-12-25",
  "type": "CLOSED",
  "reason": "Christmas Day"
}
```

**Request (MODIFIED):**
```json
{
  "date": "2025-12-24",
  "type": "MODIFIED",
  "schedule": {
    "isOperating": true,
    "slots": [
      {"start": "06:00", "end": "12:00"}
    ]
  },
  "reason": "Christmas Eve - morning only"
}
```

**Response (201):**
```json
{
  "date": "2025-12-25",
  "type": "CLOSED",
  "schedule": null,
  "reason": "Christmas Day"
}
```

**Error Response (400) - Duplicate:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Exception already exists for date",
    "details": {
      "date": "2025-12-25"
    }
  }
}
```

**Error Response (400) - Missing schedule for MODIFIED:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Schedule is required for MODIFIED exception type"
  }
}
```

### GET /api/v1/stations/{id}/exceptions

List all schedule exceptions for a station.

**Query Parameters:**
- `from` (optional): Start date filter (YYYY-MM-DD)
- `to` (optional): End date filter (YYYY-MM-DD)

**Response (200):**
```json
{
  "data": [
    {
      "date": "2025-12-24",
      "type": "MODIFIED",
      "schedule": {
        "isOperating": true,
        "slots": [{"start": "06:00", "end": "12:00"}]
      },
      "reason": "Christmas Eve - morning only"
    },
    {
      "date": "2025-12-25",
      "type": "CLOSED",
      "schedule": null,
      "reason": "Christmas Day"
    }
  ],
  "total": 2
}
```

### DELETE /api/v1/stations/{id}/exceptions/{date}

Remove a schedule exception.

**Response (204):** No content

**Error Response (404):**
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Exception not found for date",
    "details": {
      "date": "2025-12-25"
    }
  }
}
```

---

## Value Object Design

### ExceptionType Enum

```php
namespace App\Enum;

enum ExceptionType: string
{
    case CLOSED = 'CLOSED';
    case MODIFIED = 'MODIFIED';
}
```

### ScheduleException

```php
namespace App\ValueObject;

use App\Enum\ExceptionType;

final readonly class ScheduleException implements \JsonSerializable
{
    public function __construct(
        public string $date,
        public ExceptionType $type,
        public ?DaySchedule $schedule = null,
        public ?string $reason = null,
    ) {
        $this->validateDate($date);
        $this->validateScheduleForType();
    }

    public function jsonSerialize(): array
    {
        return [
            'date' => $this->date,
            'type' => $this->type->value,
            'schedule' => $this->schedule?->jsonSerialize(),
            'reason' => $this->reason,
        ];
    }

    public static function fromArray(array $data): self
    {
        $schedule = isset($data['schedule'])
            ? DaySchedule::fromArray($data['schedule'])
            : null;

        return new self(
            date: $data['date'],
            type: ExceptionType::from($data['type']),
            schedule: $schedule,
            reason: $data['reason'] ?? null,
        );
    }

    public static function closed(string $date, ?string $reason = null): self
    {
        return new self(
            date: $date,
            type: ExceptionType::CLOSED,
            schedule: null,
            reason: $reason,
        );
    }

    public static function modified(
        string $date,
        DaySchedule $schedule,
        ?string $reason = null
    ): self {
        return new self(
            date: $date,
            type: ExceptionType::MODIFIED,
            schedule: $schedule,
            reason: $reason,
        );
    }

    public function getEffectiveDaySchedule(): DaySchedule
    {
        return match ($this->type) {
            ExceptionType::CLOSED => DaySchedule::nonOperating(),
            ExceptionType::MODIFIED => $this->schedule ?? DaySchedule::nonOperating(),
        };
    }

    private function validateDate(string $date): void
    {
        if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $date)) {
            throw new \InvalidArgumentException(
                "Invalid date format: {$date}. Expected YYYY-MM-DD."
            );
        }

        $parsed = \DateTimeImmutable::createFromFormat('Y-m-d', $date);
        if ($parsed === false || $parsed->format('Y-m-d') !== $date) {
            throw new \InvalidArgumentException(
                "Invalid date: {$date}."
            );
        }
    }

    private function validateScheduleForType(): void
    {
        if ($this->type === ExceptionType::MODIFIED && $this->schedule === null) {
            throw new \InvalidArgumentException(
                'Schedule is required for MODIFIED exception type.'
            );
        }
    }
}
```

---

## File Structure

```
services/php-api/
├── src/
│   ├── Enum/
│   │   └── ExceptionType.php             # Exception type enum
│   ├── ValueObject/
│   │   └── ScheduleException.php         # Schedule exception value object
│   ├── DTO/
│   │   └── Station/
│   │       └── AddExceptionRequest.php   # Request DTO
│   ├── Controller/
│   │   └── Api/V1/
│   │       └── StationExceptionController.php  # Exception endpoints
│   ├── Entity/
│   │   └── Station.php                   # Add exception methods
│   └── Service/
│       └── StationService.php            # Add exception methods
└── tests/
    ├── Unit/
    │   ├── Enum/
    │   │   └── ExceptionTypeTest.php
    │   └── ValueObject/
    │       └── ScheduleExceptionTest.php
    └── Integration/
        └── Controller/Api/V1/
            └── StationExceptionControllerTest.php
```

---

## Database Changes

Add `schedule_exceptions` JSON column to stations table:

```sql
ALTER TABLE stations ADD COLUMN schedule_exceptions JSON DEFAULT NULL;
```

Migration file: `migrations/Version20251212XXXXXX.php`

---

## Feature Checklist

### Enum

- [x] **Create ExceptionType enum**
  - File: `src/Enum/ExceptionType.php`
  - Values: CLOSED, MODIFIED
  - Tests: `tests/Unit/Enum/ExceptionTypeTest.php` (7 tests)

### Value Objects

- [x] **Create ScheduleException value object**
  - File: `src/ValueObject/ScheduleException.php`
  - Validation: Date format, type/schedule consistency
  - Methods: `closed()`, `modified()`, `getEffectiveDaySchedule()`
  - Tests: `tests/Unit/ValueObject/ScheduleExceptionTest.php` (25 tests)

### Entity Update

- [x] **Add schedule exceptions to Station entity**
  - File: `src/Entity/Station.php`
  - New column: `schedule_exceptions` (JSON)
  - Methods: `getScheduleExceptions()`, `addScheduleException()`, `removeScheduleException()`, `getEffectiveScheduleForDate()`

### Database Migration

- [x] **Create migration for schedule_exceptions column**
  - File: `migrations/Version20251212100000.php`

### DTO Layer

- [x] **Create AddExceptionRequest DTO**
  - File: `src/DTO/Station/AddExceptionRequest.php`
  - Validation: Required fields, nested validation

### Service Layer

- [x] **Add StationService exception methods**
  - File: `src/Service/StationService.php`
  - Methods: `addException()`, `removeException()`, `getExceptions()`

### Controller Layer

- [x] **Create StationExceptionController**
  - File: `src/Controller/Api/V1/StationExceptionController.php`
  - Routes:
    - `POST /api/v1/stations/{id}/exceptions`
    - `GET /api/v1/stations/{id}/exceptions`
    - `DELETE /api/v1/stations/{id}/exceptions/{date}`
  - OpenAPI documentation

### Testing

- [x] **Unit tests for value objects**
  - ExceptionType enum tests (7 tests)
  - ScheduleException: Date validation, type/schedule validation, factory methods (25 tests)

- [x] **Integration tests for API** (24 tests)
  - Add exception (CLOSED)
  - Add exception (MODIFIED)
  - List exceptions
  - List exceptions with date filter
  - Delete exception
  - Duplicate exception error
  - Invalid date format error
  - Station not found

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `ExceptionTypeTest` | All values can be instantiated |
| | from() works for valid values |
| | from() throws for invalid values |
| `ScheduleExceptionTest` | Valid CLOSED exception creation |
| | Valid MODIFIED exception creation |
| | Invalid date format rejected |
| | Invalid date rejected (e.g., 2025-02-30) |
| | MODIFIED without schedule throws |
| | CLOSED ignores schedule |
| | `closed()` factory method |
| | `modified()` factory method |
| | `getEffectiveDaySchedule()` returns correct schedule |
| | JSON serialization/deserialization |
| | `fromArray()` works correctly |

### Integration Tests

| Test Class | Test Cases |
|------------|------------|
| `StationExceptionControllerTest` | Add CLOSED exception (201) |
| | Add MODIFIED exception (201) |
| | Add duplicate exception (400) |
| | Add MODIFIED without schedule (400) |
| | Add exception with invalid date format (400) |
| | List exceptions (200) |
| | List exceptions with date filter (200) |
| | Delete exception (204) |
| | Delete non-existent exception (404) |
| | Station not found (404) |

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (198 tests, 509 assertions)
- [x] All integration tests passing
- [x] OpenAPI documentation updated
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 8)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.3`

---

## Release Notes Draft

```markdown
## v0.1.3 – Schedule Exceptions

**Release Date:** 2025-12-12

### Summary

Adds schedule exception management for stations. Stations can now have
date-specific overrides to their regular operating schedule for holidays,
maintenance windows, or special operating hours.

### What's New

- **ScheduleException value object** - Date-specific schedule override
- **ExceptionType enum** - CLOSED or MODIFIED exception types
- **POST /api/v1/stations/{id}/exceptions** - Add schedule exception
- **GET /api/v1/stations/{id}/exceptions** - List schedule exceptions
- **DELETE /api/v1/stations/{id}/exceptions/{date}** - Remove exception
- **getEffectiveScheduleForDate()** - Method to get actual schedule for any date
- **Unit tests** - Comprehensive value object tests
- **Integration tests** - API endpoint tests

### API Changes

New endpoints:
- `POST /api/v1/stations/{id}/exceptions` - Add schedule exception
- `GET /api/v1/stations/{id}/exceptions` - List schedule exceptions
- `DELETE /api/v1/stations/{id}/exceptions/{date}` - Remove schedule exception

### Breaking Changes

None

### Migration Guide

Run database migration to add `schedule_exceptions` column:
```bash
php bin/console doctrine:migrations:migrate
```
```

---

## Post-Release

- [x] GitHub release created with notes
- [x] Verify API documentation updated
- [ ] Test exception endpoints via curl/Postman
- [ ] Proceed to v0.1.4 (Station Category Entity)
