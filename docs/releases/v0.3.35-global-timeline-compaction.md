# Release v0.3.35 – Global Timeline Compaction

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-22
>
> **Git Tag:** `v0.3.35`
>
> **Branch:** `ux-ui-development`

---

## Overview

Add global timeline compaction feature that removes gaps between tasks across all stations within a specified time horizon. This provides a quick way to optimize the schedule by eliminating idle time.

---

## Prerequisites

- [x] `v0.3.34` released (Top Navigation Bar with zoom control)
- [x] Station compact already implemented (v0.3.22)

---

## Scope

### In Scope

- Segmented buttons in TopNavBar: `[4h] [8h] [24h]`
- Global `compactTimeline(horizon)` function
- Compaction starts from current time (`now`)
- Tasks in progress are immobile (cannot be moved)
- Respects precedence rules (no violations created)
- Processes all stations in order
- Mock implementation (local state update)

### Out of Scope

- Backend API integration (future task)
- "Compact All" option without time horizon
- Undoing compaction

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Refactored Requirements](../ux-ui/tmp/refactored-new-requirements-en.md) | REQ-10 |

### Existing Implementation

| Component | Description |
|-----------|-------------|
| `compactStationAssignments()` in App.tsx | Existing station compact logic |
| `TopNavBar` component | Navigation bar (v0.3.34) |
| Station compact button | Per-station compaction |

---

## Technical Notes

### Time Horizon Options

| Option | Duration | End Time |
|--------|----------|----------|
| 4h | 4 hours | `now + 4h` |
| 8h | 8 hours | `now + 8h` |
| 24h | 24 hours | `now + 24h` |

### Task Classification

| Type | Condition | Action |
|------|-----------|--------|
| **Immobile** | `scheduledStart < now` OR in progress | Cannot be moved |
| **Movable** | `scheduledStart >= now` AND within horizon | Can be compacted |
| **Out of range** | `scheduledStart > now + horizon` | Ignored |

### Compaction Algorithm

1. For each station (in display order):
   a. Get assignments within time horizon
   b. Sort by sequenceOrder (precedence)
   c. Calculate earliest possible start for each:
      - First task: `max(now, predecessorEnd)`
      - Subsequent: `max(prevTaskEnd, predecessorEnd)`
   d. Update assignments

### Precedence Handling

- Each task must start after its predecessor ends
- If predecessor is outside the station, check cross-station precedence
- Never create precedence violations

---

## Feature Checklist

### TopNavBar Updates

- [x] **Add compact buttons section**
  - Description: Segmented buttons [4h] [8h] [24h] between Quick Placement and Zoom
  - Files: `src/components/TopNavBar/TopNavBar.tsx`
  - Tests: `src/components/TopNavBar/TopNavBar.test.tsx`

- [x] **Add loading state indicator**
  - Description: Show loading spinner or disabled state during compaction
  - Files: `src/components/TopNavBar/TopNavBar.tsx`

### Compaction Logic

- [x] **Create compactTimeline utility function**
  - Description: Global compaction algorithm respecting precedence
  - Files: `src/utils/compactTimeline.ts`
  - Tests: `src/utils/compactTimeline.test.ts`

- [x] **Integrate with App.tsx**
  - Description: Wire up button click to compaction function
  - Files: `src/App.tsx`

### Props and State

- [x] **Add TopNavBar props**
  - Description: `onCompactTimeline`, `isCompacting` props
  - Files: `src/components/TopNavBar/TopNavBar.tsx`, `src/App.tsx`

---

## Testing Requirements

### Unit Tests

- [x] `compactTimeline()` correctly identifies movable vs immobile tasks
- [x] `compactTimeline()` respects precedence rules
- [x] `compactTimeline()` only processes tasks within horizon
- [x] `compactTimeline()` doesn't move tasks in progress
- [x] TopNavBar renders compact buttons
- [x] TopNavBar shows loading state during compaction
- [x] Compact buttons trigger correct horizon callback

### E2E Tests

- [x] Clicking 4h button removes gaps within 4-hour horizon
- [x] Compaction respects precedence (no violations created)
- [x] Loading state visible during compaction

### Manual Testing

- [ ] Compact 4h button visible and clickable
- [ ] Compact 8h button visible and clickable
- [ ] Compact 24h button visible and clickable
- [ ] Tasks in progress remain in place
- [ ] Gap removal works correctly
- [ ] Precedence maintained after compaction

---

## Manual QA Test Plan

### Test Fixtures

| Fixture | URL | Purpose |
|---------|-----|---------|
| `test` | `http://localhost:5173/?fixture=test` | General scheduling with gaps between tasks |

### Test Scenarios

#### Scenario 1: Verify Compact Buttons Visibility

**Fixture:** `test`

**Steps:**
1. Load the application
2. Look at the TopNavBar

**Expected Results:**
- [ ] "Compact:" label is visible
- [ ] 4h, 8h, 24h buttons are visible as segmented button group
- [ ] Buttons have correct styling (border, rounded corners)

#### Scenario 2: Verify 4h Compaction

**Fixture:** `test`

**Steps:**
1. Note the current task positions in the timeline
2. Click the "4h" compact button
3. Observe the loading state
4. Check task positions after compaction

**Expected Results:**
- [ ] Loading spinner appears briefly
- [ ] Gaps between tasks within 4-hour window are removed
- [ ] Tasks outside 4-hour window remain unchanged
- [ ] All tiles remain visible after compaction

#### Scenario 3: Verify 8h Compaction

**Fixture:** `test`

**Steps:**
1. Reset the page (refresh)
2. Click the "8h" compact button
3. Observe task positions

**Expected Results:**
- [ ] Compaction covers larger time range than 4h
- [ ] Tasks within 8-hour window are compacted
- [ ] No visual glitches or missing tiles

#### Scenario 4: Verify 24h Compaction

**Fixture:** `test`

**Steps:**
1. Reset the page (refresh)
2. Click the "24h" compact button
3. Observe task positions across all stations

**Expected Results:**
- [ ] All tasks within 24-hour window are compacted
- [ ] Multiple stations are processed
- [ ] Layout remains stable after compaction

#### Scenario 5: Verify Immobile Tasks

**Fixture:** `test`

**Steps:**
1. Find a task that has already started (scheduled start < now)
2. Note its position
3. Click any compact button
4. Check if the task moved

**Expected Results:**
- [ ] Tasks that have started remain in their original position
- [ ] Only future tasks are moved during compaction
- [ ] In-progress indicator (if any) is preserved

#### Scenario 6: Integration with Zoom

**Fixture:** `test`

**Steps:**
1. Perform compaction (click any compact button)
2. Use zoom in/out buttons
3. Verify zoom still works correctly

**Expected Results:**
- [ ] Zoom controls remain functional after compaction
- [ ] Zoom level updates correctly (50% → 200%)
- [ ] Task positions scale correctly with zoom

#### Scenario 7: Integration with Job Selection

**Fixture:** `test`

**Steps:**
1. Perform compaction
2. Click on a job card in the sidebar
3. Verify Quick Placement button becomes enabled

**Expected Results:**
- [ ] Job selection still works after compaction
- [ ] Selected job is highlighted
- [ ] Quick Placement button becomes enabled

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [ ] All feature checklist items completed
- [ ] All unit tests passing
- [ ] All E2E tests passing
- [ ] Manual testing completed
- [ ] Code reviewed and approved
- [ ] Documentation updated (roadmap)
- [ ] Git tag created: `v0.3.35`

---

## Release Notes Draft

```markdown
## v0.3.35 – Global Timeline Compaction

**Release Date:** 2025-12-22

### Summary

Add global timeline compaction to remove gaps between scheduled tasks across all stations within a selectable time horizon.

### What's New

- **Compact buttons in TopNavBar**: [4h] [8h] [24h] segmented buttons
- **Global compaction algorithm**: Removes gaps while respecting precedence rules
- **Time horizon selection**: Choose to compact next 4, 8, or 24 hours
- **Task protection**: Tasks in progress or already started cannot be moved

### Technical Details

- Compaction processes all stations in order
- Respects task precedence (no violations created)
- Tasks within the horizon are moved to eliminate gaps
- Visual loading state during compaction operation
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Roadmap updated
- [ ] Release document status updated
