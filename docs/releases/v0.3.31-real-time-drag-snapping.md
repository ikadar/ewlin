# Release v0.3.31 â€“ Real-Time Drag Snapping

> **Status:** ðŸš€ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-22
>
> **Git Tag:** `v0.3.31`
>
> **Implements:** [REQ-08/09](../ux-ui/additional-requirements/refactored-new-requirements-en.md#req-0809-snapping-drag-preview-with-vertical-constraint)

---

## Overview

This release implements real-time drag preview snapping to the 30-minute grid during drag operations. Previously, the drag preview followed the cursor freely and only snapped to the grid position on drop. Now the preview snaps to grid positions in real-time during the drag, providing immediate visual feedback of where the tile will land.

Additionally, this release verifies that vertical-only drag is working correctly (tiles cannot move between columns horizontally).

---

## Prerequisites

- [x] `v0.3.30` released (Job Deselection Methods)

---

## Scope

### In Scope

- **REQ-08:** Snap drag preview to 30-minute grid positions during drag (real-time)
- Modify `DragLayer.tsx` to use `snapToGrid()` for the preview position
- **REQ-09:** Verify vertical-only drag is working (already implemented)
- E2E tests for snapping behavior

### Out of Scope

- Horizontal position snapping (already fixed to column center)
- Zoom levels (separate feature in v0.3.33)
- Any backend changes

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Refactored Requirements](../ux-ui/additional-requirements/refactored-new-requirements-en.md) | REQ-08/09 |

### UX-UI

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Grid Snapping |

---

## Technical Notes

### Previous Behavior

The `DragLayer.tsx` component positioned the preview at the raw cursor position:

```typescript
// Previous (no snapping during drag)
const previewStyle: React.CSSProperties = {
  position: 'fixed',
  left: position.x - grabOffset.x,
  top: position.y - grabOffset.y,  // <-- No snap
  pointerEvents: 'none',
  zIndex: 9999,
};
```

### New Behavior

The preview now snaps to 30-minute grid positions during drag:

```typescript
// With real-time snapping
const previewStyle: React.CSSProperties = {
  position: 'fixed',
  left: position.x - grabOffset.x,
  top: snapToGrid(position.y - grabOffset.y),  // <-- Snap to grid
  pointerEvents: 'none',
  zIndex: 9999,
};
```

### Grid Snapping Details

| Property | Value |
|----------|-------|
| Snap interval | 30 minutes |
| Pixels per snap | 40px (at 80px/hour) |
| Snap function | `snapToGrid()` from `snapUtils.ts` |

The `snapToGrid` function rounds to nearest 40px:
```typescript
export function snapToGrid(y: number): number {
  return Math.round(y / PIXELS_PER_SNAP) * PIXELS_PER_SNAP;
}
```

### Affected Files

| File | Change |
|------|--------|
| `apps/web/src/dnd/DragLayer.tsx` | Apply `snapToGrid()` to `top` position |

### REQ-09 Verification

Vertical-only drag is already implemented:
- Task can only be dropped in compatible station columns
- Column is determined by `task.stationId`
- This is enforced by the validation logic in `useDropValidation`

---

## Feature Checklist

### REQ-08: Real-Time Drag Snapping

- [x] **Apply snapToGrid to DragLayer preview position**
  - Description: Snap the `top` position of the drag preview to 30-minute intervals during drag
  - Files: `apps/web/src/dnd/DragLayer.tsx`
  - Tests: E2E test

- [x] **Import snapToGrid in DragLayer**
  - Description: Add import for the snap utility function
  - Files: `apps/web/src/dnd/DragLayer.tsx`
  - Tests: TypeScript compilation

### REQ-09: Vertical-Only Drag (Verification)

- [x] **Verify horizontal movement restriction**
  - Description: Confirm tiles cannot move between columns during drag
  - Files: N/A (already implemented)
  - Tests: E2E test

### Testing

- [x] **E2E test: drag snapping**
  - Description: Test that drag preview snaps to grid positions
  - Files: `apps/web/playwright/drag-snapping.spec.ts`

---

## Testing Requirements

### Unit Tests

- [x] N/A - `snapToGrid` function already has unit tests

### E2E Tests

- [x] Drag preview snaps to 30-minute positions during drag
- [x] Drag preview vertical position changes in 40px increments
- [x] Tile placement matches preview position after drop

### Manual Testing

- [x] Start dev server: `pnpm dev`
- [x] Load fixture: `http://localhost:5173/?fixture=sidebar-drag`
- [x] Drag a task from sidebar
- [x] Verify preview snaps to grid lines during drag (not just on drop)
- [x] Verify horizontal position stays fixed

---

## Manual QA Test Plan

### Test Fixtures

| Fixture | URL | Purpose |
|---------|-----|---------|
| `sidebar-drag` | `http://localhost:5173/?fixture=sidebar-drag` | Tasks for drag testing |

### Test Scenarios

#### Scenario 1: Real-Time Snap During Drag

**Fixture:** `sidebar-drag`

**Preconditions:**
- At least one job with unscheduled tasks
- Job is selected (Job Details Panel visible)

**Steps:**
1. Start dragging an unscheduled task from the Job Details Panel
2. Move the cursor slowly down the grid column
3. Observe the drag preview position

**Expected Results:**
- [x] Drag preview "jumps" between 30-minute grid positions
- [x] Preview does NOT follow cursor smoothly between grid lines
- [x] Preview position changes in discrete 40px steps
- [x] Preview snaps to nearest grid line (not cursor position)

#### Scenario 2: Snap Matches Drop Position

**Fixture:** `sidebar-drag`

**Preconditions:**
- Task being dragged over valid position

**Steps:**
1. Drag task to a position between grid lines (e.g., 10:15)
2. Note where the preview shows (should be 10:00 or 10:30)
3. Drop the task

**Expected Results:**
- [x] Tile lands at the snapped position (matching preview)
- [x] No difference between preview position and final tile position

#### Scenario 3: Vertical-Only Movement

**Fixture:** `sidebar-drag`

**Steps:**
1. Drag a task from sidebar
2. Move cursor horizontally across the screen

**Expected Results:**
- [x] Preview stays in the target column
- [x] Preview does not follow horizontal cursor movement
- [x] Only vertical movement affects preview position

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All E2E tests passing
- [x] Manual testing completed
- [x] Lint and TypeScript checks passing
- [x] Documentation updated (this file)
- [x] Roadmap updated (mark v0.3.31 as complete)
- [x] Git tag created: `v0.3.31`
- [x] GitHub release created

---

## Release Notes Draft

```markdown
## v0.3.31 â€“ Real-Time Drag Snapping

**Release Date:** 2025-12-22

### Summary

Drag preview now snaps to the 30-minute grid in real-time during drag operations,
providing immediate visual feedback of where the tile will land.

### What's New

- **Real-Time Snapping (REQ-08):** The drag preview now snaps to 30-minute grid
  positions during drag, instead of following the cursor freely.

- **Verified Vertical Movement (REQ-09):** Confirmed that tiles can only move
  vertically during drag (horizontal column is fixed by task.stationId).

### Technical Details

- Modified `DragLayer.tsx` to apply `snapToGrid()` to preview position
- Preview position changes in 40px increments (30 minutes at 80px/hour)

### Manual QA

Test URL: `http://localhost:5173/?fixture=sidebar-drag`

1. Select a job with unscheduled tasks
2. Drag a task from the sidebar
3. Observe preview snapping to grid lines during drag

### Related

- Prerequisite: v0.3.30 (Job Deselection Methods)
- Next: v0.3.32 (Enhanced Job Progression Visualization)
```

---

## Post-Release

- [x] GitHub release created
- [x] Verify on ux-ui-development branch
- [ ] Proceed to v0.3.32 implementation
