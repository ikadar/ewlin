# Release v0.3.36 – Dry Time Precedence

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-23
>
> **Git Tag:** `v0.3.36`
>
> **Branch:** `ux-ui-development`

---

## Overview

Add dry time (drying delay) support after printing tasks. When a printing task completes, the next task must wait for a fixed drying period before it can start. This modifies precedence validation rules without adding a visual station/column.

---

## Prerequisites

- [x] `v0.3.35` released (Global Timeline Compaction)
- [x] Precedence validation implemented in `@flux/schedule-validator`

---

## Scope

### In Scope

- `DRY_TIME_MINUTES = 240` constant (4 hours)
- Update `@flux/schedule-validator` precedence logic
- Identify printing tasks by station category (`cat-offset`)
- If predecessor is printing: `scheduledEnd + DRY_TIME` instead of `scheduledEnd`
- Label in JobDetailsPanel: `+4h drying` on precedence bar
- Unit tests for validator
- E2E test: precedence with dry time

### Out of Scope

- Configurable dry time per station/category
- Dry time for digital printing
- Visual representation on the timeline grid (no drying "station")

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Refactored Requirements](../ux-ui/tmp/refactored-new-requirements-en.md) | REQ-11 |

### Domain Model

| Document | Sections |
|----------|----------|
| [Station Types](../../packages/types/src/station.ts) | Station, StationCategory |
| [Precedence Validator](../../packages/validator/src/validators/precedence.ts) | validatePrecedence |

---

## Technical Notes

### Dry Time Concept

| Property | Value |
|----------|-------|
| **Constant name** | `DRY_TIME_MINUTES` |
| **Default value** | `240` (4 hours) |
| **Scope** | Application-level constant |
| **Application** | After every printing task (offset press category) |

### Identifying Printing Tasks

A task is considered a "printing task" if the assigned station belongs to the offset press category:

```typescript
// In validator, need to check:
const station = findStation(snapshot, predecessorAssignment.stationId);
const isPrintingTask = station?.categoryId === 'cat-offset';
```

### Modified Precedence Calculation

| Predecessor Type | Successor can start at |
|------------------|----------------------|
| Non-printing task | `predecessorEnd` |
| **Printing task** | **`predecessorEnd + DRY_TIME_MINUTES`** |

### Example

```
DRY_TIME = 4 hours (240 minutes)

Traditional precedence:
  Printing ends at 10:00 → Next task can start at 10:00

With dry time:
  Printing ends at 10:00 → Next task can start at 14:00
  Precedence check: scheduledEnd (10:00) + DRY_TIME (4h) = 14:00
```

### Affected Files

| Package/App | File | Change |
|-------------|------|--------|
| `@flux/schedule-validator` | `src/validators/precedence.ts` | Add dry time logic |
| `@flux/schedule-validator` | `src/utils/helpers.ts` | Add `findStation` helper if missing |
| `@flux/schedule-validator` | `src/validators/precedence.test.ts` | Add dry time tests |
| `apps/web` | `src/components/JobDetailsPanel/JobDetailsPanel.tsx` | Add "+4h drying" label |

---

## Feature Checklist

### Validator Updates

- [x] **Add DRY_TIME_MINUTES constant**
  - Description: Application-level constant for drying delay (240 minutes)
  - Files: `packages/validator/src/validators/precedence.ts`
  - Tests: N/A (constant)

- [x] **Add station lookup helper**
  - Description: Helper to find station by ID in snapshot
  - Files: `packages/validator/src/utils/helpers.ts`
  - Tests: Unit tests

- [x] **Modify precedence validation logic**
  - Description: If predecessor is printing task, add DRY_TIME to scheduledEnd
  - Files: `packages/validator/src/validators/precedence.ts`
  - Tests: `packages/validator/src/validate.test.ts`

- [x] **Update suggestedStart calculation**
  - Description: `getSuggestedStartForPrecedence` should account for dry time
  - Files: `packages/validator/src/validators/precedence.ts`
  - Tests: Unit tests

### Frontend Updates

- [x] **Add dry time label in JobDetailsPanel**
  - Description: Show "+4h drying" label between printing task and successor
  - Files: `apps/web/src/components/JobDetailsPanel/TaskList.tsx`, `DryTimeLabel.tsx`
  - Tests: E2E tests

### Integration

- [x] **Rebuild and republish validator package**
  - Description: Update version, rebuild, link to frontend
  - Files: `packages/validator/package.json`

---

## Testing Requirements

### Unit Tests

- [x] Precedence with dry time: printing task predecessor requires +4h delay
- [x] Precedence without dry time: non-printing task has no delay
- [x] Mixed scenario: printing followed by non-printing, then another task
- [x] Suggested start calculation includes dry time for printing predecessors
- [x] Outsourced assignments do NOT trigger dry time

### E2E Tests

- [x] Dry time label visible in JobDetailsPanel for printing predecessors
- [x] Dry time label has correct styling
- [x] Task tiles visible alongside dry time labels
- [x] Job selection works with dry time labels
- [x] Non-printing predecessors do not show dry time label

### Manual Testing

- [ ] Printing task ends at 10:00 → successor cannot start before 14:00
- [ ] Non-printing task ends at 10:00 → successor can start at 10:00
- [ ] "+4h drying" label visible in JobDetailsPanel for printing predecessors

---

## Manual QA Test Plan

### Test Fixtures

| Fixture | URL | Purpose |
|---------|-----|---------|
| `precedence` | `http://localhost:5173/?fixture=precedence` | Jobs with printing tasks and precedence |

### Test Scenarios

#### Scenario 1: Verify Dry Time Validation

**Fixture:** `precedence`

**Steps:**
1. Find a job with a printing task (offset press station) followed by another task
2. Note the printing task's end time (e.g., 10:00)
3. Try to drag the successor task to start at 10:00

**Expected Results:**
- [ ] Red ring appears (precedence conflict)
- [ ] Conflict message mentions dry time
- [ ] Suggested start is at 14:00 (10:00 + 4h)

#### Scenario 2: Verify No Dry Time for Non-Printing

**Fixture:** `precedence`

**Steps:**
1. Find a job with a cutting task followed by another task
2. Note the cutting task's end time
3. Drag the successor to start immediately after

**Expected Results:**
- [ ] Green ring appears (valid drop)
- [ ] No additional delay required
- [ ] Task can start at predecessor's end time

#### Scenario 3: Verify Dry Time Label

**Fixture:** `precedence`

**Steps:**
1. Select a job with printing task followed by successor
2. Look at JobDetailsPanel task list

**Expected Results:**
- [ ] Between printing and successor: "+4h drying" label visible
- [ ] Label appears on the precedence bar
- [ ] No label for non-printing predecessors

#### Scenario 4: Alt+Drop Creates Conflict

**Fixture:** `precedence`

**Steps:**
1. Find a job with printing task ending at 10:00
2. Drag successor to 11:00 (within 4h window)
3. Hold Alt and drop

**Expected Results:**
- [ ] Amber ring appears during Alt+drag
- [ ] Task is placed at 11:00
- [ ] Job appears in Problems section
- [ ] Tile shows amber glow (precedence conflict)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (31 validator, 535 web app)
- [x] All E2E tests passing (5 tests)
- [ ] Manual testing completed
- [x] Code reviewed and approved
- [x] Documentation updated (roadmap)
- [x] Git tag created: `v0.3.36`

---

## Release Notes Draft

```markdown
## v0.3.36 – Dry Time Precedence

**Release Date:** 2025-12-23

### Summary

Add drying time delay after printing tasks. After a printing task completes,
the next task in the job must wait 4 hours before it can start.

### What's New

- **Dry Time Validation:** Printing task predecessors now require +4h delay
- **Visual Label:** "+4h drying" shown in JobDetailsPanel between tasks
- **Smart Snapping:** Drag snapping accounts for dry time

### Technical Details

- `DRY_TIME_MINUTES = 240` (4 hours) application constant
- Affects tasks where predecessor station category is `cat-offset`
- Updated `@flux/schedule-validator` precedence logic
- Digital printing (`cat-digital`) does not trigger dry time

### Business Rule

> After printing, drying time is needed before the next task can start.
> This does not appear as a separate station but modifies precedence rules.
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Roadmap updated
- [ ] Release document status updated
