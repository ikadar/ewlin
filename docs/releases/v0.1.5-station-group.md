# Release v0.1.5 – Station Group Entity

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Release Date:** 2025-12-12
>
> **Git Tag:** `v0.1.5`

---

## Overview

This release expands the **StationGroup** entity from a stub to a full aggregate root with CRUD API endpoints. Station groups define concurrency limits for related stations - controlling how many stations within a group can run tasks simultaneously.

### Why This Matters

- **Capacity management**: Control maximum concurrent tasks across related stations
- **Resource planning**: Operators limited (e.g., one operator runs multiple presses)
- **Provider support**: Foundation for outsourced provider groups (unlimited capacity)
- **Required for scheduling**: Group capacity is validated during task assignment (BR-GROUP-002)

---

## Prerequisites

- [x] `v0.1.4` released (Station Category Entity)
- [x] StationGroup stub entity exists with id/name/maxConcurrent fields
- [x] Station entity references groupId

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| StationGroup entity expansion | Add isOutsourcedProviderGroup, description, timestamps |
| POST /api/v1/station-groups | Create group with concurrency limit |
| GET /api/v1/station-groups | List all groups |
| GET /api/v1/station-groups/{id} | Get group details |
| PUT /api/v1/station-groups/{id} | Update group |
| DELETE /api/v1/station-groups/{id} | Delete group |
| maxConcurrent validation | Positive integer or null (unlimited) |
| Unique name validation | Group names must be unique |
| Unit tests | Entity tests |
| Integration tests | API endpoint tests |

### Out of Scope

| Item | Reason |
|------|--------|
| Capacity enforcement at scheduling | Covered in M2 (Assignment Service) |
| Automatic provider group creation | Covered in v0.1.6 (Outsourced Provider) |
| Station reassignment between groups | Future enhancement |
| Group capacity utilization reporting | Post-MVP feature |

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-GROUP-001, BR-GROUP-002, BR-GROUP-003, BR-GROUP-004 |
| [Domain Model](../domain-model/domain-model.md) | StationGroup (Aggregate Root) |

### Architecture

| Document | Sections |
|----------|----------|
| [Interface Contracts](../architecture/interface-contracts.md) | Section 3: Station Group Service |

---

## Domain Model Reference

### StationGroup Structure

```
┌─────────────────────────────────────────────────────────────┐
│                      StationGroup                           │
├─────────────────────────────────────────────────────────────┤
│  id: string (UUID)                                          │
│  name: string (max 100, unique)                             │
│  description: string|null                                   │
│  maxConcurrent: int|null (null = unlimited)                 │
│  isOutsourcedProviderGroup: boolean                         │
│  createdAt: datetime                                        │
│  updatedAt: datetime                                        │
└─────────────────────────────────────────────────────────────┘
```

### Example Groups

```json
{
  "id": "grp-offset-presses",
  "name": "Offset Press Operators",
  "description": "Limited by operator availability - max 2 presses at once",
  "maxConcurrent": 2,
  "isOutsourcedProviderGroup": false,
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

```json
{
  "id": "grp-provider-pelliculage",
  "name": "Pelliculage Provider",
  "description": "External provider - unlimited capacity",
  "maxConcurrent": null,
  "isOutsourcedProviderGroup": true,
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

---

## Business Rules

| Rule ID | Description | Enforcement |
|---------|-------------|-------------|
| **BR-GROUP-001** | Group must have maxConcurrent defined | Integer or null (unlimited) |
| **BR-GROUP-002** | Active tasks cannot exceed maxConcurrent | M2 - Assignment Service |
| **BR-GROUP-003** | Provider groups must be unlimited | Validation when isOutsourcedProviderGroup=true |
| **BR-GROUP-004** | All stations must have a group | Station entity validation |

---

## API Design

### POST /api/v1/station-groups

Create a station group.

**Request:**
```json
{
  "name": "Offset Press Operators",
  "description": "Limited by operator availability",
  "maxConcurrent": 2,
  "isOutsourcedProviderGroup": false
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "name": "Offset Press Operators",
  "description": "Limited by operator availability",
  "maxConcurrent": 2,
  "isOutsourcedProviderGroup": false,
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

**Error Responses:**

(400) Invalid maxConcurrent:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "maxConcurrent must be a positive integer or null"
  }
}
```

(400) Provider group must be unlimited:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Outsourced provider groups must have unlimited capacity (maxConcurrent = null)"
  }
}
```

(409) Duplicate name:
```json
{
  "error": {
    "code": "GROUP_NAME_EXISTS",
    "message": "A group with this name already exists"
  }
}
```

### GET /api/v1/station-groups

List all groups.

**Query Parameters:**
- `search` (optional): Search by name
- `isOutsourcedProviderGroup` (optional): Filter by type (true/false)

**Response (200):**
```json
{
  "data": [...],
  "total": 5
}
```

### GET /api/v1/station-groups/{id}

Get group by ID.

**Response (200):** Group object

**Response (404):** Group not found

### PUT /api/v1/station-groups/{id}

Update group.

**Request:**
```json
{
  "name": "Updated Name",
  "description": "Updated description",
  "maxConcurrent": 3
}
```

**Notes:**
- `isOutsourcedProviderGroup` cannot be changed after creation
- Changing `maxConcurrent` does not affect existing assignments (future validation will check)

### DELETE /api/v1/station-groups/{id}

Delete group.

**Response (204):** No content

**Response (409):** Group in use by stations

---

## File Structure

```
services/php-api/
├── src/
│   ├── DTO/
│   │   └── StationGroup/
│   │       ├── CreateGroupRequest.php
│   │       ├── UpdateGroupRequest.php
│   │       └── GroupResponse.php
│   ├── Controller/
│   │   └── Api/V1/
│   │       └── StationGroupController.php
│   ├── Entity/
│   │   └── StationGroup.php           # Expand existing stub
│   ├── Repository/
│   │   └── StationGroupRepository.php # Expand existing stub
│   └── Service/
│       └── StationGroupService.php
├── migrations/
│   └── Version20251212XXXXXX.php      # Add new columns
└── tests/
    ├── Unit/
    │   └── Entity/
    │       └── StationGroupTest.php
    └── Integration/
        └── Controller/Api/V1/
            └── StationGroupControllerTest.php
```

---

## Database Changes

Update `station_groups` table:

```sql
ALTER TABLE station_groups
    ADD COLUMN description VARCHAR(500) DEFAULT NULL,
    ADD COLUMN is_outsourced_provider_group TINYINT(1) NOT NULL DEFAULT 0,
    ADD COLUMN created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ADD COLUMN updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

CREATE UNIQUE INDEX UNIQ_station_groups_name ON station_groups (name);
```

---

## Feature Checklist

### Entity Update

- [x] **Expand StationGroup entity**
  - File: `src/Entity/StationGroup.php`
  - Add: description, isOutsourcedProviderGroup, timestamps
  - Validation: maxConcurrent positive or null
  - Validation: provider groups must have null maxConcurrent
  - Tests: `tests/Unit/Entity/StationGroupTest.php`

### Repository Update

- [x] **Expand StationGroupRepository**
  - File: `src/Repository/StationGroupRepository.php`
  - Methods: `findAllWithFilters()`, `isNameUnique()`, `isInUse()`

### Database Migration

- [x] **Create migration for expanded fields**
  - File: `migrations/Version20251212120000.php`

### DTO Layer

- [x] **Create GroupRequest DTOs**
  - Files: `src/DTO/StationGroup/*.php`
  - CreateGroupRequest, UpdateGroupRequest, GroupResponse

### Service Layer

- [x] **Create StationGroupService**
  - File: `src/Service/StationGroupService.php`
  - Methods: `create()`, `update()`, `delete()`, `findById()`, `findAll()`

### Controller Layer

- [x] **Create StationGroupController**
  - File: `src/Controller/Api/V1/StationGroupController.php`
  - Routes: POST, GET (list), GET (single), PUT, DELETE
  - OpenAPI documentation

### Testing

- [x] **Unit tests** (24 tests)
  - StationGroup: entity validation, provider group rules

- [x] **Integration tests** (31 tests)
  - Create group
  - Create with unlimited capacity
  - Create provider group
  - Provider group with maxConcurrent rejected
  - List groups
  - List with filters
  - Get single group
  - Update group
  - Delete group
  - Delete in-use group rejected

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `StationGroupTest` | Valid group creation |
| | Name validation (non-empty, max length) |
| | maxConcurrent positive or null |
| | maxConcurrent zero rejected |
| | maxConcurrent negative rejected |
| | Provider group must have unlimited capacity |
| | Provider group with maxConcurrent rejected |
| | Timestamps set on creation |

### Integration Tests

| Test Class | Test Cases |
|------------|------------|
| `StationGroupControllerTest` | Create group (201) |
| | Create with unlimited capacity (201) |
| | Create with description (201) |
| | Create provider group (201) |
| | Create provider group with maxConcurrent (400) |
| | Create duplicate name (409) |
| | Create with invalid maxConcurrent (400) |
| | List groups (200) |
| | List with search filter (200) |
| | List with provider filter (200) |
| | Get group (200) |
| | Get not found (404) |
| | Update group (200) |
| | Update name to duplicate (409) |
| | Delete group (204) |
| | Delete in-use group (409) |

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (24 tests)
- [x] All integration tests passing (31 tests)
- [x] OpenAPI documentation updated
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 8)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.5`

---

## Release Notes Draft

```markdown
## v0.1.5 – Station Group Entity

**Release Date:** 2025-12-12

### Summary

Expands the StationGroup entity with full CRUD support and concurrency management.
Station groups control how many stations can run tasks simultaneously, essential
for resource planning when operators are limited.

### What's New

- **StationGroup entity expansion** - Description, isOutsourcedProviderGroup, timestamps
- **POST /api/v1/station-groups** - Create group with concurrency limit
- **GET /api/v1/station-groups** - List groups with search and filters
- **GET /api/v1/station-groups/{id}** - Get group details
- **PUT /api/v1/station-groups/{id}** - Update group
- **DELETE /api/v1/station-groups/{id}** - Delete group
- **Provider group support** - isOutsourcedProviderGroup flag with enforced unlimited capacity
- **Validation** - maxConcurrent must be positive or null, provider groups must be unlimited

### API Changes

New endpoints:
- `POST /api/v1/station-groups`
- `GET /api/v1/station-groups`
- `GET /api/v1/station-groups/{id}`
- `PUT /api/v1/station-groups/{id}`
- `DELETE /api/v1/station-groups/{id}`

### Breaking Changes

None

### Migration Guide

Run database migration to add new columns:
```bash
php bin/console doctrine:migrations:migrate
```
```

---

## Post-Release

- [x] GitHub release created with notes
- [x] Verify API documentation updated
- [ ] Test group endpoints via curl/Postman
- [ ] Proceed to v0.1.6 (Outsourced Provider Entity)
