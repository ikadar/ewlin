# Release v0.1.12 – Job Creation with DSL (Server-Side)

> **Status:** ✅ Released
>
> **Milestone:** M1
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.1.12`

---

## Overview

This release extends the Job creation API to accept a `tasksDsl` field containing Task DSL definitions. The server performs semantic validation (checking that referenced stations and providers exist) and creates Task entities from the parsed DSL. This is the server-side counterpart to the client-side Lezer parser (v0.3.18).

**Key Insight:** DSL syntax parsing happens client-side using Lezer. The server receives already-parsed task definitions and performs:
1. Semantic validation (entity existence)
2. Task entity creation
3. rawDsl preservation for debugging/audit

---

## Prerequisites

- [x] `v0.1.11` Task Entity released
- [x] Task entity with `rawDsl` field support
- [x] Station and Provider entities exist with name lookup

---

## Scope

### In Scope

- Extend `POST /api/v1/jobs` to accept `tasksDsl` field
- Server-side semantic validation of DSL references
- Task entity creation from DSL input
- Validation error responses with line numbers
- Preserve `rawDsl` on each Task entity

### Out of Scope

- Client-side Lezer parser (v0.3.18)
- Autocomplete endpoints (v0.1.13)
- DSL syntax parsing (client-side responsibility)

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Task DSL Specification](../requirements/task-dsl-specification.md) | Sections 2-6 (Syntax, Grammar, Validation) |
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 9 - DSL Support API |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-TASK-001 to BR-TASK-009 |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-011 (Lezer Parser) |
| [Interface Contracts](../architecture/interface-contracts.md) | Section 5.1 CreateJob, Section 8 DSL Support |

---

## Technical Notes

### DSL Parsing Flow

```
Client (Lezer)         Server (PHP)
     │                      │
     │  Parse DSL syntax    │
     │  ──────────────►     │
     │                      │
     │  POST /api/v1/jobs   │
     │  { tasksDsl: "..." } │
     │  ──────────────────► │
     │                      │  Parse DSL lines
     │                      │  Validate stations/providers exist
     │                      │  Create Task entities
     │                      │  Return Job with tasks
     │  ◄────────────────── │
```

### DSL Line Parsing (Server-Side)

The server parses each DSL line with a simple regex-based parser:

**Internal Task Pattern:**
```
[StationName] Setup+Run "comment"
[StationName] Run "comment"
```

**Outsourced Task Pattern:**
```
ST [ProviderName] ActionType DurationJO "comment"
```

### Error Response Format

```json
{
  "error": "validation_error",
  "message": "DSL contains invalid references",
  "details": [
    {
      "line": 2,
      "message": "Station 'UnknownStation' not found",
      "rawInput": "[UnknownStation] 20+40"
    }
  ]
}
```

---

## Feature Checklist

### DSL Parser Service

- [x] **DslParserService**
  - Description: Service to parse DSL text and validate against existing entities
  - Files: `src/Service/DslParserService.php`
  - Tests: `tests/Unit/Service/DslParserServiceTest.php`

- [x] **ParsedTask DTO**
  - Description: Data transfer object for parsed task data
  - Files: `src/DTO/Dsl/ParsedTask.php`
  - Tests: Covered by DslParserServiceTest

- [x] **DslValidationError DTO**
  - Description: Error details with line number and message
  - Files: `src/DTO/Dsl/DslValidationError.php`
  - Tests: Covered by DslParserServiceTest

### Job API Extension

- [x] **Extend JobController::create()**
  - Description: Accept optional `tasksDsl` field in request
  - Files: `src/Controller/Api/V1/JobController.php`
  - Tests: `tests/Integration/Controller/Api/V1/JobControllerTest.php`

- [x] **CreateJobRequest DTO update**
  - Description: Add `tasksDsl` optional field
  - Files: `src/DTO/Job/CreateJobRequest.php`
  - Tests: Covered by integration tests

### Entity Updates

- [x] **Task.rawDsl field usage**
  - Description: Store original DSL line on Task entity
  - Files: `src/Entity/Task.php` (already has field)
  - Tests: Covered by unit tests

---

## Testing Requirements

### Unit Tests

- [x] DslParserService internal task parsing
- [x] DslParserService outsourced task parsing
- [x] DslParserService comment extraction (all positions)
- [x] DslParserService station name resolution (underscores → spaces)
- [x] DslParserService validation error collection
- [x] DslParserService multi-line parsing

### Integration Tests

- [x] POST /api/v1/jobs with valid tasksDsl creates tasks
- [x] POST /api/v1/jobs with invalid station returns 400 with line info
- [x] POST /api/v1/jobs with invalid provider returns 400 with line info
- [x] POST /api/v1/jobs with mixed valid/invalid lines returns all errors
- [x] Task.rawDsl preserved correctly
- [x] Task.sequenceOrder assigned correctly

### Manual Testing

- [x] Create job via API with multi-line DSL
- [x] Verify created tasks match DSL definitions
- [x] Verify error messages are actionable

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (637 tests, 1760 assertions)
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] Documentation updated
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.12`
- [x] GitHub release created

---

## Release Notes Draft

```markdown
## v0.1.12 – Job Creation with DSL (Server-Side)

**Release Date:** 2025-12-14

### Summary

Extends the Job creation API to accept Task DSL definitions. The server validates that referenced stations and providers exist, then creates Task entities from the DSL input.

### What's New

- `POST /api/v1/jobs` now accepts optional `tasksDsl` field
- Server-side semantic validation of DSL references
- Task entities created with preserved `rawDsl` for debugging
- Detailed validation errors with line numbers

### API Changes

**Request (extended):**
```json
{
  "reference": "JOB-2024-001",
  "client": "Acme Corp",
  "description": "Catalog 500pcs",
  "workshopExitDate": "2025-01-15",
  "tasksDsl": "[Komori] 20+40 \"vernis\"\n[Massicot] 15\nST [Clément] Pelliculage 2JO"
}
```

### Breaking Changes

None
```

---

## Post-Release

- [x] GitHub release created
- [x] Submodule reference updated in monorepo
- [x] Documentation verified
