# Release v0.0.8 â€“ Repository Structure (Git Submodules)

> **Status:** ğŸ”´ Not Started
>
> **Milestone:** M0 (Infrastructure & Foundation)
>
> **Target Date:** TBD
>
> **Git Tag:** `v0.0.8`

---

## Overview

This release converts the project from a monorepo structure to a **host application with git submodules**. This enables independent versioning, separate CI/CD pipelines, and clearer ownership boundaries for each component.

### Why This Matters

- **Independent development**: Each submodule can be developed, versioned, and released independently
- **Clearer boundaries**: Physical separation reinforces architectural boundaries
- **Reusability**: Packages like `@flux/types` and `@flux/schedule-validator` can be used in other projects
- **Team scalability**: Different teams can own different repositories
- **NPM/Packagist publishing**: Submodules are ready for package registry publication

---

## Prerequisites

- [x] `v0.0.7` released (CI Fixes, M0 infrastructure complete)
- [x] All existing code committed and pushed
- [ ] GitHub organization/account ready for new repositories

---

## Architecture Reference

See [Project Structure](../architecture/project-structure.md) for the target architecture.

---

## Current vs Target Structure

### Current Structure (Monorepo)

```
ewlin/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api/                          â† PHP/Symfony backend
â”‚   â””â”€â”€ node/
â”‚       â””â”€â”€ packages/
â”‚           â”œâ”€â”€ types/                â† @flux/types
â”‚           â””â”€â”€ validator/            â† @flux/schedule-validator
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ web/                          â† React frontend
â””â”€â”€ docs/
```

### Target Structure (Host + Submodules)

```
ewlin/                                 # Host application (this repo)
â”œâ”€â”€ packages/                          # Shared packages (git submodules)
â”‚   â”œâ”€â”€ types/                         â† ewlin-types repo (submodule)
â”‚   â””â”€â”€ validator/                     â† ewlin-validator repo (submodule)
â”œâ”€â”€ services/
â”‚   â””â”€â”€ php-api/                       â† ewlin-php-api repo (submodule)
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ web/                           â† React frontend (stays in host)
â””â”€â”€ docs/                              â† Documentation (stays in host)
```

---

## Repositories to Create

| Repository | Purpose | Initial Content |
|------------|---------|-----------------|
| `ewlin-php-api` | PHP/Symfony backend | Current `services/api/` content |
| `ewlin-types` | Shared TypeScript types | Current `services/node/packages/types/` content |
| `ewlin-validator` | Schedule validation package | Current `services/node/packages/validator/` content |

### Repository Naming Convention

- Prefix: `ewlin-` (project identifier)
- Suffix: component name (`php-api`, `types`, `validator`)

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| Create GitHub repositories | 3 new repositories for submodules |
| Move code to repositories | Transfer existing code with history preservation |
| Configure submodules | Link repositories as git submodules in host |
| Update workspace config | Modify `pnpm-workspace.yaml` for new paths |
| Update CI/CD | Adjust GitHub Actions workflows |
| Update imports | Fix any broken import paths |
| Update documentation | Correct file path references in docs |

### Out of Scope

| Item | Reason |
|------|--------|
| NPM/Packagist publishing | Future release |
| Separate CI for submodules | Future release (use host CI for now) |
| Independent versioning | MVP uses unified versioning |

---

## Implementation Steps

### Phase 1: Prepare Host Repository

1. **Create new directory structure**
   ```bash
   mkdir -p packages
   ```

2. **Remove content that will become submodules**
   - `services/api/` â†’ will be replaced by submodule
   - `services/node/packages/types/` â†’ will be replaced by submodule
   - `services/node/packages/validator/` â†’ will be replaced by submodule

### Phase 2: Create Submodule Repositories

#### 2.1 Create `ewlin-php-api` Repository

1. Create new GitHub repository: `ewlin-php-api`
2. Initialize with content from `services/api/`
3. Structure:
   ```
   ewlin-php-api/
   â”œâ”€â”€ src/
   â”‚   â”œâ”€â”€ Entity/
   â”‚   â””â”€â”€ Repository/
   â”œâ”€â”€ config/
   â”œâ”€â”€ migrations/
   â”œâ”€â”€ tests/
   â”œâ”€â”€ composer.json
   â”œâ”€â”€ phpunit.xml.dist
   â”œâ”€â”€ CHANGELOG.md
   â””â”€â”€ README.md
   ```

#### 2.2 Create `ewlin-types` Repository

1. Create new GitHub repository: `ewlin-types`
2. Initialize with content from `services/node/packages/types/`
3. Structure:
   ```
   ewlin-types/
   â”œâ”€â”€ src/
   â”‚   â”œâ”€â”€ station.ts
   â”‚   â”œâ”€â”€ job.ts
   â”‚   â”œâ”€â”€ task.ts
   â”‚   â”œâ”€â”€ assignment.ts
   â”‚   â””â”€â”€ index.ts
   â”œâ”€â”€ package.json
   â”œâ”€â”€ tsconfig.json
   â”œâ”€â”€ CHANGELOG.md
   â””â”€â”€ README.md
   ```

#### 2.3 Create `ewlin-validator` Repository

1. Create new GitHub repository: `ewlin-validator`
2. Initialize with content from `services/node/packages/validator/`
3. Structure:
   ```
   ewlin-validator/
   â”œâ”€â”€ src/
   â”‚   â”œâ”€â”€ validators/
   â”‚   â”œâ”€â”€ utils/
   â”‚   â”œâ”€â”€ validate.ts
   â”‚   â””â”€â”€ index.ts
   â”œâ”€â”€ package.json
   â”œâ”€â”€ tsconfig.json
   â”œâ”€â”€ vitest.config.ts
   â”œâ”€â”€ CHANGELOG.md
   â””â”€â”€ README.md
   ```

### Phase 3: Add Submodules to Host

```bash
# Add PHP API submodule
git submodule add git@github.com:OWNER/ewlin-php-api.git services/php-api

# Add types submodule
git submodule add git@github.com:OWNER/ewlin-types.git packages/types

# Add validator submodule
git submodule add git@github.com:OWNER/ewlin-validator.git packages/validator
```

### Phase 4: Update Configuration

#### 4.1 Update `pnpm-workspace.yaml`

```yaml
packages:
  - 'packages/*'
  - 'apps/*'
```

#### 4.2 Update CI/CD Workflows

- Update paths in `.github/workflows/ci.yml`
- Add `git submodule update --init --recursive` step
- Adjust test/build paths

#### 4.3 Update Package Dependencies

- `packages/validator/package.json`: Update `@flux/types` dependency path
- `apps/web/package.json`: Update workspace dependencies

### Phase 5: Cleanup

1. Remove old directories:
   - `services/api/`
   - `services/node/`

2. Update `.gitignore` if needed

3. Commit and tag

---

## File Changes Summary

### Host Repository (`ewlin`)

| Action | Path |
|--------|------|
| DELETE | `services/api/` (entire directory) |
| DELETE | `services/node/` (entire directory) |
| CREATE | `packages/` (empty, submodules go here) |
| MODIFY | `pnpm-workspace.yaml` |
| MODIFY | `.github/workflows/ci.yml` |
| CREATE | `.gitmodules` |

### New Repository: `ewlin-php-api`

| Action | Path |
|--------|------|
| CREATE | All files from `services/api/` |
| CREATE | `README.md` |
| CREATE | `CHANGELOG.md` |

### New Repository: `ewlin-types`

| Action | Path |
|--------|------|
| CREATE | All files from `services/node/packages/types/` |
| CREATE | `README.md` |
| CREATE | `CHANGELOG.md` |

### New Repository: `ewlin-validator`

| Action | Path |
|--------|------|
| CREATE | All files from `services/node/packages/validator/` |
| MODIFY | `package.json` (update @flux/types path) |
| CREATE | `README.md` |
| CREATE | `CHANGELOG.md` |

---

## Versioning Strategy (MVP)

For the MVP, all repositories follow **unified versioning**:

```
ewlin (host):      v0.0.8  â† Main version, documentation here
â”œâ”€â”€ php-api:       v0.0.8  â† Follows host version
â”œâ”€â”€ types:         v0.0.8  â† Follows host version
â””â”€â”€ validator:     v0.0.8  â† Follows host version
```

Each submodule has its own `CHANGELOG.md` tracking its specific changes.

Post-MVP, repositories may diverge to independent versioning if needed.

---

## Developer Workflow Changes

### Cloning the Project

```bash
# Clone with submodules
git clone --recursive git@github.com:OWNER/ewlin.git

# Or clone then init submodules
git clone git@github.com:OWNER/ewlin.git
cd ewlin
git submodule update --init --recursive
```

### Updating Submodules

```bash
# Update all submodules to latest
git submodule update --remote

# Update specific submodule
cd packages/types
git pull origin main
cd ../..
git add packages/types
git commit -m "Update types submodule"
```

### Working on a Submodule

```bash
# Navigate to submodule
cd packages/validator

# Make changes, commit, push
git checkout -b feature/new-validator
# ... make changes ...
git commit -m "Add new validator"
git push origin feature/new-validator

# Create PR in submodule repo
# After merge, update host repo to point to new commit
```

---

## Testing Requirements

### Pre-Migration Tests

- [ ] All existing tests pass in current structure
- [ ] CI pipeline is green

### Post-Migration Tests

- [ ] `pnpm install` works from host root
- [ ] `pnpm build` builds all packages
- [ ] `pnpm test` runs all tests
- [ ] Frontend can import from `@flux/types` and `@flux/schedule-validator`
- [ ] PHP API tests pass
- [ ] CI pipeline is green with new structure

---

## Rollback Plan

If migration fails:

1. Delete the new GitHub repositories
2. Restore `services/api/` and `services/node/` from git history
3. Revert `pnpm-workspace.yaml` changes
4. Revert CI/CD changes

---

## Definition of Done

- [ ] Three new GitHub repositories created and accessible
- [ ] All code migrated to appropriate repositories
- [ ] Submodules linked in host repository
- [ ] `pnpm install && pnpm build && pnpm test` passes
- [ ] CI pipeline passes
- [ ] Developer workflow documented
- [ ] CHANGELOG.md updated in all repositories
- [ ] Git tag `v0.0.8` created in host repository
- [ ] Git tag `v0.0.8` created in each submodule repository

---

## Release Notes Draft

```markdown
## v0.0.8 â€“ Repository Structure (Git Submodules)

**Release Date:** TBD

### Summary

Converts the project from a monorepo to a host application with git submodules,
enabling independent development and clearer component boundaries.

### What's New

- **Repository structure**: Host + 3 submodule repositories
- **New repositories**:
  - `ewlin-php-api`: PHP/Symfony backend
  - `ewlin-types`: Shared TypeScript types (@flux/types)
  - `ewlin-validator`: Schedule validation package (@flux/schedule-validator)
- **Updated paths**: `services/api` â†’ `services/php-api`, `services/node/packages/*` â†’ `packages/*`

### Breaking Changes

- Repository clone command changes (requires `--recursive` flag)
- Import paths unchanged (package names remain the same)

### Migration Guide

```bash
# Fresh clone
git clone --recursive git@github.com:OWNER/ewlin.git

# Existing clone - update
git pull
git submodule update --init --recursive
```
```

---

## Post-Release

- [ ] Verify all team members can clone and build
- [ ] Update any external documentation or links
- [ ] Proceed to v0.1.0 (Station Entity)

---

## Appendix: Git Submodule Commands Reference

| Command | Description |
|---------|-------------|
| `git submodule add <url> <path>` | Add a new submodule |
| `git submodule update --init` | Initialize submodules after clone |
| `git submodule update --remote` | Update to latest remote commits |
| `git submodule foreach <cmd>` | Run command in each submodule |
| `git submodule status` | Show submodule commit status |
