# Release v0.2.18 – Task Completion Toggle

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Release Date:** 2025-12-14
>
> **Git Tag:** `v0.2.18`

---

## Overview

This release adds the Task Completion Toggle endpoint, allowing users to manually mark tasks as completed or uncompleted. The completion status is a manual UI toggle (checkbox on the tile) - it does NOT affect precedence validation.

Key deliverables:
- PUT /api/v1/tasks/{taskId}/completion endpoint
- CompletionService to orchestrate the toggle
- CompletionResponse DTO
- Unit tests for the service

---

## Prerequisites

- [x] `v0.2.17` released (Assignment Domain Events)
- [x] Schedule entity with `toggleTaskCompletion` method
- [x] TaskAssignment with `withCompletionToggled` method
- [x] TaskCompletionToggled event

---

## Scope

### In Scope

- PUT /api/v1/tasks/{taskId}/completion endpoint
- CompletionService for business logic
- CompletionResponse DTO for API response
- Toggle isCompleted flag (true ↔ false)
- Set/clear completedAt timestamp
- Unit tests for CompletionService

### Out of Scope

- Automatic completion based on time
- Completion affecting precedence validation (BR-ASSIGN-008)
- Batch completion operations
- Completion notifications/webhooks

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-ASSIGN-007 (manual toggle), BR-ASSIGN-008 (no precedence effect) |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |

---

## Technical Notes

### Endpoint Design

```
PUT /api/v1/tasks/{taskId}/completion
```

No request body needed - the endpoint toggles the current state.

### Response Format

```json
{
    "taskId": "task-uuid",
    "isCompleted": true,
    "completedAt": "2025-12-14T10:30:00+00:00"
}
```

When toggled off:
```json
{
    "taskId": "task-uuid",
    "isCompleted": false,
    "completedAt": null
}
```

### Service Flow

1. Find the task by ID
2. Get current schedule
3. Verify task is assigned
4. Call `schedule.toggleTaskCompletion(taskId)`
5. Persist changes
6. Return updated completion state

### Business Rules

- **BR-ASSIGN-007**: Task completion is manually toggled via UI checkbox
- **BR-ASSIGN-008**: isCompleted flag does NOT affect precedence validation

---

## Feature Checklist

### Service Layer

- [x] **CompletionService**
  - Description: Service to toggle task completion
  - Files: `src/Service/CompletionService.php`
  - Tests: `tests/Unit/Service/CompletionServiceTest.php`

### DTO

- [x] **CompletionResponse**
  - Description: Response DTO for completion toggle
  - Files: `src/DTO/Assignment/CompletionResponse.php`
  - Tests: `tests/Unit/DTO/Assignment/CompletionResponseTest.php`

### Controller

- [x] **Toggle Completion Endpoint**
  - Description: PUT /api/v1/tasks/{taskId}/completion
  - Files: `src/Controller/Api/V1/TaskController.php` (modify)
  - Tests: via service tests

---

## Testing Requirements

### Unit Tests

- [x] CompletionService - toggles completion for assigned task
- [x] CompletionService - throws NotFoundException for unknown task
- [x] CompletionService - throws InvalidArgumentException for unassigned task
- [x] CompletionResponse - constructs with completed state
- [x] CompletionResponse - constructs with uncompleted state
- [x] CompletionResponse - toArray returns all fields

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.18`

---

## Release Notes Draft

```markdown
## v0.2.18 – Task Completion Toggle

**Release Date:** 2025-12-14

### Summary

Adds the Task Completion Toggle endpoint for manually marking tasks as completed or uncompleted.

### What's New

- **PUT /api/v1/tasks/{taskId}/completion** - Toggle task completion status
- CompletionService for completion logic
- CompletionResponse DTO

### Technical

- Manual toggle via UI checkbox (BR-ASSIGN-007)
- Does NOT affect precedence validation (BR-ASSIGN-008)
- PHPStan level 8 compliant
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo updated
- [ ] Next release (v0.3.0 - Mock Data Generators) ready to start
