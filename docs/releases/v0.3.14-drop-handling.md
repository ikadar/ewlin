# Release v0.3.14 – Drop Handling

> **Status:** ✅ Released (with known issues)
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-16
>
> **Git Tag:** `v0.3.14`

---

## Overview

This release implements the drop handling logic for drag and drop operations. When a tile is dropped on a valid position, the system creates a new assignment with optimistic UI update. Invalid drops show conflicts in the Problèmes section. Tile insertion follows the push-down behavior for capacity-1 stations.

---

## Prerequisites

- [x] v0.3.13 - Real-Time Validation During Drag released
- [x] useDropValidation hook available
- [x] Mock snapshot with updateSnapshot function

---

## Scope

### In Scope

- **Create assignment on valid drop** - Generate TaskAssignment on successful drop
- **Optimistic UI update** - Immediately show tile at dropped position
- **Conflict display** - Show conflicts in Problèmes section (warnings only)
- **Tile insertion (push-down)** - For capacity-1 stations, push subsequent tiles down
- **End time calculation** - Calculate scheduledEnd based on task duration

### Out of Scope

- Server-side validation (mock only)
- Tile overlap for capacity > 1 stations (simplified: all stations treated as capacity-1)
- Undo functionality
- Drag from left panel (existing tiles only)

---

## Related Documentation

### UX/UI Specification

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Drop Handling, Tile Insertion |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-ASSIGN-009, BR-STATION-006 |

---

## Technical Notes

### Assignment Creation

```typescript
// Create new TaskAssignment
const newAssignment: TaskAssignment = {
  id: generateId(), // UUID
  taskId: task.id,
  targetId: stationId,
  isOutsourced: false,
  scheduledStart: scheduledStart,
  scheduledEnd: calculateEndTime(task, scheduledStart),
  isCompleted: false,
  completedAt: null,
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
};
```

### End Time Calculation

For internal tasks:
- `scheduledEnd = scheduledStart + (task.estimatedMinutes * 60 * 1000)`
- Simple calculation without operating hours stretching (MVP)

### Push-Down Logic

When inserting a tile that would overlap with existing tiles:
1. Find all assignments on the same station that start at or after the new tile's start
2. Calculate the duration of the new tile
3. Shift all subsequent tiles by the new tile's duration
4. Update assignments in snapshot

### Optimistic Update

Use `updateSnapshot()` from mock/snapshot.ts:
```typescript
updateSnapshot((snapshot) => ({
  ...snapshot,
  assignments: [...snapshot.assignments, newAssignment],
}));
```

---

## Feature Checklist

### Assignment Creation

- [x] **Create assignment on drop**
  - Description: Generate TaskAssignment when tile is dropped on valid position
  - Files: `apps/web/src/App.tsx`

- [x] **Calculate scheduled end time**
  - Description: Calculate end time based on task duration
  - Files: `apps/web/src/utils/timeCalculations.ts`

- [x] **Generate unique assignment ID**
  - Description: Create UUID for new assignment
  - Files: `apps/web/src/utils/generateId.ts`

### Optimistic UI Update

- [x] **Update snapshot on drop**
  - Description: Use updateSnapshot to add new assignment
  - Files: `apps/web/src/App.tsx`

- [x] **Trigger re-render**
  - Description: Ensure UI updates with new assignment
  - Files: `apps/web/src/App.tsx`

### Push-Down Logic

- [x] **Detect tile overlap**
  - Description: Check if new tile would overlap with existing tiles
  - Files: `apps/web/src/utils/pushDown.ts`

- [x] **Calculate push-down shifts**
  - Description: Calculate new start times for affected tiles
  - Files: `apps/web/src/utils/pushDown.ts`

- [x] **Apply push-down updates**
  - Description: Update all affected assignments
  - Files: `apps/web/src/App.tsx`

### Conflict Display

- [x] **Add conflict on bypass**
  - Description: When Alt-key bypass is used, add conflict to snapshot
  - Files: `apps/web/src/App.tsx`

- [x] **Show conflicts in Problèmes**
  - Description: Conflicts appear in JobsList Problèmes section
  - Files: (Already implemented in JobsList)

---

## Testing Requirements

### Unit Tests

- [x] Assignment creation with correct fields
- [x] End time calculation is accurate
- [x] Push-down logic shifts subsequent tiles correctly
- [x] Conflict is added when bypass is used
- [x] Snapshot version increments on update

### Integration Tests

- [x] Drop creates visible tile at correct position
- [x] Push-down animates affected tiles
- [x] Conflicts appear in Problèmes section

### Manual Testing

- [x] Drop tile on empty slot - tile appears
- [x] Drop tile on occupied slot - pushes down existing tiles
- [x] Drop with Alt (bypass) - tile appears with conflict badge
- [x] Multiple drops work correctly
- [x] Tile appears at snapped position

---

## Known Issues

- Edge cases in push-down logic may need refinement
- Some validation edge cases identified during testing

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (398 tests)
- [x] TypeScript compiles without errors
- [x] Lint passes
- [x] Documentation updated
- [x] Merged to ux-ui-development branch

---

## Release Notes Draft

```markdown
## v0.3.14 – Drop Handling

**Release Date:** 2025-12-16

### Summary

Drop handling for drag and drop operations. Creates assignments on valid drops with optimistic UI update. Implements tile push-down for capacity-1 stations.

### What's New

- Assignment creation on valid drop
- End time calculation based on task duration
- Optimistic UI update (immediate feedback)
- Tile push-down for overlapping drops
- Conflict tracking for Alt-key bypass

### Technical

- updateSnapshot for optimistic updates
- Push-down algorithm for tile insertion
- UUID generation for assignment IDs
```

---

## File Structure

```
apps/web/src/
├── App.tsx                              # Drop handler, assignment creation
├── utils/
│   ├── generateId.ts                    # UUID generation
│   ├── timeCalculations.ts              # End time calculation
│   └── pushDown.ts                      # Push-down logic
├── mock/
│   └── snapshot.ts                      # updateSnapshot function (exists)
```
