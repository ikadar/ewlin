# Release v0.3.38 – Group Capacity Visualization

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Release Date:** 2025-12-23
>
> **Git Tag:** `v0.3.38`
>
> **Branch:** `ux-ui-development`

---

## Overview

Implement visual feedback for station group capacity limits. Users should be able to see when group capacity is exceeded and receive appropriate visual feedback during drag operations.

---

## Prerequisites

- [x] `v0.3.37` released (Multi-Day Grid Navigation)
- [x] `validateGroupCapacity` validator exists in `@flux/schedule-validator`
- [x] `StationGroup.maxConcurrent` type defined in `@flux/types`
- [x] Station groups with capacity limits defined in mock data

---

## Scope

### In Scope

**REQ-18: Machine Group Capacity Limits Visualization**

1. **Station Header - Group Info**
   - Show group name below station name
   - Show capacity usage: "(active/max)" format, e.g., "(2/3)"
   - Skip display for unlimited capacity groups

2. **Tile - Conflict Glow**
   - Red/amber glow on tiles in overloaded groups (`GroupCapacityConflict`)
   - Extend existing `hasConflict` prop to support group capacity conflicts

3. **Drag Validation - Visual Feedback**
   - Show red ring when drop would exceed group capacity
   - Extend `useDropValidation` to expose `hasGroupCapacityConflict`

4. **Grid - Capacity Exceeded Indicator** (simplified)
   - Time slots where capacity is exceeded show subtle indicator
   - Hover tooltip: "Group capacity exceeded: 4/3"

### Out of Scope

- Real-time capacity utilization display (animated)
- Station header capacity changes during drag
- Capacity percentage thresholds (50%, 75% warnings)

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Refactored Requirements](../ux-ui/tmp/refactored-new-requirements-en.md) | REQ-18 |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-GROUP-002, BR-SCHED-002 |

### Existing Components

| Component | File | Current State |
|-----------|------|---------------|
| StationHeader | `src/components/StationHeaders/StationHeader.tsx` | Now shows group info |
| Tile | `src/components/Tile/Tile.tsx` | `hasConflict` for precedence and group |
| useDropValidation | `src/hooks/useDropValidation.ts` | Returns hasGroupCapacityConflict |
| validateGroupCapacity | `packages/validator/src/validators/group.ts` | Fully implemented |

---

## Technical Notes

### Group Capacity Detection

The validator already returns `GroupCapacityConflict`:
```typescript
{
  type: 'GroupCapacityConflict',
  message: 'Group "Presses Offset" capacity (2) would be exceeded',
  taskId: proposed.taskId,
  targetId: proposed.targetId,
  details: {
    groupId: group.id,
    groupName: group.name,
    maxAllowed: 2,
    wouldBe: 3,
  },
}
```

### Mock Data Groups

| Group | maxConcurrent | Stations |
|-------|---------------|----------|
| Presses Offset | 2 | Komori G40, Heidelberg SM, Komori LS29 |
| Impression Numérique | 2 | Xerox Versant, HP Indigo |
| Massicots | 2 | Polar 137, Massicot Ideal |
| Finition | 3 | Stahl TH82, Muller Martini, Horizon BQ-270 |
| Provider groups | null | Unlimited |

### Station Header Group Info Display

```
┌─────────────────────────────────────┐
│ Komori G40                    [⊕]   │
│ Presses Offset (1/2)                │  ← Group name + capacity
└─────────────────────────────────────┘
```

When capacity exceeded:
```
┌─────────────────────────────────────┐
│ Komori G40                    [⊕]   │
│ Presses Offset (3/2) ⚠️             │  ← Red text + warning icon
└─────────────────────────────────────┘
```

### Conflict Visualization

Extend the `conflicts` array check in `SchedulingGrid.tsx`:
```typescript
const conflictTaskIds = useMemo(() => {
  const taskIds = new Set<string>();
  conflicts.forEach((conflict) => {
    if (conflict.type === 'PrecedenceConflict' && conflict.taskId) {
      taskIds.add(conflict.taskId);
    }
    // NEW: Include group capacity conflicts
    if (conflict.type === 'GroupCapacityConflict' && conflict.taskId) {
      taskIds.add(conflict.taskId);
    }
  });
  return taskIds;
}, [conflicts]);
```

---

## Feature Checklist

### Station Header Group Info

- [x] **Extend StationHeaderProps**
  - Description: Add `GroupCapacityInfo` interface with groupId, groupName, maxConcurrent, currentUsage
  - Files: `StationHeader.tsx`
  - Tests: Unit tests (15 tests)

- [x] **Display group info in header**
  - Description: Show group name and "(current/max)" below station name
  - Files: `StationHeader.tsx`
  - Tests: Unit tests

- [x] **Calculate current group usage**
  - Description: New `groupCapacity.ts` utility with `calculateGroupUsageAtTime` and `buildGroupCapacityMap`
  - Files: `src/utils/groupCapacity.ts`
  - Tests: Unit tests (15 tests)

- [x] **Pass group info to StationHeader**
  - Description: Wire up group props from SchedulingGrid
  - Files: `SchedulingGrid.tsx`, `App.tsx`
  - Tests: Integration tests

### Conflict Glow on Tiles

- [x] **Extend conflict detection for GroupCapacityConflict**
  - Description: Include `GroupCapacityConflict` in conflict task IDs set
  - Files: `SchedulingGrid.tsx`
  - Tests: Unit tests

- [x] **Record GroupCapacityConflict on drop**
  - Description: When drop exceeds capacity, record conflict in snapshot
  - Files: `App.tsx`
  - Tests: Unit tests

### Drag Validation Feedback

- [x] **Expose hasGroupCapacityConflict in useDropValidation**
  - Description: Add `hasGroupCapacityConflict` to result
  - Files: `useDropValidation.ts`
  - Tests: Unit tests

- [x] **Show red ring for capacity conflict during drag**
  - Description: Extend validation state to handle capacity conflicts
  - Files: `SchedulingGrid.tsx`, `StationColumn.tsx`
  - Tests: E2E tests

---

## Testing Requirements

### Unit Tests

- [x] StationHeader renders group info correctly
- [x] StationHeader shows warning style when capacity exceeded
- [x] Group usage calculation utility works correctly
- [x] useDropValidation returns hasGroupCapacityConflict
- [x] Conflict detection includes GroupCapacityConflict

### E2E Tests

- [x] Station header shows group name and capacity
- [x] Drag to capacity-exceeding position shows red ring
- [x] Drop that exceeds capacity records conflict
- [x] Tiles in overloaded group show conflict glow

### Manual Testing

- [x] Group info visible in station headers
- [x] Capacity usage updates as tiles are added/removed
- [x] Red ring appears when dragging to full capacity group
- [x] Conflict glow visible on tiles in overloaded groups

---

## Manual QA Test Plan

### Test Fixtures

| Fixture | URL | Purpose |
|---------|-----|---------|
| `test` | `http://localhost:5173/?fixture=test` | Default test data with multiple groups |

### Test Scenarios

#### Scenario 1: Station Header Group Info

**Steps:**
1. Load the application
2. Look at station headers

**Expected Results:**
- [x] Each station header shows group name below station name
- [x] Capacity display shows "(current/max)" format
- [x] Provider stations (if any) don't show capacity

#### Scenario 2: Capacity Exceeded Warning

**Steps:**
1. Ensure a group has multiple scheduled tasks (reaching capacity)
2. Schedule another task to exceed capacity
3. Look at station headers for that group

**Expected Results:**
- [x] Capacity text turns red when exceeded
- [x] Warning icon appears next to capacity

#### Scenario 3: Drag Validation

**Steps:**
1. Select a job with unscheduled tasks
2. Drag a task to a station whose group is at capacity
3. Observe the visual feedback

**Expected Results:**
- [x] Red ring appears on the station column
- [x] Cannot see green valid indicator

#### Scenario 4: Conflict Glow

**Steps:**
1. Force-drop a task that exceeds group capacity (if possible)
2. Observe the tile appearance

**Expected Results:**
- [x] Tile has amber/red glow
- [x] Job appears in Problems section

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (565 total, 30 new for v0.3.38)
- [x] All E2E tests passing (7 new for v0.3.38)
- [x] Manual testing completed
- [x] Code reviewed and approved (PR #11)
- [x] Documentation updated (roadmap)
- [x] Git tag created: `v0.3.38`

---

## Release Notes Draft

```markdown
## v0.3.38 – Group Capacity Visualization

**Release Date:** 2025-12-23

### Summary

Add visual feedback for station group capacity limits. Users can now see group information
in station headers and receive visual feedback when attempting to exceed capacity.

### What's New

- **Station Header Group Info:** Group name and capacity (e.g., "Offset Press (2/3)")
- **Capacity Warning:** Red text and icon when group capacity is exceeded
- **Drag Validation:** Red ring when drop would exceed group capacity
- **Conflict Glow:** Amber/red glow on tiles in overloaded groups

### Technical Details

- REQ-18: Machine Group Capacity Limits Visualization
- Extends existing `GroupCapacityConflict` validation
- Integrates with existing conflict visualization system
```

---

## Post-Release

- [x] GitHub release created (PR #11 merged)
- [x] Roadmap updated
- [x] Release document status updated
