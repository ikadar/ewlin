# Release v0.2.11 – Assignment API Endpoints

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Release Date:** 2025-12-14
>
> **Git Tag:** `v0.2.11`

---

## Overview

This release introduces the Assignment API endpoints that allow tasks to be assigned to stations or providers. The PHP API will integrate with the Validation Service (Node.js) to validate assignments before persisting them. This is a critical piece of the scheduling system, connecting the domain model to the isomorphic validation layer.

Key deliverables:
- POST /api/v1/tasks/{taskId}/assign endpoint
- Validation Service HTTP client
- AssignmentService for orchestrating validation and persistence
- Error handling for validation failures (conflicts)
- Task status transition (Ready → Assigned)

---

## Prerequisites

- [x] `v0.2.10` released (Schedule Aggregate)
- [x] `v0.2.9` released (Validation Service Docker)
- [x] Schedule entity with TaskAssignment value object
- [x] Validation Service POST /validate endpoint working

---

## Scope

### In Scope

- POST /api/v1/tasks/{taskId}/assign endpoint
- AssignmentService with validation integration
- ValidationServiceClient HTTP client
- AssignTaskRequest DTO with validation
- AssignmentResponse DTO
- Task status update to 'Assigned' on success
- Error responses for validation failures
- Unit tests for service layer
- Integration tests for API endpoint

### Out of Scope

- End time calculation with operating schedule stretching (v0.2.12)
- Unassign (recall) endpoint (v0.2.13)
- Reschedule endpoint (v0.2.14)
- Schedule snapshot endpoint (v0.2.15)

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | Schedule, TaskAssignment |
| [Business Rules](../domain-model/business-rules.md) | BR-ASSIGN-001 to BR-ASSIGN-009, BR-SCHED-001 to BR-SCHED-007 |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |
| [Aggregate Design](../architecture/aggregate-design.md) | Schedule Aggregate section |

---

## Technical Notes

### API Design

```
POST /api/v1/tasks/{taskId}/assign
Content-Type: application/json

Request Body:
{
  "targetId": "station-uuid-or-provider-uuid",
  "scheduledStart": "2025-01-15T08:00:00+00:00",
  "bypassPrecedence": false  // Optional, for Alt-key bypass
}

Response (201 Created):
{
  "taskId": "task-uuid",
  "targetId": "station-uuid",
  "isOutsourced": false,
  "scheduledStart": "2025-01-15T08:00:00+00:00",
  "scheduledEnd": "2025-01-15T10:00:00+00:00",  // Calculated
  "isCompleted": false,
  "completedAt": null
}

Response (409 Conflict):
{
  "error": "ValidationFailed",
  "message": "Assignment validation failed",
  "conflicts": [
    {
      "type": "StationConflict",
      "message": "Station is already booked at this time",
      "taskId": "task-uuid",
      "relatedTaskId": "other-task-uuid",
      "targetId": "station-uuid"
    }
  ]
}
```

### Validation Service Integration

The PHP API will call the Validation Service via HTTP:

```php
class ValidationServiceClient
{
    public function __construct(
        private readonly HttpClientInterface $httpClient,
        private readonly string $validationServiceUrl,
    ) {}

    public function validate(
        ProposedAssignment $proposed,
        ScheduleSnapshot $snapshot,
    ): ValidationResult {
        $response = $this->httpClient->request('POST', $this->validationServiceUrl . '/validate', [
            'json' => [
                'proposed' => $proposed->toArray(),
                'snapshot' => $snapshot->toArray(),
            ],
        ]);

        return ValidationResult::fromArray($response->toArray());
    }
}
```

### ScheduleSnapshot Building

For MVP, we'll build a minimal snapshot with:
- The target station/provider
- The task being assigned
- The job containing the task
- Existing assignments on the target
- Other tasks in the same job (for precedence)

Full snapshot endpoint (v0.2.15) will provide complete data.

### Business Rules Enforced

| Rule | Enforcement |
|------|-------------|
| BR-ASSIGN-001 | Station must exist and be Available |
| BR-SCHED-001 | No station double-booking (Validation Service) |
| BR-SCHED-003 | Task sequence enforcement (Validation Service) |
| BR-SCHED-006 | Approval gate enforcement (Validation Service) |
| BR-SCHED-007 | Schedule version increments |

### Configuration

```yaml
# services/php-api/config/services.yaml
parameters:
    validation_service_url: '%env(VALIDATION_SERVICE_URL)%'

# .env
VALIDATION_SERVICE_URL=http://validation-service:3001
```

---

## Feature Checklist

### DTOs

- [x] **AssignTaskRequest DTO**
  - Description: Request DTO for task assignment
  - Files: `src/DTO/Assignment/AssignTaskRequest.php`
  - Tests: Validation tests in integration tests

- [x] **AssignmentResponse DTO**
  - Description: Response DTO for assignment details
  - Files: `src/DTO/Assignment/AssignmentResponse.php`
  - Tests: Unit tests for fromArray/toArray

- [x] **ProposedAssignment DTO**
  - Description: DTO for Validation Service request
  - Files: `src/DTO/Assignment/ProposedAssignment.php`
  - Tests: Unit tests

- [x] **ValidationResult DTO**
  - Description: DTO for Validation Service response
  - Files: `src/DTO/Assignment/ValidationResult.php`
  - Tests: Unit tests

- [x] **ScheduleSnapshot DTO**
  - Description: Minimal snapshot for validation (MVP)
  - Files: `src/DTO/Assignment/ScheduleSnapshot.php`
  - Tests: Unit tests

### Services

- [x] **ValidationServiceClient**
  - Description: HTTP client for Validation Service
  - Files: `src/Service/ValidationServiceClient.php`, `src/Service/ValidationServiceClientInterface.php`
  - Tests: `tests/Unit/Service/ValidationServiceClientTest.php`

- [x] **SnapshotBuilder**
  - Description: Builds minimal schedule snapshot for validation
  - Files: `src/Service/SnapshotBuilder.php`
  - Tests: `tests/Unit/Service/SnapshotBuilderTest.php`

- [x] **AssignmentService**
  - Description: Orchestrates validation and persistence
  - Files: `src/Service/AssignmentService.php`
  - Tests: `tests/Unit/Service/AssignmentServiceTest.php`

### Controller

- [x] **TaskController (assign endpoint)**
  - Description: POST /api/v1/tasks/{taskId}/assign
  - Files: `src/Controller/Api/V1/TaskController.php`
  - Tests: `tests/Integration/Controller/Api/V1/TaskControllerTest.php`

### Exception

- [x] **ValidationFailedException**
  - Description: Exception for validation service failures
  - Files: `src/Exception/ValidationFailedException.php`
  - Tests: Part of integration tests

### Test Infrastructure

- [x] **HttpMockConfigurator**
  - Description: Static HTTP mock configuration for integration tests
  - Files: `src/Test/HttpMockConfigurator.php`

- [x] **MockHttpClientFactory**
  - Description: Factory creating MockHttpClient from HttpMockConfigurator
  - Files: `src/Test/MockHttpClientFactory.php`

---

## Testing Requirements

### Unit Tests

- [x] AssignTaskRequest validation
- [x] AssignmentResponse serialization
- [x] ProposedAssignment building
- [x] ValidationResult parsing
- [x] ValidationServiceClient HTTP handling
- [x] SnapshotBuilder data aggregation
- [x] AssignmentService orchestration logic

### Integration Tests

- [x] POST /api/v1/tasks/{taskId}/assign - successful assignment
- [x] POST /api/v1/tasks/{taskId}/assign - task not found (404)
- [x] POST /api/v1/tasks/{taskId}/assign - station not found (404)
- [x] POST /api/v1/tasks/{taskId}/assign - validation conflict (409)
- [x] POST /api/v1/tasks/{taskId}/assign - task already assigned (409)
- [x] POST /api/v1/tasks/{taskId}/assign - task not in Ready status (400)
- [x] Task status changes from Ready to Assigned

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.11`

---

## Release Notes Draft

```markdown
## v0.2.11 – Assignment API Endpoints

**Release Date:** 2025-12-14

### Summary

Introduces the Assignment API endpoint that allows tasks to be assigned to stations or providers with integrated validation via the Validation Service.

### What's New

- POST /api/v1/tasks/{taskId}/assign endpoint
- Validation Service integration (HTTP client)
- Assignment persistence on validation success
- Conflict response (409) with detailed validation errors
- Task status transition (Ready → Assigned)

### API Usage

```bash
# Assign a task to a station
curl -X POST http://localhost:8080/api/v1/tasks/{taskId}/assign \
  -H "Content-Type: application/json" \
  -d '{
    "targetId": "station-uuid",
    "scheduledStart": "2025-01-15T08:00:00+00:00"
  }'
```

### Technical

- ValidationServiceClient for HTTP communication
- ValidationServiceClientInterface for testability
- SnapshotBuilder for minimal snapshot creation
- AssignmentService orchestration layer
- HttpMockConfigurator for integration test HTTP mocking
- PHPStan level 8 compliant
- 983 tests, 2733 assertions
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo updated
- [ ] Validation Service tested end-to-end
- [ ] Next release (v0.2.12 - End Time Calculation) ready to start
