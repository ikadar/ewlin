# Release v0.1.16 – Job Dependencies

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP - Job Management)
>
> **Release Date:** 2025-12-14
>
> **Git Tag:** `v0.1.16`

---

## Overview

This release adds job-to-job dependencies, enabling finish-to-start relationships between jobs. A job can depend on one or more other jobs, meaning its first task cannot be scheduled until all required jobs are completed.

Key features:
- Job dependencies (requiredJobIds) stored on the Job entity
- Circular dependency detection to prevent invalid dependency graphs
- API endpoints for managing and listing dependencies

---

## Prerequisites

- [x] `v0.1.15` released (Paper Procurement)

---

## Scope

### In Scope

- `requiredJobIds` field on Job entity (JSON array of job IDs)
- POST /api/v1/jobs/{id}/dependencies endpoint (add/set dependencies)
- GET /api/v1/jobs/{id}/dependencies endpoint (list dependencies)
- DELETE /api/v1/jobs/{id}/dependencies/{requiredJobId} endpoint (remove single dependency)
- Circular dependency detection (BR-JOB-008)
- Validation that required jobs exist (BR-JOB-007)

### Out of Scope

- Color shading for dependent jobs (BR-JOB-009 - future enhancement)
- Scheduling enforcement (BR-SCHED-004 - will be in M2)
- Cascading operations (e.g., cancelling dependent jobs)

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-JOB-006, BR-JOB-007, BR-JOB-008, BR-SCHED-004 |

---

## Technical Notes

### Dependency Storage

Dependencies are stored as a JSON array of job IDs on the Job entity:
```php
#[ORM\Column(type: 'json')]
private array $requiredJobIds = [];
```

### Circular Dependency Detection

Algorithm: Before adding a dependency A → B (A requires B), check if B already has a path to A (directly or transitively). This is done using a DFS traversal.

### API Design

**POST /api/v1/jobs/{id}/dependencies**
- Request body: `{ "requiredJobIds": ["job-id-1", "job-id-2"] }`
- Replaces all existing dependencies (idempotent set operation)
- Returns 400 if any job ID doesn't exist or creates a cycle

**GET /api/v1/jobs/{id}/dependencies**
- Returns list of required jobs with minimal info (id, reference, client, status)

**DELETE /api/v1/jobs/{id}/dependencies/{requiredJobId}**
- Removes a single dependency
- Returns 404 if dependency doesn't exist

---

## Feature Checklist

### Entity Changes

- [x] **Add requiredJobIds field to Job entity**
  - Description: JSON array storing IDs of jobs this job depends on
  - Files: `src/Entity/Job.php`
  - Migration: `migrations/Version20251214040000.php`

- [x] **Add dependency management methods to Job**
  - Description: addRequiredJob(), removeRequiredJob(), getRequiredJobIds(), hasRequiredJob()
  - Files: `src/Entity/Job.php`

### Service Layer

- [x] **Create DependencyService**
  - Description: Service for managing job dependencies with validation
  - Files: `src/Service/DependencyService.php`

- [x] **Circular dependency detection**
  - Description: Prevent cycles in job dependency graph (BR-JOB-008)
  - Files: `src/Service/DependencyService.php`

### DTOs

- [x] **Create SetDependenciesRequest DTO**
  - Description: Request body for POST /dependencies endpoint
  - Files: `src/DTO/Job/SetDependenciesRequest.php`

- [x] **Create DependencyResponse DTO**
  - Description: Response format for dependency listing
  - Files: `src/DTO/Job/DependencyResponse.php`

- [x] **Update JobResponse DTO**
  - Description: Add requiredJobIds field to job responses
  - Files: `src/DTO/Job/JobResponse.php`

### API Endpoints

- [x] **POST /api/v1/jobs/{id}/dependencies**
  - Description: Set all dependencies for a job
  - Files: `src/Controller/Api/V1/JobController.php`

- [x] **GET /api/v1/jobs/{id}/dependencies**
  - Description: List dependencies with job details
  - Files: `src/Controller/Api/V1/JobController.php`

- [x] **DELETE /api/v1/jobs/{id}/dependencies/{requiredJobId}**
  - Description: Remove a single dependency
  - Files: `src/Controller/Api/V1/JobController.php`

---

## Testing Requirements

### Unit Tests

- [x] Job entity: addRequiredJob(), removeRequiredJob(), getRequiredJobIds()
- [x] Job entity: hasRequiredJob() lookup
- [x] Job entity: dependency array is deduplicated
- [x] DependencyService: setDependencies() validation
- [x] DependencyService: circular dependency detection (direct cycle)
- [x] DependencyService: circular dependency detection (transitive cycle)
- [x] DependencyService: non-existent job validation (BR-JOB-007)

### Integration Tests

- [x] POST /dependencies - set dependencies success
- [x] POST /dependencies - empty array clears dependencies
- [x] POST /dependencies - 404 when job not found
- [x] POST /dependencies - 400 when required job not found
- [x] POST /dependencies - 400 when circular dependency detected
- [x] GET /dependencies - list dependencies with job details
- [x] GET /dependencies - 404 when job not found
- [x] DELETE /dependencies/{id} - remove dependency success
- [x] DELETE /dependencies/{id} - 404 when job not found
- [x] DELETE /dependencies/{id} - 404 when dependency not found
- [x] JobResponse includes requiredJobIds

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (796 tests, 2082 assertions)
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.16`

---

## Release Notes Draft

```markdown
## v0.1.16 – Job Dependencies

**Release Date:** 2025-12-14

### Summary

Adds job-to-job dependency support, enabling finish-to-start relationships between jobs. A job can require other jobs to be completed before its tasks can be scheduled.

### What's New

- Job dependencies via `requiredJobIds` field
- POST /api/v1/jobs/{id}/dependencies - set job dependencies
- GET /api/v1/jobs/{id}/dependencies - list dependencies with job details
- DELETE /api/v1/jobs/{id}/dependencies/{requiredJobId} - remove dependency
- Circular dependency detection (BR-JOB-008)
- Required job existence validation (BR-JOB-007)

### Business Rules Implemented

- BR-JOB-006: Job dependencies are finish-to-start only
- BR-JOB-007: Required jobs must exist
- BR-JOB-008: No circular job dependencies
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo docs committed
- [x] CI verified
