# Release v0.2.13 – Unassign (Recall) Task

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Release Date:** 2025-12-14
>
> **Git Tag:** `v0.2.13`

---

## Overview

This release implements the ability to unassign (recall) a task from the schedule. When a task is unassigned, it is removed from the schedule and its status is reverted to "Ready", allowing it to be rescheduled.

Key deliverables:
- DELETE /api/v1/tasks/{taskId}/assign endpoint
- Task status transition: Assigned → Ready
- Schedule.unassignTask() already exists (v0.2.10)
- TaskUnassigned event already exists (v0.2.10)
- UnassignmentService for orchestrating the unassign flow

---

## Prerequisites

- [x] `v0.2.12` released (End Time Calculation)
- [x] Schedule entity with unassignTask() method
- [x] TaskUnassigned domain event
- [x] Task entity with status transitions

---

## Scope

### In Scope

- DELETE /api/v1/tasks/{taskId}/assign endpoint
- UnassignmentService for business logic orchestration
- Task.markUnassigned() method for Assigned → Ready transition
- Integration with existing Schedule.unassignTask()
- Proper error handling (task not assigned, task not found)
- Unit tests for service logic
- Integration tests for endpoint

### Out of Scope

- Batch unassignment (multiple tasks at once)
- Unassign with reason/comment
- Cascading unassignment (dependent tasks)
- Undo/redo functionality

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-007 (version increment) |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |

---

## Technical Notes

### Endpoint Design

```
DELETE /api/v1/tasks/{taskId}/assign

Response 200 OK:
{
  "taskId": "uuid",
  "status": "ready",
  "message": "Task unassigned successfully"
}

Response 404 Not Found:
{
  "error": "Task not found: {taskId}"
}

Response 400 Bad Request:
{
  "error": "Task is not assigned"
}
```

### Task Status Transition

The Task entity needs a new method to handle unassignment:

```php
public function markUnassigned(): void
{
    if ($this->status !== TaskStatus::Assigned) {
        throw new \InvalidArgumentException(
            sprintf('Cannot unassign task in "%s" status. Task must be in "assigned" status.', $this->status->value)
        );
    }
    $this->changeStatus(TaskStatus::Ready);
}
```

### Service Flow

1. Find task by ID (404 if not found)
2. Check task status is "Assigned" (400 if not)
3. Get current schedule
4. Call schedule.unassignTask(taskId)
5. Call task.markUnassigned()
6. Persist changes
7. Return success response

---

## Feature Checklist

### Services

- [x] **UnassignmentService**
  - Description: Service for orchestrating task unassignment
  - Files: `src/Service/UnassignmentService.php`
  - Tests: `tests/Unit/Service/UnassignmentServiceTest.php`
  - Methods:
    - `unassignTask(string $taskId): void`

### Entity Updates

- [x] **Task.markUnassigned()**
  - Description: Method for Assigned → Ready status transition
  - Files: `src/Entity/Task.php` (modify)
  - Tests: `tests/Unit/Entity/TaskTest.php` (add tests)

### Controller

- [x] **TaskController::unassign()**
  - Description: DELETE endpoint for unassigning tasks
  - Files: `src/Controller/Api/V1/TaskController.php` (modify)
  - Tests: `tests/Integration/Controller/Api/V1/TaskControllerTest.php` (add tests)

### DTOs

- [x] **UnassignmentResponse**
  - Description: Response DTO for unassign endpoint
  - Files: `src/DTO/Assignment/UnassignmentResponse.php`

---

## Testing Requirements

### Unit Tests

- [x] UnassignmentService - successful unassignment
- [x] UnassignmentService - task not found
- [x] UnassignmentService - task not assigned (wrong status)
- [x] UnassignmentService - no schedule exists
- [x] UnassignmentService - task not in schedule
- [x] UnassignmentService - verifies schedule version incremented
- [x] Task.markUnassigned() - from Assigned status
- [x] Task.markUnassigned() - from Ready status (should fail)
- [x] Task.markUnassigned() - from Defined status (should fail)
- [x] Task.markUnassigned() - from Completed status (should fail)
- [x] Task.markUnassigned() - from Cancelled status (should fail)

### Integration Tests

- [x] DELETE /api/v1/tasks/{taskId}/assign - success
- [x] DELETE /api/v1/tasks/{taskId}/assign - task not found (404)
- [x] DELETE /api/v1/tasks/{taskId}/assign - task not assigned (400)
- [x] DELETE /api/v1/tasks/{taskId}/assign - verifies task status is Ready after
- [x] DELETE /api/v1/tasks/{taskId}/assign - verifies schedule version incremented

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (1044 tests, 2846 assertions)
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.13`

---

## Release Notes Draft

```markdown
## v0.2.13 – Unassign (Recall) Task

**Release Date:** 2025-12-14

### Summary

Implements the ability to unassign (recall) a task from the schedule, reverting it to "Ready" status for rescheduling.

### What's New

- **DELETE /api/v1/tasks/{taskId}/assign** - Endpoint for unassigning tasks
- **Task.markUnassigned()** - Status transition from Assigned → Ready
- **UnassignmentService** - Business logic orchestration

### Technical

- Leverages existing Schedule.unassignTask() and TaskUnassigned event
- BR-SCHED-007: Schedule version increments on unassignment
- PHPStan level 8 compliant
- 1044 total tests passing
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo updated
- [ ] Next release (v0.2.14 - Reschedule Task) ready to start
