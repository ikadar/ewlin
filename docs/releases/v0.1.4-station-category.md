# Release v0.1.4 – Station Category Entity

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Target Date:** 2025-12-12
>
> **Git Tag:** `v0.1.4`

---

## Overview

This release implements the full **StationCategory** entity with similarity criteria support. Station categories classify stations by type of work (e.g., "Offset Printing Press", "Finishing") and define similarity criteria used for visual indicators between consecutive tiles in the scheduling UI.

### Why This Matters

- **Station classification**: Group stations by function/capability
- **Similarity indicators**: Visual feedback showing matching attributes between consecutive jobs
- **Time savings**: Operators can see which jobs share characteristics (same paper, inking, etc.)
- **Required for stations**: Every station must belong to a category (BR-STATION-002)

---

## Prerequisites

- [x] `v0.1.3` released (Schedule Exceptions)
- [x] StationCategory stub entity exists with id/name fields
- [x] Station entity references categoryId

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| StationCategory entity expansion | Add similarity criteria, timestamps, description |
| SimilarityCriterion value object | Code, name, fieldPath for comparison |
| POST /api/v1/station-categories | Create category with criteria |
| GET /api/v1/station-categories | List all categories |
| GET /api/v1/station-categories/{id} | Get category details |
| PUT /api/v1/station-categories/{id} | Update category |
| DELETE /api/v1/station-categories/{id} | Delete category |
| Unique criteria codes validation | BR-CATEGORY-002 |
| Unit tests | Entity and value object tests |
| Integration tests | API endpoint tests |

### Out of Scope

| Item | Reason |
|------|--------|
| Similarity calculation | Covered in Scheduling View (M2/M3) |
| UI category editor | Covered in M3 (Frontend) |
| Category-based station filtering | Enhancement for later |

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-CATEGORY-001, BR-CATEGORY-002, BR-STATION-002 |
| [Domain Model](../domain-model/domain-model.md) | StationCategory, SimilarityCriterion |

### API

| Document | Sections |
|----------|----------|
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 2: Station Category API |

---

## Domain Model Reference

### StationCategory Structure

```
┌─────────────────────────────────────────────────────────────┐
│                    StationCategory                           │
├─────────────────────────────────────────────────────────────┤
│  id: string (UUID)                                          │
│  name: string (max 100)                                     │
│  description: string|null                                   │
│  similarityCriteria: SimilarityCriterion[]                  │
│  createdAt: datetime                                        │
│  updatedAt: datetime                                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  SimilarityCriterion                         │
├─────────────────────────────────────────────────────────────┤
│  code: string (unique within category)                      │
│  name: string (display name)                                │
│  fieldPath: string (job field for comparison)               │
└─────────────────────────────────────────────────────────────┘
```

### Example Category

```json
{
  "id": "cat-offset-press",
  "name": "Offset Printing Press",
  "description": "Large format offset presses for high-volume printing",
  "similarityCriteria": [
    {"code": "paper_type", "name": "Same paper type", "fieldPath": "paperType"},
    {"code": "paper_size", "name": "Same paper size", "fieldPath": "paperSize"},
    {"code": "paper_weight", "name": "Same paper weight", "fieldPath": "paperWeight"},
    {"code": "inking", "name": "Same inking", "fieldPath": "inkingType"}
  ],
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

---

## Business Rules

| Rule ID | Description | Enforcement |
|---------|-------------|-------------|
| **BR-CATEGORY-001** | Category should have similarity criteria | Soft validation (warning if empty) |
| **BR-CATEGORY-002** | Criteria codes must be unique within category | Entity validation |
| **BR-STATION-002** | Station must belong to a category | Station entity validation |

---

## API Design

### POST /api/v1/station-categories

Create a station category.

**Request:**
```json
{
  "name": "Offset Printing Press",
  "description": "Large format offset presses",
  "similarityCriteria": [
    {"code": "paper_type", "name": "Same paper type", "fieldPath": "paperType"},
    {"code": "paper_size", "name": "Same paper size", "fieldPath": "paperSize"}
  ]
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "name": "Offset Printing Press",
  "description": "Large format offset presses",
  "similarityCriteria": [...],
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

**Error Response (400) - Duplicate Code:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Duplicate similarity criterion code",
    "details": {
      "code": "paper_type"
    }
  }
}
```

### GET /api/v1/station-categories

List all categories.

**Query Parameters:**
- `search` (optional): Search by name

**Response (200):**
```json
{
  "data": [...],
  "total": 5
}
```

### GET /api/v1/station-categories/{id}

Get category by ID.

**Response (200):** Category object

**Response (404):** Category not found

### PUT /api/v1/station-categories/{id}

Update category.

**Request:**
```json
{
  "name": "Updated Name",
  "description": "Updated description",
  "similarityCriteria": [...]
}
```

### DELETE /api/v1/station-categories/{id}

Delete category.

**Response (204):** No content

**Response (409):** Category in use by stations

---

## Value Object Design

### SimilarityCriterion

```php
namespace App\ValueObject;

final readonly class SimilarityCriterion implements \JsonSerializable
{
    public function __construct(
        public string $code,
        public string $name,
        public string $fieldPath,
    ) {
        $this->validateCode($code);
        $this->validateName($name);
        $this->validateFieldPath($fieldPath);
    }

    public function jsonSerialize(): array
    {
        return [
            'code' => $this->code,
            'name' => $this->name,
            'fieldPath' => $this->fieldPath,
        ];
    }

    public static function fromArray(array $data): self
    {
        return new self(
            code: $data['code'],
            name: $data['name'],
            fieldPath: $data['fieldPath'],
        );
    }

    private function validateCode(string $code): void
    {
        if (trim($code) === '') {
            throw new \InvalidArgumentException('Criterion code cannot be empty.');
        }
        if (!preg_match('/^[a-z][a-z0-9_]*$/', $code)) {
            throw new \InvalidArgumentException(
                "Invalid code format: {$code}. Must be lowercase with underscores."
            );
        }
    }

    private function validateName(string $name): void
    {
        if (trim($name) === '') {
            throw new \InvalidArgumentException('Criterion name cannot be empty.');
        }
    }

    private function validateFieldPath(string $fieldPath): void
    {
        if (trim($fieldPath) === '') {
            throw new \InvalidArgumentException('Criterion fieldPath cannot be empty.');
        }
    }
}
```

---

## File Structure

```
services/php-api/
├── src/
│   ├── ValueObject/
│   │   └── SimilarityCriterion.php        # Similarity criterion value object
│   ├── DTO/
│   │   └── StationCategory/
│   │       ├── CreateCategoryRequest.php   # Create request DTO
│   │       ├── UpdateCategoryRequest.php   # Update request DTO
│   │       └── CategoryResponse.php        # Response DTO
│   ├── Controller/
│   │   └── Api/V1/
│   │       └── StationCategoryController.php
│   ├── Entity/
│   │   └── StationCategory.php             # Expand existing stub
│   ├── Repository/
│   │   └── StationCategoryRepository.php   # Expand existing stub
│   └── Service/
│       └── StationCategoryService.php      # New service
└── tests/
    ├── Unit/
    │   ├── ValueObject/
    │   │   └── SimilarityCriterionTest.php
    │   └── Entity/
    │       └── StationCategoryTest.php
    └── Integration/
        └── Controller/Api/V1/
            └── StationCategoryControllerTest.php
```

---

## Database Changes

Update `station_categories` table:

```sql
ALTER TABLE station_categories
    ADD COLUMN description VARCHAR(500) DEFAULT NULL,
    ADD COLUMN similarity_criteria JSON DEFAULT NULL,
    ADD COLUMN created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ADD COLUMN updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;
```

Migration file: `migrations/Version20251212110000.php`

---

## Feature Checklist

### Value Objects

- [x] **Create SimilarityCriterion value object**
  - File: `src/ValueObject/SimilarityCriterion.php`
  - Validation: code format, non-empty fields
  - Tests: `tests/Unit/ValueObject/SimilarityCriterionTest.php`

### Entity Update

- [x] **Expand StationCategory entity**
  - File: `src/Entity/StationCategory.php`
  - Add: description, similarityCriteria (JSON), timestamps
  - Methods: `addCriterion()`, `removeCriterion()`, `hasCriterionCode()`
  - Validation: unique criterion codes (BR-CATEGORY-002)
  - Tests: `tests/Unit/Entity/StationCategoryTest.php`

### Repository Update

- [x] **Expand StationCategoryRepository**
  - File: `src/Repository/StationCategoryRepository.php`
  - Methods: `findAllWithSearch()`, `isNameUnique()`, `isInUse()`

### Database Migration

- [x] **Create migration for expanded fields**
  - File: `migrations/Version20251212110000.php`

### DTO Layer

- [x] **Create CategoryRequest DTOs**
  - Files: `src/DTO/StationCategory/*.php`
  - CreateCategoryRequest, UpdateCategoryRequest, CategoryResponse

### Service Layer

- [x] **Create StationCategoryService**
  - File: `src/Service/StationCategoryService.php`
  - Methods: `create()`, `update()`, `delete()`, `findById()`, `findAll()`

### Controller Layer

- [x] **Create StationCategoryController**
  - File: `src/Controller/Api/V1/StationCategoryController.php`
  - Routes: POST, GET (list), GET (single), PUT, DELETE
  - OpenAPI documentation

### Testing

- [x] **Unit tests**
  - SimilarityCriterion: validation, serialization (20 tests)
  - StationCategory: criterion management, validation (33 tests)

- [x] **Integration tests**
  - Create category with criteria
  - List categories
  - Get single category
  - Update category
  - Delete category
  - Duplicate code validation
  - Delete in-use category
  - (30 tests total)

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `SimilarityCriterionTest` | Valid criterion creation |
| | Empty code rejected |
| | Invalid code format rejected |
| | Empty name rejected |
| | Empty fieldPath rejected |
| | JSON serialization |
| | fromArray() works |
| `StationCategoryTest` | Valid category creation |
| | Add similarity criterion |
| | Duplicate criterion code rejected |
| | Remove criterion |
| | Name validation |
| | Description is optional |

### Integration Tests

| Test Class | Test Cases |
|------------|------------|
| `StationCategoryControllerTest` | Create category (201) |
| | Create with criteria (201) |
| | Create duplicate name (409) |
| | List categories (200) |
| | List with search (200) |
| | Get category (200) |
| | Get not found (404) |
| | Update category (200) |
| | Update with duplicate criteria code (400) |
| | Delete category (204) |
| | Delete in-use category (409) |

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (276 tests, 704 assertions)
- [x] All integration tests passing
- [x] OpenAPI documentation updated
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 8)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.4`

---

## Release Notes Draft

```markdown
## v0.1.4 – Station Category Entity

**Release Date:** 2025-12-12

### Summary

Expands the StationCategory entity with full CRUD support and similarity
criteria management. Categories classify stations by type and define
criteria for visual similarity indicators between consecutive jobs.

### What's New

- **SimilarityCriterion value object** - Code, name, fieldPath for job comparison
- **StationCategory entity expansion** - Description, similarity criteria, timestamps
- **POST /api/v1/station-categories** - Create category with criteria
- **GET /api/v1/station-categories** - List categories with search
- **GET /api/v1/station-categories/{id}** - Get category details
- **PUT /api/v1/station-categories/{id}** - Update category
- **DELETE /api/v1/station-categories/{id}** - Delete category
- **Unique code validation** - BR-CATEGORY-002 enforcement
- **Unit tests** - Entity and value object tests
- **Integration tests** - API endpoint tests

### API Changes

New endpoints:
- `POST /api/v1/station-categories`
- `GET /api/v1/station-categories`
- `GET /api/v1/station-categories/{id}`
- `PUT /api/v1/station-categories/{id}`
- `DELETE /api/v1/station-categories/{id}`

### Breaking Changes

None

### Migration Guide

Run database migration to add new columns:
```bash
php bin/console doctrine:migrations:migrate
```
```

---

## Post-Release

- [x] GitHub release created with notes
- [x] Verify API documentation updated
- [ ] Test category endpoints via curl/Postman
- [ ] Proceed to v0.1.5 (Station Group Entity)
