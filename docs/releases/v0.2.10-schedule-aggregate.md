# Release v0.2.10 – Schedule Aggregate

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.2.10`

---

## Overview

This release introduces the Schedule aggregate root and TaskAssignment value object - the foundation for task scheduling in the Flux system. The Schedule aggregate manages all task assignments with their timings and maintains consistency.

Key deliverables:
- Schedule entity (aggregate root) with version tracking
- TaskAssignment value object with completion tracking (isCompleted, completedAt)
- ScheduleRepository for persistence
- Database migration for schedules table

---

## Prerequisites

- [x] `v0.2.9` released (Validation Service Docker)
- [x] Job aggregate with Task entities implemented (v0.1.11)
- [x] Station aggregate implemented (v0.1.0 - v0.1.7)
- [x] Domain events infrastructure in place (v0.1.18)

---

## Scope

### In Scope

- Schedule entity as aggregate root
- TaskAssignment value object with all required fields
- ScheduleRepository with basic CRUD operations
- Database migration for schedules table
- Unit tests for entity and value object
- Domain events: ScheduleCreated, TaskAssigned, TaskUnassigned

### Out of Scope

- API endpoints (v0.2.11)
- Validation Service integration (v0.2.11)
- Full conflict detection (post-MVP)
- Schedule branching (post-MVP)

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | Schedule, TaskAssignment |
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-001 to BR-SCHED-007, BR-ASSIGN-001 to BR-ASSIGN-009 |
| [Aggregate Design](../architecture/aggregate-design.md) | AGG-SCHEDULE-001 |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |
| [Aggregate Design](../architecture/aggregate-design.md) | Schedule Aggregate section |

---

## Technical Notes

### Schedule Entity Design

The Schedule entity serves as the aggregate root for all task assignments:

```php
#[ORM\Entity(repositoryClass: ScheduleRepository::class)]
#[ORM\Table(name: 'schedules')]
class Schedule
{
    use RecordsDomainEvents;

    #[ORM\Id]
    #[ORM\Column(type: 'guid')]
    private string $id;

    #[ORM\Column(type: 'integer')]
    private int $version = 1;

    #[ORM\Column(type: 'json')]
    private array $assignments = [];  // TaskAssignment[] serialized

    #[ORM\Column(type: 'datetime_immutable')]
    private \DateTimeImmutable $createdAt;

    #[ORM\Column(type: 'datetime_immutable')]
    private \DateTimeImmutable $updatedAt;
}
```

### TaskAssignment Value Object

Following the Duration value object pattern:

```php
final readonly class TaskAssignment implements \JsonSerializable
{
    public function __construct(
        public string $taskId,           // UUID
        public string $targetId,         // Station or Provider UUID
        public bool $isOutsourced,       // true for provider, false for station
        public string $scheduledStart,   // ISO 8601 datetime
        public ?string $scheduledEnd,    // ISO 8601 datetime (calculated)
        public bool $isCompleted = false,
        public ?\DateTimeImmutable $completedAt = null,
    ) {}
}
```

### Business Rules Implemented

| Rule | Description |
|------|-------------|
| BR-SCHED-007 | Schedule.Version increments on any assignment change |
| BR-ASSIGN-007 | Task completion (isCompleted) is manually toggled |
| BR-ASSIGN-008 | isCompleted flag does not affect precedence validation |

### Database Schema

```sql
CREATE TABLE schedules (
    id VARCHAR(36) NOT NULL,
    version INT NOT NULL DEFAULT 1,
    assignments JSON NOT NULL,
    created_at DATETIME NOT NULL COMMENT '(DC2Type:datetime_immutable)',
    updated_at DATETIME NOT NULL COMMENT '(DC2Type:datetime_immutable)',
    PRIMARY KEY(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## Feature Checklist

### Entity

- [x] **Schedule entity (aggregate root)**
  - Description: Main entity managing task assignments with version tracking
  - Files: `src/Entity/Schedule.php`
  - Tests: `tests/Unit/Entity/ScheduleTest.php` (20 tests)

### Value Object

- [x] **TaskAssignment value object**
  - Description: Immutable value object for task scheduling data
  - Files: `src/ValueObject/TaskAssignment.php`
  - Tests: `tests/Unit/ValueObject/TaskAssignmentTest.php` (23 tests)

### Repository

- [x] **ScheduleRepository**
  - Description: Data access layer for Schedule aggregate
  - Files: `src/Repository/ScheduleRepository.php`
  - Tests: Integration tests (v0.2.11)

### Database

- [x] **Database migration**
  - Description: Create schedules table
  - Files: `migrations/Version20251214060000.php`

### Domain Events

- [x] **Schedule domain events**
  - Description: ScheduleCreated, TaskAssigned, TaskUnassigned, TaskCompletionToggled events
  - Files: `src/Event/Schedule/*.php`
  - Tests: `tests/Unit/Event/Schedule/*Test.php` (14 tests)

---

## Testing Requirements

### Unit Tests

- [x] Schedule entity creation and state management
- [x] TaskAssignment value object validation
- [x] TaskAssignment serialization/deserialization
- [x] Version increment on assignment changes
- [x] Domain event recording
- [x] isCompleted toggle and completedAt tracking

### Integration Tests

- [ ] Schedule persistence and retrieval (v0.2.11)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (933 tests, 2530 assertions)
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Database migration created
- [x] Git tag created: `v0.2.10`

---

## Release Notes Draft

```markdown
## v0.2.10 – Schedule Aggregate

**Release Date:** 2025-12-14

### Summary

Introduces the Schedule aggregate root and TaskAssignment value object - the foundation for task scheduling in the Flux system.

### What's New

- Schedule entity as aggregate root with version tracking
- TaskAssignment value object with completion tracking (isCompleted, completedAt)
- ScheduleRepository for persistence
- Database migration for schedules table
- Domain events: ScheduleCreated, TaskAssigned, TaskUnassigned

### Business Rules

- BR-SCHED-007: Version increment on assignment changes
- BR-ASSIGN-007: Manual task completion toggle
- BR-ASSIGN-008: Completion does not affect precedence

### Technical

- PHPStan level 8 compliant
- Follows existing value object patterns (Duration, TimeSlot)
- Comprehensive unit tests
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Monorepo updated
- [ ] Next release (v0.2.11 - Assignment API) ready to start
