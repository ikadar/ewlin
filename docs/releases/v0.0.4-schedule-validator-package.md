# Release v0.0.4 – Shared Package: @flux/schedule-validator

> **Status:** ✅ Completed
>
> **Milestone:** M0 (Infrastructure & Foundation)
>
> **Release Date:** 2025-12-11
>
> **Git Tag:** `v0.0.4`

---

## Overview

This release creates the `@flux/schedule-validator` package - an isomorphic TypeScript library that validates schedule assignments. The same code runs in the browser (< 10ms feedback during drag) and on the server (authoritative validation).

The package implements all 6 conflict types defined in the business rules:
- **StationConflict** - Station double-booking
- **GroupCapacityConflict** - MaxConcurrent exceeded
- **PrecedenceConflict** - Task sequence violated
- **ApprovalGateConflict** - BAT/Plates not satisfied
- **AvailabilityConflict** - Outside operating hours
- **DeadlineConflict** - Exceeds workshop exit date

---

## Prerequisites

- [x] `v0.0.3` released (Node.js foundation with @flux/types)
- [x] Docker containers running

---

## Scope

### In Scope

- Package structure with @flux/types dependency
- Time utility functions (overlap detection, duration calculation)
- All 6 conflict validators
- Main `validateAssignment` function
- Comprehensive unit tests (100% branch coverage target)
- Browser and Node.js compatible build

### Out of Scope

- Validation HTTP service (covered in M2)
- Operating schedule stretching calculation (simplified in MVP)
- Business calendar for outsourced tasks (simplified in MVP)

---

## Related Documentation

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | [ADR-010: Isomorphic Validation](../architecture/decision-records.md#adr-010--isomorphic-validation-service-nodejs) |
| [Business Rules](../domain-model/business-rules.md) | Validation Rules, Schedule Constraints |
| [Release Roadmap](../roadmap/release-roadmap.md) | Milestone 0, v0.0.4 |

---

## Technical Notes

### Package API

```typescript
import { validateAssignment } from '@flux/schedule-validator';

const result = validateAssignment(
  {
    taskId: 'task-1',
    targetId: 'station-1',
    isOutsourced: false,
    scheduledStart: '2025-01-15T09:00:00Z',
  },
  snapshot // ScheduleSnapshot from @flux/types
);

if (!result.valid) {
  console.log(result.conflicts); // ScheduleConflict[]
}
```

### Conflict Types

| Type | Rule | Blocking |
|------|------|----------|
| StationConflict | No double-booking | Yes |
| GroupCapacityConflict | MaxConcurrent limit | Yes |
| PrecedenceConflict | Task sequence | Soft (Alt bypass) |
| ApprovalGateConflict | BAT/Plates status | Yes |
| AvailabilityConflict | Operating hours | Yes |
| DeadlineConflict | Workshop exit date | Warning |

### Project Structure

```
services/node/packages/
├── types/                     # @flux/types (v0.0.3)
└── validator/                 # @flux/schedule-validator
    ├── src/
    │   ├── index.ts           # Public exports
    │   ├── validate.ts        # Main validation function
    │   ├── validators/
    │   │   ├── station.ts     # Station conflict
    │   │   ├── group.ts       # Group capacity
    │   │   ├── precedence.ts  # Task sequence
    │   │   ├── approval.ts    # Approval gates
    │   │   ├── availability.ts# Operating hours
    │   │   └── deadline.ts    # Workshop exit date
    │   └── utils/
    │       ├── time.ts        # Time overlap utilities
    │       └── helpers.ts     # Lookup helpers
    ├── package.json
    └── tsconfig.json
```

---

## Feature Checklist

### Package Setup

- [x] **Create package structure**
  - Description: Initialize @flux/schedule-validator package
  - Files: `packages/validator/package.json`, `packages/validator/tsconfig.json`
  - Tests: `pnpm build` succeeds

- [x] **Configure @flux/types dependency**
  - Description: Add workspace dependency to types package
  - Files: `packages/validator/package.json`
  - Tests: Types can be imported

### Time Utilities

- [x] **Implement time overlap detection**
  - Description: Check if two time ranges overlap
  - Files: `packages/validator/src/utils/time.ts`
  - Tests: All overlap edge cases covered

- [x] **Implement end time calculation**
  - Description: Calculate task end time from start + duration
  - Files: `packages/validator/src/utils/time.ts`
  - Tests: Duration calculation correct

### Validators

- [x] **Implement station conflict validator**
  - Description: Detect double-booking on stations
  - Files: `packages/validator/src/validators/station.ts`
  - Tests: Overlap detection works

- [x] **Implement group capacity validator**
  - Description: Check MaxConcurrent not exceeded
  - Files: `packages/validator/src/validators/group.ts`
  - Tests: Capacity counting correct

- [x] **Implement precedence validator**
  - Description: Verify task sequence order
  - Files: `packages/validator/src/validators/precedence.ts`
  - Tests: Sequence validation works

- [x] **Implement approval gate validator**
  - Description: Check BAT and Plates status
  - Files: `packages/validator/src/validators/approval.ts`
  - Tests: Gate checking correct

- [x] **Implement availability validator**
  - Description: Verify within operating hours
  - Files: `packages/validator/src/validators/availability.ts`
  - Tests: Schedule compliance works

- [x] **Implement deadline validator**
  - Description: Check workshop exit date feasibility
  - Files: `packages/validator/src/validators/deadline.ts`
  - Tests: Deadline checking correct

### Main Function

- [x] **Implement validateAssignment**
  - Description: Main validation entry point
  - Files: `packages/validator/src/validate.ts`
  - Tests: All validators called, results aggregated

---

## Testing Requirements

### Unit Tests

- [x] Time utilities: overlap detection edge cases
- [x] Time utilities: duration calculations
- [x] Station validator: no conflict case
- [x] Station validator: overlap conflict case
- [x] Group validator: under capacity
- [x] Group validator: at capacity
- [x] Group validator: over capacity
- [x] Precedence validator: correct order
- [x] Precedence validator: wrong order
- [x] Precedence validator: bypass flag
- [x] Approval validator: BAT approved
- [x] Approval validator: BAT pending
- [x] Approval validator: No proof required
- [x] Availability validator: within hours
- [x] Availability validator: outside hours
- [x] Deadline validator: on time
- [x] Deadline validator: late

### Integration Tests

- [x] Full validation with multiple conflicts
- [x] Full validation with no conflicts

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (29 tests)
- [x] Package builds successfully
- [x] Types exported correctly
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.0.4`

---

## Release Notes Draft

```markdown
## v0.0.4 – Shared Package: @flux/schedule-validator

**Release Date:** 2025-12-11

### Summary

Isomorphic schedule validation package that runs in both browser and Node.js.
Validates task assignments against all business rules.

### What's New

- `@flux/schedule-validator` package with full validation
- 6 conflict types implemented:
  - StationConflict (double-booking)
  - GroupCapacityConflict (MaxConcurrent)
  - PrecedenceConflict (task sequence)
  - ApprovalGateConflict (BAT/Plates)
  - AvailabilityConflict (operating hours)
  - DeadlineConflict (workshop exit date)
- Time utility functions
- Comprehensive test coverage

### Usage

```typescript
import { validateAssignment } from '@flux/schedule-validator';

const result = validateAssignment(proposed, snapshot);
if (!result.valid) {
  // Handle conflicts
}
```
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Package can be imported by frontend (v0.0.5)
- [ ] Next release can be started
