# Release v0.3.20 – Tile-Based Drop Position

> **Status:** ✅ Released (on ux-ui-development)
>
> **Milestone:** M3 (Frontend Integration)
>
> **Release Date:** 2025-12-17
>
> **Git Tag:** `v0.3.20`

---

## Overview

Change the drop position calculation during drag-and-drop to use the tile's position rather than the cursor position. Currently, the drop time is calculated from where the cursor is when the user releases. This change calculates the drop time from the top edge of the tile being dragged, providing more intuitive placement.

---

## Prerequisites

- [x] v0.3.19 - Selection Glow Effect released
- [x] Drag-and-drop infrastructure (v0.3.11)
- [x] Drop handling (v0.3.14)

---

## Scope

### In Scope

- **R3.5: Tile-based drop** - Calculate drop position from tile top edge, not cursor position
- Maintain cursor offset during drag (grab point stays under cursor)
- Accurate visual preview during drag

### Out of Scope

- Snap-to-grid functionality (separate feature)
- Drop position adjustment based on tile center (use top edge)
- Multi-tile drag (post-MVP)

---

## Related Documentation

### UX/UI Specification

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Drop position calculation |

---

## Technical Notes

### Current Implementation (Cursor-based)

```typescript
// Current: uses cursor Y position
const handleDrop = (e: React.DragEvent, stationId: string) => {
  const dropY = e.clientY - gridRect.top + scrollTop;
  const dropTime = yPositionToTime(dropY);
  // Creates assignment at dropTime
};
```

The problem: if user grabs tile in the middle, the tile "jumps" on drop because the cursor position becomes the start time.

### Proposed Implementation (Tile-based)

Track the grab offset when drag starts, then subtract it on drop:

```typescript
// On drag start: record where within the tile the user grabbed
const handleDragStart = (e: React.DragEvent, tile: TileData) => {
  const tileRect = e.currentTarget.getBoundingClientRect();
  const grabOffsetY = e.clientY - tileRect.top;
  e.dataTransfer.setData('grabOffsetY', String(grabOffsetY));
};

// On drop: calculate position from tile top, not cursor
const handleDrop = (e: React.DragEvent, stationId: string) => {
  const grabOffsetY = Number(e.dataTransfer.getData('grabOffsetY')) || 0;
  const dropY = e.clientY - gridRect.top + scrollTop - grabOffsetY;
  const dropTime = yPositionToTime(dropY);
  // Creates assignment at dropTime (tile top edge)
};
```

### Alternative: DragImage Offset

HTML5 drag API supports setting a drag image with offset. This can help visual preview align with actual drop position:

```typescript
const handleDragStart = (e: React.DragEvent, tile: TileData) => {
  const grabOffsetY = e.clientY - e.currentTarget.getBoundingClientRect().top;
  const grabOffsetX = e.clientX - e.currentTarget.getBoundingClientRect().left;
  e.dataTransfer.setDragImage(e.currentTarget, grabOffsetX, grabOffsetY);
};
```

---

## Feature Checklist

### Drag Start

- [x] **Record grab offset on drag start**
  - Description: Calculate and store the Y offset from tile top where user grabbed
  - Files: `apps/web/src/App.tsx`, `apps/web/src/utils/dragOffset.ts`

- [x] **Pass grab offset via ref**
  - Description: Store offset in grabOffsetRef for retrieval during drag
  - Files: `apps/web/src/App.tsx`

### Drop Handling

- [x] **Retrieve grab offset on drag move**
  - Description: Read the stored grab offset from ref
  - Files: `apps/web/src/App.tsx`

- [x] **Adjust drop position calculation**
  - Description: Subtract grab offset from cursor position to get tile top position
  - Files: `apps/web/src/App.tsx`, `apps/web/src/utils/dragOffset.ts`

### Quick Placement Mode

- [x] **Not applicable**
  - Description: Quick Placement Mode uses click position directly (no grabbing involved)
  - Files: N/A

---

## Testing Requirements

### Unit Tests

- [x] Grab offset is correctly calculated from event coordinates
- [x] Drop position correctly subtracts grab offset
- [x] Zero offset when grabbing at tile top edge

### E2E Tests

Location: `apps/web/cypress/e2e/tile-based-drop.cy.ts`

- [x] Drag tile from top edge - tile position matches cursor on drop
- [x] Drag tile from middle - tile top maintains relative position
- [x] Drag preview visually aligns with drop position
- [x] Works for new placements from Job Details Panel
- [x] Works for existing tiles on grid

### Manual Testing

- [x] Grab tile at top edge - tile stays at cursor on drop
- [x] Grab tile in middle - tile top maintains relative position
- [x] Grab tile at bottom - tile top maintains relative position
- [x] Drag preview visually matches where tile will land
- [x] Works for both existing tiles and new placements from sidebar
- [x] Cross-station drag maintains correct positioning

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All E2E tests passing
- [x] TypeScript compiles without errors
- [x] Lint passes
- [x] Documentation updated
- [x] Merged to ux-ui-development branch

---

## Release Notes Draft

```markdown
## v0.3.20 – Tile-Based Drop Position

**Release Date:** TBD

### Summary

Improved drag-and-drop precision. Drop position is now calculated from the tile's top edge rather than the cursor position, preventing unexpected "jumps" when dropping tiles.

### What's New

- Tile position calculated from top edge on drop
- Grab point within tile is preserved during drag
- More intuitive placement behavior

### Technical

- Grab offset tracked during drag
- Drop handler adjusted for tile-based positioning
```

---

## File Structure

```
apps/web/src/
├── components/
│   ├── Tile/
│   │   └── Tile.tsx                     # Drag start, grab offset
│   └── SchedulingGrid/
│       └── StationColumn.tsx            # Drop handler adjustment
```
