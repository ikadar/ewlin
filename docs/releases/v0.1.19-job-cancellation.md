# Release v0.1.19 – Job Cancellation

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP - Job Management)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.1.19`

---

## Overview

This release implements job cancellation functionality with proper task cascade behavior. When a job is cancelled, all its incomplete tasks are also cancelled (BR-JOB-005). Future task assignments would be recalled while past assignments are preserved (BR-JOB-010), but since task assignments are not yet implemented (M2), this release focuses on the core cancellation logic.

Key features:
- POST /api/v1/jobs/{id}/cancel endpoint
- Cascade task cancellation (all non-terminal tasks → Cancelled)
- JobCancelled domain event with task lists
- Business rule enforcement (BR-JOB-005, BR-JOB-010)

---

## Prerequisites

- [x] `v0.1.18` released (Job Domain Events)
- [x] Task entity with status workflow (v0.1.11)
- [x] JobCancelled event defined (v0.1.18)

---

## Scope

### In Scope

- POST /api/v1/jobs/{id}/cancel endpoint
- Job.cancel() method that cascades to tasks
- All non-terminal tasks marked as Cancelled
- JobCancelled event updated with cancelled task IDs
- Validation: Cannot cancel already cancelled/completed jobs
- Unit tests for cancellation logic
- Integration tests for cancel endpoint

### Out of Scope

- Task assignment recall (no assignments exist yet - M2)
- Future vs past assignment distinction (M2)
- Soft delete (jobs are actually cancelled, not deleted)
- Undo cancellation

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-JOB-005, BR-JOB-010, BR-JOB-010b |

---

## Technical Notes

### API Design

**POST /api/v1/jobs/{id}/cancel**
- No request body required
- Returns 200 with cancelled job
- Returns 404 if job not found
- Returns 400 if job already in terminal state (Completed/Cancelled)

### Cancellation Logic

```php
// Job.php
public function cancel(): void
{
    if ($this->status->isTerminal()) {
        throw new \InvalidArgumentException('Cannot cancel job in terminal state');
    }

    $cancelledTaskIds = [];
    foreach ($this->tasks as $task) {
        if (!$task->getStatus()->isTerminal()) {
            $task->markCancelled();
            $cancelledTaskIds[] = $task->getId();
        }
    }

    $this->changeStatus(JobStatus::Cancelled);

    // JobCancelled event is recorded by changeStatus()
    // but we need to update it with the cancelled task IDs
}
```

### Event Update

The JobCancelled event (from v0.1.18) already has `recalledTaskIds` and `preservedTaskIds` fields. For now:
- `recalledTaskIds` = empty (no assignments yet)
- `preservedTaskIds` = empty (no assignments yet)

We'll add a new field `cancelledTaskIds` to track which tasks were cancelled.

---

## Feature Checklist

### Entity Changes

- [x] **Add Job.cancel() method**
  - Description: Cancel job and cascade to non-terminal tasks
  - Files: `src/Entity/Job.php`

- [x] **Update JobCancelled event**
  - Description: Add cancelledTaskIds field
  - Files: `src/Event/Job/JobCancelled.php`

### Service Layer

- [x] **Add JobService.cancelJob() method**
  - Description: Service method for cancellation
  - Files: `src/Service/JobService.php`

### API Endpoint

- [x] **POST /api/v1/jobs/{id}/cancel**
  - Description: Cancel job endpoint
  - Files: `src/Controller/Api/V1/JobController.php`

---

## Testing Requirements

### Unit Tests

- [x] Job.cancel() cancels all non-terminal tasks
- [x] Job.cancel() throws when job already completed
- [x] Job.cancel() throws when job already cancelled
- [x] Job.cancel() skips already completed tasks
- [x] Job.cancel() skips already cancelled tasks
- [x] Job.cancel() records JobCancelled event with task IDs
- [x] Job.cancel() changes job status to Cancelled
- [x] JobCancelled event includes cancelledTaskIds

### Integration Tests

- [x] POST /cancel - success with tasks
- [x] POST /cancel - success without tasks
- [x] POST /cancel - 404 when job not found
- [x] POST /cancel - 400 when job already cancelled
- [x] POST /cancel - 400 when job already completed
- [x] POST /cancel - various job statuses (draft, planned, in_progress)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (874 tests, 2343 assertions)
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.19`

---

## Release Notes Draft

```markdown
## v0.1.19 – Job Cancellation

**Release Date:** 2025-12-14

### Summary

Implements job cancellation with cascade behavior to tasks. When a job is cancelled, all its non-terminal tasks are also cancelled.

### What's New

- POST /api/v1/jobs/{id}/cancel - Cancel a job
- Job.cancel() method with task cascade
- JobCancelled event includes cancelledTaskIds
- Validation prevents cancelling terminal jobs

### Business Rules Implemented

- BR-JOB-005: Job cancellation cascades to tasks
- BR-JOB-010: Assignment handling (prepared for M2)
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo docs committed
- [x] CI verified
