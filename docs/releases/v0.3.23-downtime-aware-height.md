# Release v0.3.23 – Downtime-Aware Tile Height

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Release Date:** 2025-12-17
>
> **Git Tag:** `v0.3.23`

---

## Overview

Tile height on the scheduling grid should reflect the actual scheduled time span (scheduledEnd - scheduledStart), not just the task duration. When a task spans non-operating periods (nights, weekends), the backend calculates an extended scheduledEnd. The frontend should display this stretched height so users see an accurate visual representation.

---

## Prerequisites

- [x] v0.3.22 - Station Compact UI released
- [x] Backend EndTimeCalculator (already implemented in PHP API)
- [x] Assignment includes scheduledStart and scheduledEnd from backend

---

## Scope

### In Scope

- **R6: Downtime-aware height** - Calculate tile height from `scheduledEnd - scheduledStart` instead of task duration
- Visual representation of time stretching across non-operating periods
- Accurate tile positioning on grid

### Out of Scope

- Visual indicators for non-operating periods within the tile (e.g., striped sections)
- Station operating schedule display on grid (separate feature)
- Backend changes (already implemented in EndTimeCalculator.php)

---

## Related Documentation

### UX/UI Specification

| Document | Sections |
|----------|----------|
| [Tile Component](../ux-ui/05-components/tile-component.md) | Height calculation |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-ASSIGN-003b (End time stretching) |

---

## Technical Notes

### Current Implementation (Duration-based)

```typescript
// Current: uses task duration
const totalMinutes = setupMinutes + runMinutes;
const totalHeight = minutesToPixels(totalMinutes);
```

This is incorrect when the backend stretches the end time across non-operating periods.

### Proposed Implementation (Time-span-based)

```typescript
// Proposed: uses actual scheduled time span
const startTime = new Date(assignment.scheduledStart);
const endTime = new Date(assignment.scheduledEnd);
const spanMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);
const totalHeight = minutesToPixels(spanMinutes);
```

### Backend Reference

The PHP backend's `EndTimeCalculator.php` already implements BR-ASSIGN-003b:

```php
// EndTimeCalculator stretches duration across operating periods
// A 2-hour task starting at 17:00 (station closes at 18:00)
// might have scheduledEnd at 09:00 next day (1 hour before close + 1 hour after open)
```

### Data Flow

1. User places tile at position (scheduledStart)
2. Frontend sends create-assignment mutation with scheduledStart
3. Backend calculates scheduledEnd using EndTimeCalculator (considers station schedule)
4. Backend returns assignment with both scheduledStart and scheduledEnd
5. Frontend renders tile with height based on scheduledEnd - scheduledStart

### Considerations

- Tile setup/run section proportions: Should setup section scale proportionally with the stretch? Or stay fixed at original duration?
  - Recommendation: Keep setup/run ratio based on original durations, but total height uses scheduled span

```typescript
// Calculate total height from scheduled span
const spanMinutes = (endTime - startTime) / (1000 * 60);
const totalHeight = minutesToPixels(spanMinutes);

// Calculate section proportions from original duration
const originalTotal = setupMinutes + runMinutes;
const setupRatio = setupMinutes / originalTotal;
const setupHeight = totalHeight * setupRatio;
const runHeight = totalHeight * (1 - setupRatio);
```

---

## Feature Checklist

### Tile Component

- [x] **Change height calculation to use scheduled span**
  - Description: Use scheduledEnd - scheduledStart for total height
  - Files: `apps/web/src/components/Tile/Tile.tsx`

- [x] **Maintain setup/run ratio**
  - Description: Keep proportional sections based on original durations
  - Files: `apps/web/src/components/Tile/Tile.tsx`

### Mock Data (for testing)

- [x] **Add stretched assignments to mock data**
  - Description: Create test assignments that span non-operating periods
  - Files: `apps/web/src/mock/generators/assignments.ts`

---

## Testing Requirements

### Unit Tests

- [x] Height calculation uses scheduledEnd - scheduledStart
- [x] Setup/run ratios maintained for stretched tiles
- [x] Handles same-day assignments (no stretching)
- [x] Handles overnight assignments (with stretching)

### E2E Tests

**Not required** - This is a visual calculation change with no user interaction change. Unit tests cover the height calculation logic. Manual testing verifies visual correctness.

### Manual Testing

- [x] Tile height matches time span on grid
- [x] Stretched tiles visually span across non-operating periods
- [x] Normal tiles (no stretching) display correctly
- [x] Setup and run sections scale proportionally
- [x] Multiple stretched tiles on same station don't overlap

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (465 tests)
- [x] TypeScript compiles without errors
- [x] Lint passes
- [x] Documentation updated
- [x] Merged to ux-ui-development branch

---

## Release Notes Draft

```markdown
## v0.3.23 – Downtime-Aware Tile Height

**Release Date:** TBD

### Summary

Tile heights now accurately reflect scheduled time spans. When tasks span non-operating periods (nights, weekends), the tile visually stretches to show the actual time block on the schedule.

### What's New

- Tile height based on scheduledEnd - scheduledStart
- Accurate visual representation of time-stretched tasks
- Proportional setup/run sections maintained

### Technical

- Frontend height calculation updated
- Integrates with backend EndTimeCalculator
- No backend changes required (already implemented)
```

---

## File Structure

```
apps/web/src/
├── components/
│   └── Tile/
│       └── Tile.tsx                     # Height calculation change
```
