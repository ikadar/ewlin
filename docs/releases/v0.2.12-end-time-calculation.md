# Release v0.2.12 – End Time Calculation

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Release Date:** 2025-12-14
>
> **Git Tag:** `v0.2.12`

---

## Overview

This release implements proper scheduled end time calculation for task assignments. For internal tasks, this involves stretching the task duration across station operating hours, skipping non-operating periods (nights, weekends, exceptions). For outsourced tasks, it involves business calendar calculations with provider-specific departure and reception times.

Key deliverables:
- EndTimeCalculator service for computing scheduledEnd
- Internal task stretching across operating schedule gaps
- Outsourced task business calendar calculation
- Provider LatestDepartureTime and ReceptionTime handling
- BusinessCalendar service for weekday calculations

---

## Prerequisites

- [x] `v0.2.11` released (Assignment API Endpoints)
- [x] Station entity with OperatingSchedule and ScheduleExceptions
- [x] OutsourcedProvider entity with latestDepartureTime and receptionTime
- [x] Task entity with totalMinutes (internal) and durationOpenDays (outsourced)

---

## Scope

### In Scope

- EndTimeCalculator service
- Internal task stretching algorithm (BR-ASSIGN-003b)
- Operating schedule slot traversal
- Outsourced task business day calculation
- LatestDepartureTime cutoff handling
- ReceptionTime end time setting
- BusinessCalendar service (weekday-only for MVP)
- Integration with AssignmentService
- Unit tests for all calculation scenarios

### Out of Scope

- Holiday calendar configuration (post-MVP)
- Company-wide holiday management (post-MVP)
- Multi-shift complex schedules (post-MVP)
- Timezone handling beyond server timezone

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-ASSIGN-003, BR-ASSIGN-003b |
| [Workflow Definitions](../domain-model/workflow-definitions.md) | WF-ASSIGN-PROC-002 (Outsourced Task Assignment) |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |

---

## Technical Notes

### Internal Task Algorithm (BR-ASSIGN-003b)

```
ALGORITHM: Calculate End Time for Internal Task

Input: scheduledStart, task.totalMinutes, station.operatingSchedule, station.scheduleExceptions
Output: scheduledEnd

1. remainingMinutes = task.totalMinutes
2. currentTime = scheduledStart
3. WHILE remainingMinutes > 0:
   a. Get effectiveSchedule for currentTime.date (considering exceptions)
   b. IF currentTime is within an operating slot:
      - availableMinutes = minutes until slot end
      - worked = MIN(availableMinutes, remainingMinutes)
      - remainingMinutes -= worked
      - IF remainingMinutes == 0:
        - RETURN currentTime + worked minutes
      - ELSE:
        - Advance to next operating slot (same day or next day)
   c. ELSE (currentTime is outside operating hours):
      - Advance to start of next operating slot
4. RETURN currentTime
```

### Outsourced Task Algorithm

```
ALGORITHM: Calculate End Time for Outsourced Task

Input: scheduledStart, task.durationOpenDays, provider.latestDepartureTime, provider.receptionTime
Output: scheduledEnd

1. Extract time from scheduledStart
2. IF time <= latestDepartureTime:
   - effectiveStartDay = scheduledStart.date
   ELSE:
   - effectiveStartDay = next business day
3. endDay = effectiveStartDay + durationOpenDays (business days only)
4. scheduledEnd = endDay at provider.receptionTime
5. RETURN scheduledEnd
```

### BusinessCalendar Service (MVP)

For MVP, business days are weekdays (Monday-Friday). The service provides:
- `isBusinessDay(date)`: Returns true if weekday
- `addBusinessDays(date, days)`: Adds N business days, skipping weekends

### Station OperatingSchedule Usage

Station already has `getEffectiveScheduleForDate(date)` method that returns DaySchedule:
- Checks schedule exceptions first
- Falls back to weekly pattern for day of week
- Returns DaySchedule with `isOperating` and `slots` array

---

## Feature Checklist

### Services

- [x] **EndTimeCalculator**
  - Description: Service for calculating scheduledEnd for internal and outsourced tasks
  - Files: `src/Service/EndTimeCalculator.php`
  - Tests: `tests/Unit/Service/EndTimeCalculatorTest.php`
  - Methods:
    - `calculateForInternalTask(Task, Station, DateTimeImmutable): DateTimeImmutable`
    - `calculateForOutsourcedTask(Task, OutsourcedProvider, DateTimeImmutable): DateTimeImmutable`

- [x] **BusinessCalendar**
  - Description: Service for business day calculations (weekdays for MVP)
  - Files: `src/Service/BusinessCalendar.php`
  - Tests: `tests/Unit/Service/BusinessCalendarTest.php`
  - Methods:
    - `isBusinessDay(DateTimeImmutable): bool`
    - `addBusinessDays(DateTimeImmutable, int): DateTimeImmutable`
    - `getNextBusinessDay(DateTimeImmutable): DateTimeImmutable`
    - `getBusinessDayOrNext(DateTimeImmutable): DateTimeImmutable`
    - `countBusinessDaysBetween(DateTimeImmutable, DateTimeImmutable): int`

### Integration

- [x] **AssignmentService Update**
  - Description: Integrate EndTimeCalculator into assignment flow
  - Files: `src/Service/AssignmentService.php` (modify)
  - Changes:
    - Inject EndTimeCalculator
    - Replace simplified calculateScheduledEnd with proper calculation
    - Pass Station/Provider entities to calculator

---

## Testing Requirements

### Unit Tests

- [x] EndTimeCalculator - internal task within single slot
- [x] EndTimeCalculator - internal task spanning overnight gap
- [x] EndTimeCalculator - internal task spanning weekend
- [x] EndTimeCalculator - internal task spanning lunch break
- [x] EndTimeCalculator - internal task starting during lunch break
- [x] EndTimeCalculator - internal task starting on closed day
- [x] EndTimeCalculator - internal task full day work
- [x] EndTimeCalculator - internal task exceeding one day
- [x] EndTimeCalculator - internal task fallback (no schedule)
- [x] EndTimeCalculator - outsourced task before departure time
- [x] EndTimeCalculator - outsourced task at departure time
- [x] EndTimeCalculator - outsourced task after departure time
- [x] EndTimeCalculator - outsourced task spanning weekend
- [x] EndTimeCalculator - outsourced task multi-day duration
- [x] EndTimeCalculator - outsourced task dropped on Friday after cutoff
- [x] EndTimeCalculator - outsourced task dropped on weekend
- [x] EndTimeCalculator - outsourced task with custom reception time
- [x] BusinessCalendar - weekday detection (5 tests)
- [x] BusinessCalendar - weekend detection (2 tests)
- [x] BusinessCalendar - add business days simple
- [x] BusinessCalendar - add business days spanning weekend
- [x] BusinessCalendar - get next business day from Friday
- [x] BusinessCalendar - get next business day from weekend
- [x] BusinessCalendar - count business days between dates

### Integration Tests

- [x] Assign internal task - verify scheduledEnd (via existing TaskControllerTest)
- [x] Assign outsourced task - verify scheduledEnd (via existing TaskControllerTest)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (1028 tests, 2778 assertions)
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.12`

---

## Release Notes Draft

```markdown
## v0.2.12 – End Time Calculation

**Release Date:** 2025-12-15

### Summary

Implements proper scheduled end time calculation for task assignments, accounting for station operating schedules and provider business calendars.

### What's New

- **EndTimeCalculator** - Service for accurate scheduledEnd computation
- **Internal task stretching** - Tasks span across non-operating periods (nights, weekends)
- **Outsourced task calculation** - Business day counting with departure/reception times
- **BusinessCalendar** - Service for weekday-based business day calculations

### Technical

- BR-ASSIGN-003b: Internal task stretching algorithm
- Operating schedule slot traversal
- LatestDepartureTime cutoff (work after cutoff = next day)
- ReceptionTime for outsourced task end times
- PHPStan level 8 compliant
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo updated
- [ ] End-to-end testing with real schedule data
- [ ] Next release (v0.2.13 - Unassign Task) ready to start
