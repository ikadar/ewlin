# Release v0.3.28 ‚Äì Alt+Drag Bypass Bug Fix

> **Status:** üöÄ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-22
>
> **Git Tag:** `v0.3.28`
>
> **Implements:** [REQ-13](../ux-ui/additional-requirements/refactored-new-requirements-en.md#req-13-fix-altdrag-bypass-conflict-recording-bug)

---

## Overview

This release fixes a critical bug where Alt+drag precedence bypass does not record the conflict. When users bypass precedence rules using Alt+drop, the conflict should be saved so that:
1. The job appears in the "Probl√®mes" section
2. The tile can show persistent conflict feedback (prerequisite for REQ-12)

**Bug Description:**

The current implementation calculates `bypassedPrecedence` using the validation result that was run WITH `bypassPrecedence: true`. Since the validator skips precedence checks when bypass is enabled, `hasPrecedenceConflict` is always `false`, making `bypassedPrecedence` always `false`.

```typescript
// Current (buggy) - App.tsx line 605:
const bypassedPrecedence = wasAltPressed && currentValidation.hasPrecedenceConflict;
// currentValidation was run with bypassPrecedence: true ‚Üí hasPrecedenceConflict = false!
```

---

## Prerequisites

- [x] `v0.3.27` released (Drag-Drop E2E Test Suite)

---

## Scope

### In Scope

- Fix `bypassedPrecedence` calculation in `App.tsx`
- Validate WITHOUT bypass first to detect if conflict exists
- Record `PrecedenceConflict` when Alt+drop is used on a conflicting position
- Job appears in "Probl√®mes" section after bypassed placement
- Unit tests for the bypass logic
- E2E test: Alt+drop creates conflict record

### Out of Scope

- Persistent amber glow on tiles (REQ-12 - next release v0.3.29)
- Any other visual changes

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Refactored Requirements](../ux-ui/additional-requirements/refactored-new-requirements-en.md) | REQ-13 |
| [UI Interaction Stories](../ux-ui/specifications/ui-interaction-stories.md) | US-UI-004 (Validation) |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | UI-002 (Alt-key bypass), BR-SCHED-003 |

### UX-UI

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Alt-Key Bypass |
| [Conflict Indicators](../ux-ui/04-visual-feedback/conflict-indicators.md) | Precedence Violation |

---

## Technical Notes

### Root Cause Analysis

The bug manifests in **two places**:

**1. onDrop handler (App.tsx line 605):**

```typescript
const bypassedPrecedence = wasAltPressed && currentValidation.hasPrecedenceConflict;
```

**2. Drag visual feedback (SchedulingGrid.tsx):**

```typescript
const showBypassWarning = isValidationTarget &&
  validationState?.hasPrecedenceConflict &&
  validationState?.isAltPressed;
```

Both use `hasPrecedenceConflict` from the validation result. The problem is that when Alt is pressed, the validator runs with `bypassPrecedence: true`, which **skips precedence validation entirely**, returning `hasPrecedenceConflict: false`.

### Solution

Run a **separate validation without bypass** to detect if a precedence conflict actually exists:

```typescript
// Fixed approach:
// 1. Check if there would be a conflict WITHOUT bypass
const conflictCheckValidation = validateAssignment(
  { ...proposed, bypassPrecedence: false },
  snapshot
);
const hadPrecedenceConflict = conflictCheckValidation.conflicts.some(
  c => c.type === 'PrecedenceConflict'
);

// 2. Record bypass if Alt was pressed AND there was a conflict
const bypassedPrecedence = wasAltPressed && hadPrecedenceConflict;
```

### Implementation Approach

**Fix 1: useDropValidation hook** - Add bypass-independent precedence check
- When `bypassPrecedence: true`, run an extra validation without bypass
- `hasPrecedenceConflict` now always reflects the actual conflict state
- Enables correct amber ring display during drag

**Fix 2: App.tsx onDrop handler** - Use validation result for bypass detection
- Uses the corrected `hasPrecedenceConflict` from the hook

**Fix 3: App.tsx processDropAssignment** - Clear conflict on reschedule
- Remove existing PrecedenceConflict for the task before adding new one
- When task is moved to valid position, conflict is cleared
- Job disappears from Probl√®mes section after valid reschedule

The extra validation call is minimal overhead (<10ms) and keeps the logic simple and explicit.

---

## Feature Checklist

### Bug Fix

- [x] **Fix useDropValidation hook**
  - Description: Add bypass-independent precedence conflict detection
  - Files: `apps/web/src/hooks/useDropValidation.ts`
  - Tests: Existing unit tests pass

- [x] **Fix bypassedPrecedence calculation in onDrop**
  - Description: Use corrected hasPrecedenceConflict from hook
  - Files: `apps/web/src/App.tsx`
  - Tests: E2E test

- [x] **Amber ring now appears during Alt+drag over conflict position**
  - Description: SchedulingGrid correctly shows amber warning
  - Files: No changes needed (uses fixed hook)
  - Tests: Manual verification

- [x] **Conflict is recorded on Alt+drop**
  - Description: PrecedenceConflict added to snapshot.conflicts on bypass
  - Files: `apps/web/src/App.tsx`
  - Tests: E2E test

- [x] **Conflict is cleared when task moved to valid position**
  - Description: Remove existing PrecedenceConflict before adding new one
  - Files: `apps/web/src/App.tsx`
  - Tests: Manual verification

### Testing

- [x] **E2E test: Alt+drop scenarios**
  - Description: 4 test cases covering bypass behavior
  - Files: `apps/web/playwright/alt-bypass.spec.ts`

- [x] **Test fixture: alt-bypass**
  - Description: Deterministic test data for manual QA
  - Files: `apps/web/src/mock/testFixtures.ts`

---

## Testing Requirements

### Unit Tests

- [ ] N/A - Logic is simple enough to verify via E2E

### E2E Tests

- [ ] Alt+drop on conflicting position ‚Üí job appears in Probl√®mes section
- [ ] Alt+drop on non-conflicting position ‚Üí no conflict added
- [ ] Regular drop (no Alt) with precedence conflict ‚Üí auto-snaps, no conflict

### Manual Testing

- [ ] Start dev server: `pnpm dev`
- [ ] Load fixture: `http://localhost:5173/?fixture=alt-bypass`
- [ ] Verify Alt+drop behavior as described below

---

## Manual QA Test Plan

### Test Fixture

- **Fixture name:** `alt-bypass`
- **URL:** `http://localhost:5173/?fixture=alt-bypass`
- **Description:** Job with 2 sequential tasks, first task pre-scheduled

### Test Data Setup

| Entity | ID | Key Properties |
|--------|-----|----------------|
| Job | job-bypass-1 | 2 tasks, color: blue |
| Task 1 | task-bypass-1 | sequenceOrder: 1, scheduled at 10:00-11:00 |
| Task 2 | task-bypass-2 | sequenceOrder: 2, unscheduled |
| Station | station-1 | Available, operating 08:00-18:00 |

### Test Scenarios

#### Scenario 1: Alt+Drop Creates Conflict (Happy Path)

**Preconditions:**
- Task 1 is scheduled at 10:00-11:00
- Task 2 is unscheduled

**Steps:**
1. Select the job (click on job card)
2. Drag Task 2 from Job Details Panel to the grid
3. Position over 09:00 (before Task 1 ends)
4. Observe amber ring (bypass warning)
5. Hold Alt key
6. Drop the task

**Expected Results:**
- [ ] Task 2 is placed at 09:00
- [ ] Job appears in "Probl√®mes" section with "Conflit" badge
- [ ] Job card shows amber background and shuffle icon

#### Scenario 2: Drop Without Alt (Auto-Snap)

**Preconditions:**
- Task 1 is scheduled at 10:00-11:00
- Task 2 is unscheduled

**Steps:**
1. Select the job
2. Drag Task 2 to 09:00 position
3. Drop WITHOUT pressing Alt

**Expected Results:**
- [ ] Task 2 auto-snaps to 11:00 (after Task 1)
- [ ] Job does NOT appear in Probl√®mes section
- [ ] No conflict badge on job card

#### Scenario 3: Alt+Drop on Valid Position

**Preconditions:**
- Task 1 is scheduled at 10:00-11:00
- Task 2 is unscheduled

**Steps:**
1. Select the job
2. Drag Task 2 to 12:00 position (valid)
3. Hold Alt and drop

**Expected Results:**
- [ ] Task 2 is placed at 12:00
- [ ] Job does NOT appear in Probl√®mes section
- [ ] No conflict added (Alt has no effect on valid positions)

### Visual Verification

- [ ] Amber ring appears when hovering over conflicting position with Alt
- [ ] Green ring appears when hovering over valid position
- [ ] Job card in Probl√®mes shows amber background (`bg-amber-500/10`)
- [ ] Shuffle icon (`lucide-shuffle`) visible on conflict job card

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [ ] All feature checklist items completed
- [ ] All E2E tests passing (including new alt-bypass tests)
- [ ] Manual testing completed
- [ ] Lint and TypeScript checks passing
- [ ] Documentation updated (this file)
- [ ] Roadmap updated (mark v0.3.28 as complete)
- [ ] Git tag created: `v0.3.28`
- [ ] GitHub release created

---

## Release Notes Draft

```markdown
## v0.3.28 ‚Äì Alt+Drag Bypass Bug Fix

**Release Date:** 2025-12-22

### Summary

Fixes a critical bug where Alt+drag precedence bypass was not recording the conflict.
This is a prerequisite for REQ-12 (persistent conflict visual feedback).

### Bug Fix

- **Alt+Drop Conflict Recording:** When users bypass precedence rules using Alt+drop,
  the conflict is now correctly saved. The job appears in the "Probl√®mes" section
  with the "Conflit" badge as expected.

### Technical Details

- Fixed `bypassedPrecedence` calculation in `App.tsx`
- Added secondary validation call to detect conflicts before bypass
- Added E2E tests for bypass scenarios

### Manual QA

Test URL: `http://localhost:5173/?fixture=alt-bypass`

1. Select job, drag Task 2 to position before Task 1 ends
2. Hold Alt and drop
3. Verify job appears in Probl√®mes section

### Related

- Prerequisite for v0.3.29 (REQ-12: Persistent Visual Feedback)
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Verify on ux-ui-development branch
- [ ] Proceed to v0.3.29 (REQ-12) implementation
