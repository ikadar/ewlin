# Release v0.2.8 – Validation API Endpoint

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.2.8`

---

## Overview

This release adds the core validation endpoint to the Validation Service. The `POST /validate` endpoint exposes `@flux/schedule-validator` functionality via REST API, allowing the PHP Assignment Service to perform authoritative validation before persisting assignments.

Key features:
- POST /validate endpoint
- Zod schema validation for requests
- Response formatting with ValidationResult
- Performance logging (< 50ms target)

---

## Prerequisites

- [x] `v0.2.7` released (Validation Service Setup)
- [x] `v0.2.7.1` released (Git submodule conversion)
- [x] `@flux/schedule-validator` package available
- [x] `@flux/types` package available

---

## Scope

### In Scope

- `POST /validate` endpoint implementation
- Request body validation with Zod
- Call to `validateAssignment` from `@flux/schedule-validator`
- JSON response with `ValidationResult`
- Performance logging (validation duration in ms)
- Unit tests for validation route
- Integration tests for POST /validate

### Out of Scope

- Batch validation endpoint (POST /validate/batch) - future release
- Docker configuration (v0.2.9)
- Authentication/authorization (M4)
- Rate limiting (M4)

---

## Related Documentation

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-009, ADR-010 |

---

## Technical Notes

### API Design

**POST /validate**

Request body:
```json
{
  "proposed": {
    "taskId": "task-123",
    "targetId": "station-456",
    "isOutsourced": false,
    "scheduledStart": "2025-12-14T09:00:00.000Z",
    "bypassPrecedence": false
  },
  "snapshot": {
    "version": 1,
    "generatedAt": "2025-12-14T08:00:00.000Z",
    "stations": [...],
    "categories": [...],
    "groups": [...],
    "providers": [...],
    "jobs": [...],
    "tasks": [...],
    "assignments": [...],
    "conflicts": [],
    "lateJobs": []
  }
}
```

Response (200 OK):
```json
{
  "valid": true,
  "conflicts": [],
  "suggestedStart": null,
  "validationTimeMs": 2
}
```

Response (200 OK with conflicts):
```json
{
  "valid": false,
  "conflicts": [
    {
      "type": "StationConflict",
      "message": "Station is already booked at this time",
      "taskId": "task-123",
      "targetId": "station-456"
    }
  ],
  "suggestedStart": null,
  "validationTimeMs": 3
}
```

Response (400 Bad Request):
```json
{
  "error": "ValidationError",
  "message": "Invalid request body",
  "details": [
    {
      "path": ["proposed", "taskId"],
      "message": "Required"
    }
  ]
}
```

### Performance Logging Format

```
[2025-12-14T10:00:00.000Z] POST /validate - valid: true, conflicts: 0, validation: 0.02ms, total: 0.15ms
```

### Files Created/Modified

```
services/validation-service/
├── src/
│   ├── routes/
│   │   └── validate.ts       # NEW: Validation route
│   ├── schemas/
│   │   └── validate.ts       # NEW: Zod schemas
│   └── app.ts                # MODIFY: Add validate route
├── tests/
│   └── routes/
│       └── validate.test.ts  # NEW: Validation tests
└── package.json              # MODIFY: Add zod dependency, version 0.2.8
```

---

## Feature Checklist

### Dependencies

- [x] **Add Zod dependency**
  - Description: Add zod for request validation
  - Files: `services/validation-service/package.json`

### Schemas

- [x] **Create Zod validation schemas**
  - Description: Define request/response schemas with Zod
  - Files: `services/validation-service/src/schemas/validate.ts`

### Routes

- [x] **Implement POST /validate endpoint**
  - Description: Validation endpoint calling @flux/schedule-validator
  - Files: `services/validation-service/src/routes/validate.ts`
  - Tests: `services/validation-service/tests/routes/validate.test.ts`

### Integration

- [x] **Register validate route in app**
  - Description: Add validateRouter to Express app
  - Files: `services/validation-service/src/app.ts`

### Version

- [x] **Update version to 0.2.8**
  - Description: Bump version in package.json
  - Files: `services/validation-service/package.json`

---

## Testing Requirements

### Unit Tests

- [x] Zod schema validates correct request
- [x] Zod schema rejects missing required fields
- [x] Zod schema rejects invalid types
- [x] Route returns 200 with valid assignment
- [x] Route returns 200 with conflicts for invalid assignment
- [x] Route returns 400 for malformed request
- [x] Response includes validationTimeMs

### Integration Tests

- [x] POST /validate with valid assignment returns valid: true
- [x] POST /validate with station conflict returns valid: false
- [x] POST /validate with missing body returns 400
- [x] POST /validate performance < 50ms
- [x] POST /validate with approval gate conflict
- [x] POST /validate with precedence conflict
- [x] POST /validate with bypassPrecedence flag

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (35 tests)
- [x] All integration tests passing
- [x] TypeScript compilation successful
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated (validation-service repo)
- [x] Git tag created: `v0.2.8`

---

## Release Notes Draft

```markdown
## v0.2.8 – Validation API Endpoint

**Release Date:** 2025-12-14

### Summary

Adds the POST /validate endpoint to the Validation Service, exposing @flux/schedule-validator functionality as a REST API. This endpoint will be called by the PHP Assignment Service to perform authoritative validation before persisting assignments.

### What's New

- POST /validate endpoint
- Zod request validation
- Performance logging (validation time in ms)
- Comprehensive test coverage (14 new tests)

### API

POST /validate
- Request: { proposed: ProposedAssignment, snapshot: ScheduleSnapshot }
- Response: { valid: boolean, conflicts: ScheduleConflict[], suggestedStart?: string, validationTimeMs: number }

### Performance

Target: < 50ms per validation
Actual: < 1ms typical
```

---

## Post-Release

- [x] GitHub release created (validation-service repo)
- [x] Monorepo updated
- [ ] Service tested with real data
