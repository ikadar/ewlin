# Release v0.1.15 – Paper Procurement

> **Status:** ✅ Released
>
> **Milestone:** M1
>
> **Release Date:** 2025-12-13
>
> **Git Tag:** `v0.1.15`

---

## Overview

This release adds paper procurement tracking fields to the Job entity. Paper availability is a critical gate for production - tasks should not start until paper is available (InStock or Received). This release adds the tracking fields and status update endpoint; actual scheduling validation will be implemented in a future release.

---

## Prerequisites

- [x] `v0.1.14` Approval Gates released
- [x] Job entity exists with approval gate fields

---

## Scope

### In Scope

- `paperPurchaseStatus` field on Job (PaperPurchaseStatus enum: InStock/ToOrder/Ordered/Received)
- `paperOrderedAt` field on Job (nullable datetime, auto-set when status → Ordered)
- `PUT /api/v1/jobs/{id}/paper` endpoint for paper status updates
- Status transition validation (BR-PAPER-001)
- Auto-timestamp on Ordered transition (BR-PAPER-002)
- Unit tests for PaperPurchaseStatus enum
- Unit tests for Job paper fields
- Integration tests for paper endpoint

### Out of Scope

- Scheduling validation based on paper status (BR-PAPER-003 - future release)
- Paper type/format fields (already in scope for job creation, not this release)
- UI components

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | Job (paperPurchaseStatus, paperOrderedAt) |
| [Business Rules](../domain-model/business-rules.md) | BR-PAPER-001, BR-PAPER-002, BR-PAPER-003 |

### API

| Document | Sections |
|----------|----------|
| [API Interface Drafts](../requirements/api-interface-drafts.md) | PUT /api/v1/jobs/{jobId}/paper |

---

## Technical Notes

### PaperPurchaseStatus Enum

```php
enum PaperPurchaseStatus: string
{
    case InStock = 'InStock';
    case ToOrder = 'ToOrder';
    case Ordered = 'Ordered';
    case Received = 'Received';
}
```

### Status Transitions (BR-PAPER-001)

Valid transitions:
- `InStock` → (no progression needed, paper available)
- `ToOrder` → `Ordered` → `Received`

Invalid (backward) transitions:
- `Ordered` → `ToOrder` (NOT allowed)
- `Received` → `Ordered` (NOT allowed)
- `Received` → `ToOrder` (NOT allowed)

### Auto-timestamp (BR-PAPER-002)

When `paperPurchaseStatus` changes to `Ordered`:
- `paperOrderedAt` is automatically set to current timestamp
- If already `Ordered`, timestamp is NOT updated on re-submission

### API Endpoint

```
PUT /api/v1/jobs/{id}/paper
Request:  { "paperPurchaseStatus": "Ordered" }
Response: { "paperPurchaseStatus": "Ordered", "paperOrderedAt": "2025-12-13T10:30:00Z" }
```

---

## Feature Checklist

### Entity Changes

- [x] **PaperPurchaseStatus Enum**
  - Description: Enum with InStock/ToOrder/Ordered/Received values
  - Files: `src/Entity/PaperPurchaseStatus.php`
  - Tests: `tests/Unit/Entity/PaperPurchaseStatusTest.php`

- [x] **Job Entity Fields**
  - Description: Add paperPurchaseStatus, paperOrderedAt to Job
  - Files: `src/Entity/Job.php`
  - Tests: Unit tests for getters/setters and transition validation

### DTO Changes

- [x] **UpdatePaperRequest DTO**
  - Description: Request DTO for paper status updates
  - Files: `src/DTO/Job/UpdatePaperRequest.php`
  - Tests: Validation tests

- [x] **JobResponse DTO Update**
  - Description: Include paperPurchaseStatus and paperOrderedAt in response
  - Files: `src/DTO/Job/JobResponse.php`
  - Tests: Covered by integration tests

### Service Layer

- [x] **JobService::updatePaperStatus()**
  - Description: Update paperPurchaseStatus with transition validation
  - Files: `src/Service/JobService.php`
  - Tests: Covered by integration tests

### Controller Endpoints

- [x] **PUT /api/v1/jobs/{id}/paper**
  - Description: Update paper procurement status
  - Files: `src/Controller/Api/V1/JobController.php`
  - Tests: Integration tests

### Database Migration

- [x] **Add paper procurement columns**
  - Description: Migration for paperPurchaseStatus, paperOrderedAt
  - Files: `migrations/Version20251213030000.php`
  - Tests: N/A

---

## Testing Requirements

### Unit Tests

- [x] PaperPurchaseStatus enum values
- [x] PaperPurchaseStatus.label() method
- [x] PaperPurchaseStatus.isAvailable() helper (InStock or Received)
- [x] PaperPurchaseStatus.canTransitionTo() validation
- [x] Job.setPaperPurchaseStatus() with valid transitions
- [x] Job.setPaperPurchaseStatus() with invalid transitions (throws)
- [x] Job.paperOrderedAt auto-set on Ordered transition
- [x] Job.paperOrderedAt NOT updated if already Ordered
- [x] Job.isPaperAvailable() helper method

### Integration Tests

- [x] PUT /api/v1/jobs/{id}/paper with valid status (ToOrder → Ordered)
- [x] PUT /api/v1/jobs/{id}/paper sets paperOrderedAt automatically
- [x] PUT /api/v1/jobs/{id}/paper with invalid transition (400)
- [x] PUT /api/v1/jobs/{id}/paper with same status (no change)
- [x] PUT /api/v1/jobs/{id}/paper with Received (from Ordered)
- [x] GET /api/v1/jobs/{id} includes paperPurchaseStatus and paperOrderedAt
- [x] Job not found returns 404

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] Documentation updated
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.15`
- [x] GitHub release created

---

## Release Notes Draft

```markdown
## v0.1.15 – Paper Procurement

**Release Date:** 2025-12-13

### Summary

Adds paper procurement tracking fields to Job entity for tracking paper availability status.

### What's New

- `paperPurchaseStatus` field - tracks paper procurement state (InStock/ToOrder/Ordered/Received)
- `paperOrderedAt` field - automatically set when status changes to Ordered
- `PUT /api/v1/jobs/{id}/paper` - Update paper status with transition validation

### API Changes

**New Endpoint:**
```
PUT /api/v1/jobs/{id}/paper
  { "paperPurchaseStatus": "Ordered" }

Response:
  { "paperPurchaseStatus": "Ordered", "paperOrderedAt": "2025-12-13T10:30:00Z" }
```

### Business Rules

- BR-PAPER-001: Status progression InStock | ToOrder → Ordered → Received (no backward transitions)
- BR-PAPER-002: paperOrderedAt auto-set when status changes to Ordered

### Breaking Changes

None
```

---

## Post-Release

- [x] GitHub release created
- [x] Submodule reference updated in monorepo
- [x] Documentation verified
