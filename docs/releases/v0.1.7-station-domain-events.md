# Release v0.1.7 – Station Domain Events

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Target Date:** 2025-12-12
>
> **Git Tag:** `v0.1.7`

---

## Overview

This release introduces the **domain event infrastructure** for the Station Management bounded context. Domain events signal that something significant has happened within the aggregate, enabling loose coupling and future integration with other services.

### Why This Matters

- **Event-driven architecture foundation**: Prepare for inter-service communication
- **Audit trail**: Track all significant station changes
- **Future real-time updates**: Events can be broadcast to UI via WebSocket
- **Decoupling**: Other services can react to station changes without direct coupling

---

## Prerequisites

- [x] `v0.1.6` released (Outsourced Provider Entity)
- [x] Station entity with operating schedule and exceptions
- [x] Symfony Messenger not yet installed (will be added)

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| DomainEvent base class | Abstract base for all domain events |
| StationRegistered event | Emitted when station is created |
| OperatingScheduleUpdated event | Emitted when schedule is modified |
| ScheduleExceptionAdded event | Emitted when exception is added |
| StationStatusChanged event | Emitted when status changes |
| Symfony Messenger setup | Message bus configuration |
| Event recording in entities | Entities collect events for dispatch |
| Unit tests | Event creation and payload tests |

### Out of Scope

| Item | Reason |
|------|--------|
| Integration events | M2 - Cross-service communication |
| Event persistence (event store) | Post-MVP feature |
| WebSocket broadcasting | M3 - Frontend integration |
| Event handlers/subscribers | Will be added when needed |
| StationCategoryCreated event | Can be added later |
| StationGroupCreated event | Can be added later |
| ProviderRegistered event | Can be added later |

---

## Related Documentation

### Architecture

| Document | Sections |
|----------|----------|
| [Event Message Design](../architecture/event-message-design.md) | Section 2: Domain Events (StationRegistered, OperatingScheduleUpdated, ScheduleExceptionAdded, StationStatusChanged) |
| [Service Boundaries](../architecture/service-boundaries.md) | Station Management Service |

---

## Domain Event Specifications

### Base Event Structure

All domain events share common metadata:

```php
abstract class DomainEvent
{
    public readonly string $eventId;      // UUID
    public readonly \DateTimeImmutable $occurredAt;
}
```

### StationRegistered

**Purpose:** Indicates that a new station has been added to the system.
**Trigger:** Emitted when the Station aggregate is created.

```json
{
  "eventId": "uuid",
  "stationId": "string",
  "name": "string",
  "categoryId": "string",
  "groupId": "string",
  "registeredAt": "ISO-8601-timestamp"
}
```

### OperatingScheduleUpdated

**Purpose:** Signals that a station's operating schedule has been modified.
**Trigger:** Emitted when weekly schedule patterns are updated.

```json
{
  "eventId": "uuid",
  "stationId": "string",
  "weeklyPattern": {
    "monday": {"isOperating": true, "slots": [{"start": "08:00", "end": "17:00"}]},
    ...
  },
  "updatedAt": "ISO-8601-timestamp"
}
```

### ScheduleExceptionAdded

**Purpose:** Indicates a one-off schedule exception (holiday, maintenance).
**Trigger:** Emitted when an exception is added to a station.

```json
{
  "eventId": "uuid",
  "stationId": "string",
  "exceptionDate": "YYYY-MM-DD",
  "type": "CLOSED|MODIFIED",
  "modifiedSlots": [{"start": "HH:MM", "end": "HH:MM"}],
  "reason": "string|null",
  "addedAt": "ISO-8601-timestamp"
}
```

### StationStatusChanged

**Purpose:** Signals station status transition.
**Trigger:** Emitted when station availability changes.

```json
{
  "eventId": "uuid",
  "stationId": "string",
  "previousStatus": "Available|InUse|Maintenance|OutOfService",
  "newStatus": "Available|InUse|Maintenance|OutOfService",
  "changedAt": "ISO-8601-timestamp"
}
```

---

## Technical Design

### Event Recording Pattern

Entities collect domain events internally and expose them for dispatch:

```php
class Station
{
    /** @var list<DomainEvent> */
    private array $domainEvents = [];

    public function recordEvent(DomainEvent $event): void
    {
        $this->domainEvents[] = $event;
    }

    /** @return list<DomainEvent> */
    public function pullDomainEvents(): array
    {
        $events = $this->domainEvents;
        $this->domainEvents = [];
        return $events;
    }
}
```

### Event Dispatch

Events are dispatched after entity persistence via Doctrine lifecycle or service layer:

```php
// In service layer after persist
foreach ($station->pullDomainEvents() as $event) {
    $this->eventBus->dispatch($event);
}
```

### Symfony Messenger Configuration

```yaml
# config/packages/messenger.yaml
framework:
    messenger:
        buses:
            event.bus:
                default_middleware: allow_no_handlers
```

---

## File Structure

```
services/php-api/
├── src/
│   └── Event/
│       ├── DomainEvent.php                    # Abstract base class
│       ├── RecordsDomainEvents.php            # Trait for entities
│       └── Station/
│           ├── StationRegistered.php
│           ├── OperatingScheduleUpdated.php
│           ├── ScheduleExceptionAdded.php
│           └── StationStatusChanged.php
├── config/
│   └── packages/
│       └── messenger.yaml                      # Message bus config
└── tests/
    └── Unit/
        └── Event/
            └── Station/
                ├── StationRegisteredTest.php
                ├── OperatingScheduleUpdatedTest.php
                ├── ScheduleExceptionAddedTest.php
                └── StationStatusChangedTest.php
```

---

## Feature Checklist

### Infrastructure

- [x] **Install Symfony Messenger**
  - Command: `composer require symfony/messenger`
  - Config: `config/packages/messenger.yaml`

- [x] **Create DomainEvent base class**
  - File: `src/Event/DomainEvent.php`
  - Properties: eventId, occurredAt
  - Tests: `tests/Unit/Event/DomainEventTest.php`

- [x] **Create RecordsDomainEvents trait**
  - File: `src/Event/RecordsDomainEvents.php`
  - Methods: recordEvent(), pullDomainEvents()

### Station Domain Events

- [x] **StationRegistered event**
  - File: `src/Event/Station/StationRegistered.php`
  - Payload: stationId, name, categoryId, groupId, registeredAt
  - Tests: `tests/Unit/Event/Station/StationRegisteredTest.php`

- [x] **OperatingScheduleUpdated event**
  - File: `src/Event/Station/OperatingScheduleUpdated.php`
  - Payload: stationId, weeklyPattern, updatedAt
  - Tests: `tests/Unit/Event/Station/OperatingScheduleUpdatedTest.php`

- [x] **ScheduleExceptionAdded event**
  - File: `src/Event/Station/ScheduleExceptionAdded.php`
  - Payload: stationId, exceptionDate, type, modifiedSlots, reason, addedAt
  - Tests: `tests/Unit/Event/Station/ScheduleExceptionAddedTest.php`

- [x] **StationStatusChanged event**
  - File: `src/Event/Station/StationStatusChanged.php`
  - Payload: stationId, previousStatus, newStatus, changedAt
  - Tests: `tests/Unit/Event/Station/StationStatusChangedTest.php`

### Entity Integration

- [x] **Add RecordsDomainEvents to Station entity**
  - Modify: `src/Entity/Station.php`
  - Record events in: constructor, setOperatingSchedule, addException, changeStatus

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `DomainEventTest` | Event ID is UUID |
| | OccurredAt is set automatically |
| `StationRegisteredTest` | Valid event creation |
| | Payload contains all required fields |
| | toArray() returns correct structure |
| `OperatingScheduleUpdatedTest` | Valid event creation |
| | Weekly pattern serialization |
| `ScheduleExceptionAddedTest` | Valid event for CLOSED type |
| | Valid event for MODIFIED type |
| | Reason is optional |
| `StationStatusChangedTest` | Valid event creation |
| | All status transitions captured |

### Integration Tests

| Test | Description |
|------|-------------|
| Event recording | Station records events on creation |
| Event pulling | Events cleared after pull |
| Multiple events | Multiple events in single operation |

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] Symfony Messenger installed and configured
- [x] Station entity records domain events
- [x] PHPStan passes (level 8)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.7`

---

## Release Notes Draft

```markdown
## v0.1.7 – Station Domain Events

**Release Date:** 2025-12-12

### Summary

Introduces domain event infrastructure for the Station Management bounded context.
Events signal significant changes within aggregates, preparing the foundation for
event-driven architecture and future inter-service communication.

### What's New

- **DomainEvent base class** - Common structure for all domain events
- **RecordsDomainEvents trait** - Entity-level event collection
- **StationRegistered** - Event emitted when station is created
- **OperatingScheduleUpdated** - Event emitted when schedule changes
- **ScheduleExceptionAdded** - Event emitted when exception is added
- **StationStatusChanged** - Event emitted when status transitions
- **Symfony Messenger** - Message bus infrastructure

### Technical Changes

- Added `symfony/messenger` package
- Station entity now records domain events
- Events use UUID for identification
- All events include ISO-8601 timestamps

### Breaking Changes

None

### Migration Guide

No migration required. Events are recorded but not persisted or dispatched to external systems yet.
```

---

## Post-Release

- [x] GitHub release created with notes
- [x] Verify events are recorded in Station entity
- [ ] Proceed to v0.1.8 (Submodule CI/CD Pipelines)
