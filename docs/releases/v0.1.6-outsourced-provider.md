# Release v0.1.6 – Outsourced Provider Entity

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Release Date:** 2025-12-12
>
> **Git Tag:** `v0.1.6`

---

## Overview

This release implements the **OutsourcedProvider** aggregate root - representing external companies that perform outsourced tasks (e.g., pelliculage, dorure, reliure). Each provider acts as a special "station" with unlimited capacity and automatically creates its own StationGroup.

### Why This Matters

- **External work management**: Track tasks sent to external providers
- **Automatic group creation**: Provider groups with unlimited capacity (BR-PROVIDER-002)
- **Time-based scheduling**: `latestDepartureTime` and `receptionTime` for accurate scheduling
- **Action type filtering**: Know which providers can handle which work types

---

## Prerequisites

- [x] `v0.1.5` released (Station Group Entity with isOutsourcedProviderGroup support)
- [x] StationGroup entity supports isOutsourcedProviderGroup flag

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| OutsourcedProvider entity | New aggregate root with status, times, action types |
| ProviderStatus enum | Active, Inactive states |
| POST /api/v1/providers | Create provider (auto-creates station group) |
| GET /api/v1/providers | List all providers |
| GET /api/v1/providers/{id} | Get provider details |
| PUT /api/v1/providers/{id} | Update provider |
| DELETE /api/v1/providers/{id} | Delete provider (if no tasks assigned) |
| Auto-create StationGroup | Provider group with unlimited capacity |
| Unique name validation | Provider names must be unique |
| Unit tests | Entity tests |
| Integration tests | API endpoint tests |

### Out of Scope

| Item | Reason |
|------|--------|
| Task assignment to providers | Covered in M2 (Assignment Service) |
| Provider-specific scheduling logic | Covered in M2 (Schedule Engine) |
| Provider capacity reporting | Post-MVP feature |
| Provider billing/invoicing | Not in scheduler scope |

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-PROVIDER-001 through BR-PROVIDER-004 |
| [Domain Model](../domain-model/domain-model.md) | OutsourcedProvider (Aggregate Root) |

### Architecture

| Document | Sections |
|----------|----------|
| [Interface Contracts](../architecture/interface-contracts.md) | Section 4: Provider Service |

---

## Domain Model Reference

### OutsourcedProvider Structure

```
┌─────────────────────────────────────────────────────────────┐
│                   OutsourcedProvider                        │
├─────────────────────────────────────────────────────────────┤
│  id: string (UUID)                                          │
│  name: string (max 100, unique)                             │
│  status: ProviderStatus (Active, Inactive)                  │
│  supportedActionTypes: string[] (non-empty)                 │
│  latestDepartureTime: string (HH:MM, default "14:00")       │
│  receptionTime: string (HH:MM, default "09:00")             │
│  groupId: string (reference to auto-created StationGroup)   │
│  createdAt: datetime                                        │
│  updatedAt: datetime                                        │
└─────────────────────────────────────────────────────────────┘
```

### Example Provider

```json
{
  "id": "prv-123",
  "name": "Pelliculage Express",
  "status": "Active",
  "supportedActionTypes": ["Pelliculage", "Vernis"],
  "latestDepartureTime": "14:00",
  "receptionTime": "09:00",
  "groupId": "grp-provider-pelliculage-express",
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

---

## Business Rules

| Rule ID | Description | Enforcement |
|---------|-------------|-------------|
| **BR-PROVIDER-001** | Provider must have unique identifier | UUID generation |
| **BR-PROVIDER-002** | Provider creates own station group | Auto-create on provider creation |
| **BR-PROVIDER-003** | Provider has unlimited capacity | Via isOutsourcedProviderGroup=true, maxConcurrent=null |
| **BR-PROVIDER-004** | Provider duration in open days | M2 - Task entity |

---

## API Design

### POST /api/v1/providers

Create a provider. Automatically creates a StationGroup with unlimited capacity.

**Request:**
```json
{
  "name": "Pelliculage Express",
  "supportedActionTypes": ["Pelliculage", "Vernis"],
  "latestDepartureTime": "14:00",
  "receptionTime": "09:00"
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "name": "Pelliculage Express",
  "status": "Active",
  "supportedActionTypes": ["Pelliculage", "Vernis"],
  "latestDepartureTime": "14:00",
  "receptionTime": "09:00",
  "groupId": "uuid",
  "createdAt": "2025-12-12T10:00:00Z",
  "updatedAt": "2025-12-12T10:00:00Z"
}
```

**Error Responses:**

(400) Missing action types:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "At least one supported action type is required"
  }
}
```

(400) Invalid time format:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid time format. Expected HH:MM"
  }
}
```

(409) Duplicate name:
```json
{
  "error": {
    "code": "PROVIDER_NAME_EXISTS",
    "message": "A provider with this name already exists"
  }
}
```

### GET /api/v1/providers

List all providers.

**Query Parameters:**
- `search` (optional): Search by name
- `status` (optional): Filter by status (Active, Inactive)
- `actionType` (optional): Filter by supported action type

**Response (200):**
```json
{
  "data": [...],
  "total": 5
}
```

### GET /api/v1/providers/{id}

Get provider by ID.

**Response (200):** Provider object

**Response (404):** Provider not found

### PUT /api/v1/providers/{id}

Update provider.

**Request:**
```json
{
  "name": "Updated Name",
  "status": "Inactive",
  "supportedActionTypes": ["Pelliculage"],
  "latestDepartureTime": "15:00",
  "receptionTime": "10:00"
}
```

**Notes:**
- `groupId` cannot be changed
- Changing status to Inactive does not affect existing task assignments

### DELETE /api/v1/providers/{id}

Delete provider.

**Response (204):** No content

**Response (409):** Provider has assigned tasks (future feature)

---

## File Structure

```
services/php-api/
├── src/
│   ├── DTO/
│   │   └── Provider/
│   │       ├── CreateProviderRequest.php
│   │       ├── UpdateProviderRequest.php
│   │       └── ProviderResponse.php
│   ├── Controller/
│   │   └── Api/V1/
│   │       └── ProviderController.php
│   ├── Entity/
│   │   ├── OutsourcedProvider.php      # New
│   │   └── ProviderStatus.php          # New enum
│   ├── Repository/
│   │   └── OutsourcedProviderRepository.php
│   └── Service/
│       └── OutsourcedProviderService.php
├── migrations/
│   └── Version20251212XXXXXX.php       # Create outsourced_providers table
└── tests/
    ├── Unit/
    │   └── Entity/
    │       ├── OutsourcedProviderTest.php
    │       └── ProviderStatusTest.php
    └── Integration/
        └── Controller/Api/V1/
            └── ProviderControllerTest.php
```

---

## Database Changes

Create `outsourced_providers` table:

```sql
CREATE TABLE outsourced_providers (
    id VARCHAR(36) NOT NULL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    status VARCHAR(20) NOT NULL DEFAULT 'Active',
    supported_action_types JSON NOT NULL,
    latest_departure_time VARCHAR(5) NOT NULL DEFAULT '14:00',
    reception_time VARCHAR(5) NOT NULL DEFAULT '09:00',
    group_id VARCHAR(36) NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    CONSTRAINT FK_provider_group FOREIGN KEY (group_id)
        REFERENCES station_groups(id) ON DELETE RESTRICT
);
```

---

## Feature Checklist

### Entity Layer

- [x] **Create ProviderStatus enum**
  - File: `src/Entity/ProviderStatus.php`
  - Values: Active, Inactive
  - Tests: `tests/Unit/Entity/ProviderStatusTest.php`

- [x] **Create OutsourcedProvider entity**
  - File: `src/Entity/OutsourcedProvider.php`
  - Fields: id, name, status, supportedActionTypes, latestDepartureTime, receptionTime, groupId, timestamps
  - Validation: time format, non-empty action types
  - Tests: `tests/Unit/Entity/OutsourcedProviderTest.php`

### Repository Layer

- [x] **Create OutsourcedProviderRepository**
  - File: `src/Repository/OutsourcedProviderRepository.php`
  - Methods: `findAllWithFilters()`, `isNameUnique()`, `isInUse()`

### Database Migration

- [x] **Create migration for outsourced_providers table**
  - File: `migrations/Version20251212130000.php`

### DTO Layer

- [x] **Create Provider DTOs**
  - Files: `src/DTO/Provider/*.php`
  - CreateProviderRequest, UpdateProviderRequest, ProviderResponse

### Service Layer

- [x] **Create OutsourcedProviderService**
  - File: `src/Service/OutsourcedProviderService.php`
  - Methods: `create()`, `update()`, `delete()`, `findById()`, `findAll()`
  - Auto-create StationGroup on provider creation

### Controller Layer

- [x] **Create ProviderController**
  - File: `src/Controller/Api/V1/ProviderController.php`
  - Routes: POST, GET (list), GET (single), PUT, DELETE
  - OpenAPI documentation

### Testing

- [x] **Unit tests**
  - ProviderStatus: 7 tests
  - OutsourcedProvider: 24 tests

- [x] **Integration tests**
  - 34 tests for ProviderController

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `ProviderStatusTest` | All enum values exist |
| | Status labels |
| `OutsourcedProviderTest` | Valid provider creation |
| | Name validation (non-empty, max length) |
| | Action types validation (non-empty array) |
| | Time format validation (HH:MM) |
| | Invalid time format rejected |
| | Default times applied |
| | Status changes |
| | Timestamps set on creation |

### Integration Tests

| Test Class | Test Cases |
|------------|------------|
| `ProviderControllerTest` | Create provider (201) |
| | Create provider creates group (201) |
| | Group has unlimited capacity |
| | Group marked as isOutsourcedProviderGroup |
| | Create without action types (400) |
| | Create with invalid time (400) |
| | Create duplicate name (409) |
| | List providers (200) |
| | List with search filter (200) |
| | List with status filter (200) |
| | List with action type filter (200) |
| | Get provider (200) |
| | Get not found (404) |
| | Update provider (200) |
| | Update status (200) |
| | Delete provider (204) |

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (401 tests, 1051 assertions)
- [x] All integration tests passing
- [x] OpenAPI documentation updated
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 8)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.6`

---

## Release Notes Draft

```markdown
## v0.1.6 – Outsourced Provider Entity

**Release Date:** 2025-12-12

### Summary

Implements the OutsourcedProvider aggregate root for managing external work providers.
Each provider automatically creates its own StationGroup with unlimited capacity,
enabling proper scheduling of outsourced tasks.

### What's New

- **OutsourcedProvider entity** - Name, status, supported action types, times
- **POST /api/v1/providers** - Create provider with auto-created station group
- **GET /api/v1/providers** - List providers with filters
- **GET /api/v1/providers/{id}** - Get provider details
- **PUT /api/v1/providers/{id}** - Update provider
- **DELETE /api/v1/providers/{id}** - Delete provider
- **ProviderStatus enum** - Active, Inactive states
- **Time-based fields** - latestDepartureTime (default 14:00), receptionTime (default 09:00)
- **Auto-created StationGroup** - Unlimited capacity, marked as provider group

### API Changes

New endpoints:
- `POST /api/v1/providers`
- `GET /api/v1/providers`
- `GET /api/v1/providers/{id}`
- `PUT /api/v1/providers/{id}`
- `DELETE /api/v1/providers/{id}`

### Breaking Changes

None

### Migration Guide

Run database migration to create outsourced_providers table:
```bash
php bin/console doctrine:migrations:migrate
```
```

---

## Post-Release

- [x] GitHub release created with notes
- [x] Verify API documentation updated
- [ ] Test provider endpoints via curl/Postman
- [ ] Proceed to v0.1.7 (Station Domain Events)
