# Release v0.1.14 – Approval Gates

> **Status:** ✅ Released
>
> **Milestone:** M1
>
> **Release Date:** 2025-12-13
>
> **Git Tag:** `v0.1.14`

---

## Overview

This release adds approval gate fields to the Job entity for BAT (Bon à Tirer) proof workflow and plates preparation tracking. These gates control when tasks can be scheduled according to business rules BR-GATE-001 through BR-GATE-003.

---

## Prerequisites

- [x] `v0.1.13` Autocomplete Data Endpoints released
- [x] Job entity exists with basic fields
- [x] JobService exists with CRUD operations

---

## Scope

### In Scope

- `proofSentAt` field on Job (nullable datetime or special values)
- `proofApprovedAt` field on Job (nullable datetime)
- `platesStatus` field on Job (PlatesStatus enum: Todo/Done)
- `PUT /api/v1/jobs/{id}/proof` endpoint for proof status updates
- `PUT /api/v1/jobs/{id}/plates` endpoint for plates status updates
- Business rule validation for approval gates
- Integration tests for new endpoints

### Out of Scope

- Scheduling validation (future release)
- Domain events (PlatesStatusUpdated, ProofStatusUpdated)
- Paper procurement fields (v0.1.15)
- UI components

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Acceptance Criteria](../requirements/acceptance-criteria.md) | AC-GATE-001 to AC-GATE-003 |
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 4.6 - Approval Gates |

### Domain Model

| Document | Sections |
|----------|----------|
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | Approval Gate, proofSentAt, proofApprovedAt, platesStatus |
| [Business Rules](../domain-model/business-rules.md) | BR-GATE-001, BR-GATE-002, BR-GATE-003 |
| [Workflow Definitions](../domain-model/workflow-definitions.md) | BAT Approval, Plates Approval |

### Architecture

| Document | Sections |
|----------|----------|
| [Interface Contracts](../architecture/interface-contracts.md) | UpdateProofStatus, UpdatePlatesStatus |

---

## Technical Notes

### proofSentAt Field

The `proofSentAt` field can have the following values:
- `null` - No proof sent yet (default)
- ISO-8601 datetime - Actual date/time proof was sent
- `"AwaitingFile"` - Waiting for client to provide file
- `"NoProofRequired"` - No proof needed, scheduling allowed

### PlatesStatus Enum

```php
enum PlatesStatus: string
{
    case Todo = 'Todo';
    case Done = 'Done';
}
```

### Business Rules

- **BR-GATE-001**: Tasks CANNOT be scheduled until `proofApprovedAt` is set OR `proofSentAt` is "NoProofRequired"
- **BR-GATE-002**: Printing tasks on offset stations CANNOT start until `platesStatus` is "Done"
- **BR-GATE-003**: When `proofSentAt` is "AwaitingFile", the job is waiting for client file and scheduling is blocked

---

## Feature Checklist

### Entity Changes

- [x] **PlatesStatus Enum**
  - Description: Enum with Todo/Done values
  - Files: `src/Entity/PlatesStatus.php`
  - Tests: `tests/Unit/Entity/PlatesStatusTest.php`

- [x] **ProofSentAt Value Type**
  - Description: Handle null, datetime, and special string values
  - Files: `src/Entity/Job.php`
  - Tests: Unit tests for validation

- [x] **Job Entity Fields**
  - Description: Add proofSentAt, proofApprovedAt, platesStatus to Job
  - Files: `src/Entity/Job.php`
  - Tests: Unit tests for getters/setters

### DTO Changes

- [x] **UpdateProofRequest DTO**
  - Description: Request DTO for proof status updates
  - Files: `src/DTO/Job/UpdateProofRequest.php`
  - Tests: Validation tests

- [x] **UpdatePlatesRequest DTO**
  - Description: Request DTO for plates status updates
  - Files: `src/DTO/Job/UpdatePlatesRequest.php`
  - Tests: Validation tests

- [x] **JobResponse DTO Update**
  - Description: Include new fields in job response
  - Files: `src/DTO/Job/JobResponse.php`
  - Tests: Covered by integration tests

### Service Layer

- [x] **JobService::updateProofStatus()**
  - Description: Update proofSentAt and/or proofApprovedAt
  - Files: `src/Service/JobService.php`
  - Tests: Covered by integration tests

- [x] **JobService::updatePlatesStatus()**
  - Description: Update platesStatus
  - Files: `src/Service/JobService.php`
  - Tests: Covered by integration tests

### Controller Endpoints

- [x] **PUT /api/v1/jobs/{id}/proof**
  - Description: Update proof status (proofSentAt and/or proofApprovedAt)
  - Files: `src/Controller/Api/V1/JobController.php`
  - Tests: Integration tests

- [x] **PUT /api/v1/jobs/{id}/plates**
  - Description: Update plates status
  - Files: `src/Controller/Api/V1/JobController.php`
  - Tests: Integration tests

### Database Migration

- [x] **Add approval gate columns**
  - Description: Migration for proofSentAt, proofApprovedAt, platesStatus
  - Files: `migrations/Version20251213020000.php`
  - Tests: N/A

---

## Testing Requirements

### Unit Tests

- [x] PlatesStatus enum values
- [x] Job.setProofSentAt() with datetime
- [x] Job.setProofSentAt() with "AwaitingFile"
- [x] Job.setProofSentAt() with "NoProofRequired"
- [x] Job.setProofApprovedAt() requires proofSentAt
- [x] Job.setPlatesStatus() transitions
- [x] Job.isBatApproved() helper method
- [x] Job.arePlatesReady() helper method
- [x] Job.isAwaitingFile() helper method

### Integration Tests

- [x] PUT /api/v1/jobs/{id}/proof with datetime
- [x] PUT /api/v1/jobs/{id}/proof with "NoProofRequired"
- [x] PUT /api/v1/jobs/{id}/proof with "AwaitingFile"
- [x] PUT /api/v1/jobs/{id}/proof setting proofApprovedAt
- [x] PUT /api/v1/jobs/{id}/proof validation (approve without sending)
- [x] PUT /api/v1/jobs/{id}/plates with "Done"
- [x] PUT /api/v1/jobs/{id}/plates with "Todo"
- [x] GET /api/v1/jobs/{id} includes new fields
- [x] Job not found returns 404

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] Documentation updated
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.14`
- [x] GitHub release created

---

## Release Notes Draft

```markdown
## v0.1.14 – Approval Gates

**Release Date:** 2025-12-13

### Summary

Adds approval gate fields to Job entity for BAT proof workflow and plates preparation tracking.

### What's New

- `proofSentAt` field - tracks when proof was sent (or "AwaitingFile" / "NoProofRequired")
- `proofApprovedAt` field - tracks when proof was approved
- `platesStatus` field - Todo/Done enum for plates preparation
- `PUT /api/v1/jobs/{id}/proof` - Update proof status
- `PUT /api/v1/jobs/{id}/plates` - Update plates status

### API Changes

**New Endpoints:**
```
PUT /api/v1/jobs/{id}/proof
  { "proofSentAt": "2025-12-14T10:00:00Z" }
  { "proofSentAt": "NoProofRequired" }
  { "proofApprovedAt": "2025-12-14T14:00:00Z" }

PUT /api/v1/jobs/{id}/plates
  { "platesStatus": "Done" }
```

### Breaking Changes

None
```

---

## Post-Release

- [x] GitHub release created
- [x] Submodule reference updated in monorepo
- [x] Documentation verified
