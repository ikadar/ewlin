# Release v0.2.9 – Validation Service Docker

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.2.9`

---

## Overview

This release containerizes the Validation Service using Docker, enabling consistent deployment and integration with the existing Docker Compose infrastructure. The service will be accessible on port 3001 and integrate with the flux-network.

Key features:
- Production-ready Dockerfile for Validation Service
- Docker Compose integration
- Environment variable configuration
- Health check endpoint integration
- Multi-stage build for optimized image size

---

## Prerequisites

- [x] `v0.2.8` released (Validation API Endpoint)
- [x] `v0.2.7.1` released (Git submodule conversion)
- [x] Existing Docker infrastructure (docker-compose.yml)
- [x] Node.js base Dockerfile exists (`docker/node/Dockerfile`)

---

## Scope

### In Scope

- Dockerfile for validation-service (multi-stage build)
- Docker Compose service configuration
- Environment variable configuration (PORT, NODE_ENV)
- Health check configuration using GET /health
- Integration with flux-network
- .dockerignore file

### Out of Scope

- Kubernetes deployment (M4)
- CI/CD Docker image publishing (already in docker.yml workflow)
- Load balancing / scaling (M4)
- TLS/HTTPS configuration (M4)

---

## Related Documentation

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-009, ADR-010 |
| [Docker README](../../docker/README.md) | Service documentation |

---

## Technical Notes

### Dockerfile Strategy

Multi-stage build for optimized production image:

```dockerfile
# Stage 1: Build
FROM node:22-alpine AS builder
# Install dependencies and build TypeScript

# Stage 2: Production
FROM node:22-alpine AS production
# Copy only necessary files
# Run as non-root user
```

### Docker Compose Service

```yaml
validation-service:
  build:
    context: .  # Monorepo root for workspace dependencies
    dockerfile: services/validation-service/Dockerfile
  container_name: flux-validation-service
  restart: unless-stopped
  ports:
    - "${VALIDATION_SERVICE_PORT:-3001}:3001"
  environment:
    NODE_ENV: production
    PORT: 3001
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 10s
  networks:
    - flux-network
```

> **Note:** Build context is the monorepo root to include workspace dependencies (@flux/types, @flux/schedule-validator).

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | `3001` | HTTP server port |
| `NODE_ENV` | `production` | Node.js environment |
| `VALIDATION_SERVICE_PORT` | `3001` | External port mapping |

### Files to Create/Modify

```
services/validation-service/
├── Dockerfile           # NEW: Multi-stage production build
└── .dockerignore        # NEW: Exclude unnecessary files (service-level)

.dockerignore            # NEW: Root-level exclusions for monorepo context
docker-compose.yml       # MODIFY: Add validation-service
.env.example             # MODIFY: Add VALIDATION_SERVICE_PORT
docker/README.md         # MODIFY: Document validation-service
```

---

## Feature Checklist

### Dockerfile

- [x] **Create multi-stage Dockerfile**
  - Description: Production-optimized Docker image with workspace dependencies
  - Files: `services/validation-service/Dockerfile`

- [x] **Create .dockerignore**
  - Description: Exclude dev files from Docker build (root + service-level)
  - Files: `.dockerignore`, `services/validation-service/.dockerignore`

### Docker Compose

- [x] **Add validation-service to docker-compose.yml**
  - Description: Service configuration with health check (monorepo root context)
  - Files: `docker-compose.yml`

### Environment

- [x] **Update .env.example**
  - Description: Add VALIDATION_SERVICE_PORT variable
  - Files: `.env.example`

### Documentation

- [x] **Update docker/README.md**
  - Description: Document validation-service container
  - Files: `docker/README.md`

---

## Testing Requirements

### Manual Testing

- [x] `docker compose build validation-service` succeeds
- [x] `docker compose up validation-service` starts container
- [x] Health check passes (`curl http://localhost:3001/health`)
- [x] POST /validate endpoint works from container
- [ ] Container restarts on failure (not tested)
- [x] Logs are visible via `docker compose logs validation-service`

### Integration Testing

- [x] Service connects to flux-network
- [ ] Service accessible from other containers by name (not tested)
- [x] Environment variables are properly passed

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] Docker build succeeds
- [x] Container starts and health check passes
- [x] Manual testing completed
- [ ] Code reviewed and approved
- [ ] CHANGELOG.md updated (validation-service repo)
- [ ] Git tag created: `v0.2.9`

---

## Release Notes Draft

```markdown
## v0.2.9 – Validation Service Docker

**Release Date:** 2025-12-14

### Summary

Containerizes the Validation Service with a production-ready Docker image and Docker Compose integration.

### What's New

- Multi-stage Dockerfile for optimized image size
- Docker Compose service configuration
- Health check integration
- Environment variable configuration

### Docker Usage

```bash
# Build and start the service
docker compose up -d validation-service

# Check health
curl http://localhost:3001/health

# View logs
docker compose logs -f validation-service
```

### Configuration

| Variable | Default | Description |
|----------|---------|-------------|
| `VALIDATION_SERVICE_PORT` | `3001` | External port |
| `NODE_ENV` | `production` | Environment |
```

---

## Post-Release

- [ ] GitHub release created (validation-service repo)
- [ ] Monorepo updated
- [ ] Docker image tested locally
- [ ] docker/README.md updated
