# Release v0.1.17 â€“ Job Comments

> **Status:** ðŸŸ¢ Released
>
> **Milestone:** M1 (Core Domain MVP - Job Management)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.1.17`

---

## Overview

This release adds comments to jobs, allowing operators and managers to leave notes and observations on jobs. Comments are immutable once created (no edit/delete) and form an audit trail.

Key features:
- Comment entity within Job aggregate
- Add comment API endpoint
- List comments for a job
- Author and timestamp tracking

---

## Prerequisites

- [x] `v0.1.16` released (Job Dependencies)

---

## Scope

### In Scope

- Comment entity (id, jobId, author, content, createdAt)
- POST /api/v1/jobs/{id}/comments endpoint (add comment)
- GET /api/v1/jobs/{id}/comments endpoint (list comments)
- Comment immutability (no edit/delete endpoints)
- Author and timestamp recording

### Out of Scope

- Threaded/nested comments (future enhancement)
- Comment editing or deletion (by design - COM-001)
- User authentication (author is a string field for now)
- Notifications on new comments
- Attachments to comments

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | COM-001, COM-002 |

---

## Technical Notes

### Comment Entity

Comments are entities within the Job aggregate. They have their own identity (UUID) but are always accessed through their parent Job.

```php
#[ORM\Entity]
#[ORM\Table(name: 'job_comments')]
class JobComment
{
    #[ORM\Id]
    #[ORM\Column(type: 'string', length: 36)]
    private string $id;

    #[ORM\ManyToOne(targetEntity: Job::class, inversedBy: 'comments')]
    #[ORM\JoinColumn(nullable: false, onDelete: 'CASCADE')]
    private Job $job;

    #[ORM\Column(type: 'string', length: 100)]
    private string $author;

    #[ORM\Column(type: 'text')]
    private string $content;

    #[ORM\Column(type: 'datetime_immutable')]
    private \DateTimeImmutable $createdAt;
}
```

### API Design

**POST /api/v1/jobs/{id}/comments**
- Request body: `{ "author": "John Doe", "content": "This is a comment" }`
- Returns 201 with created comment
- Returns 404 if job not found
- Returns 400 if validation fails

**GET /api/v1/jobs/{id}/comments**
- Returns list of comments ordered by createdAt DESC (newest first)
- Returns 404 if job not found

---

## Feature Checklist

### Entity

- [x] **Create JobComment entity**
  - Description: Comment entity with id, author, content, createdAt
  - Files: `src/Entity/JobComment.php`
  - Migration: `migrations/Version20251214050000.php`

- [x] **Add comments relationship to Job**
  - Description: OneToMany relationship from Job to JobComment
  - Files: `src/Entity/Job.php`

### Repository

- [x] **Create JobCommentRepository**
  - Description: Repository for JobComment entity
  - Files: `src/Repository/JobCommentRepository.php`

### DTOs

- [x] **Create AddCommentRequest DTO**
  - Description: Request body for POST /comments endpoint
  - Files: `src/DTO/Job/AddCommentRequest.php`

- [x] **Create CommentResponse DTO**
  - Description: Response format for comments
  - Files: `src/DTO/Job/CommentResponse.php`

### Service Layer

- [x] **Create CommentService**
  - Description: Service for adding and listing comments
  - Files: `src/Service/CommentService.php`

### API Endpoints

- [x] **POST /api/v1/jobs/{id}/comments**
  - Description: Add a comment to a job
  - Files: `src/Controller/Api/V1/JobController.php`

- [x] **GET /api/v1/jobs/{id}/comments**
  - Description: List all comments for a job
  - Files: `src/Controller/Api/V1/JobController.php`

---

## Testing Requirements

### Unit Tests

- [x] JobComment entity: creation with all fields
- [x] JobComment entity: immutability (no setters)
- [x] Job entity: addComment() method
- [x] Job entity: getComments() returns ordered collection
- [x] CommentService: addComment() validation
- [x] CommentService: getComments() ordering

### Integration Tests

- [x] POST /comments - add comment success
- [x] POST /comments - 404 when job not found
- [x] POST /comments - 400 when author missing
- [x] POST /comments - 400 when content missing
- [x] POST /comments - 400 when content too long (max 5000 chars)
- [x] GET /comments - list comments success
- [x] GET /comments - empty list when no comments
- [x] GET /comments - 404 when job not found
- [x] POST /comments - 400 when author too long (max 100 chars)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.17`

---

## Release Notes Draft

```markdown
## v0.1.17 â€“ Job Comments

**Release Date:** 2025-12-14

### Summary

Adds comment functionality to jobs, allowing operators and managers to leave notes and observations. Comments are immutable and form an audit trail.

### What's New

- JobComment entity within Job aggregate
- POST /api/v1/jobs/{id}/comments - add comment to a job
- GET /api/v1/jobs/{id}/comments - list comments (newest first)
- Author and timestamp tracking

### Business Rules Implemented

- COM-001: Comment immutability (no edit/delete)
- COM-002: Comment author and timestamp recording
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo docs committed
- [x] CI verified
