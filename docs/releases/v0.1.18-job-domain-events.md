# Release v0.1.18 â€“ Job Domain Events

> **Status:** ðŸŸ¢ Released
>
> **Milestone:** M1 (Core Domain MVP - Job Management)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.1.18`

---

## Overview

This release adds domain events to the Job aggregate, enabling event-driven architecture patterns. Domain events capture significant state changes in jobs, tasks, and approval gates, providing an audit trail and enabling future integrations.

Key features:
- JobCreated event - emitted when a new job is created
- TaskAddedToJob event - emitted when a task is added to a job
- ApprovalGateUpdated event - emitted when proof/plates/paper status changes
- JobCancelled event - emitted when job is cancelled
- RecordsDomainEvents trait integration with Job entity

---

## Prerequisites

- [x] `v0.1.17` released (Job Comments)
- [x] `v0.1.7` released (Station Domain Events - pattern established)

---

## Scope

### In Scope

- JobCreated event (jobId, reference, client, workshopExitDate)
- TaskAddedToJob event (jobId, taskId, taskType, sequenceOrder)
- ApprovalGateUpdated event (jobId, gateType, previousValue, newValue)
- JobCancelled event (jobId, recalledTaskIds, preservedTaskIds)
- RecordsDomainEvents trait on Job entity
- Event recording on Job constructor and key state changes
- Unit tests for all events

### Out of Scope

- Event handlers/subscribers (just recording for now)
- Event persistence (events recorded in-memory only)
- Task assignment events (M2 - Assignment Service)
- Actual task recall logic (v0.1.19)

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-JOB-*, BR-GATE-*, BR-PAPER-* |

### Architecture

| Document | Sections |
|----------|----------|
| Station Domain Events | v0.1.7 implementation pattern |

---

## Technical Notes

### Event Pattern

Following the Station domain events pattern from v0.1.7:
- All events extend `DomainEvent` abstract class
- Events are immutable and self-contained
- Events recorded via `RecordsDomainEvents` trait
- Events can be pulled after entity persistence

### Event Definitions

**JobCreated** - emitted in Job constructor:
```php
new JobCreated(
    jobId: $this->id,
    reference: $this->reference,
    client: $this->client,
    workshopExitDate: $this->workshopExitDate->format('Y-m-d'),
)
```

**TaskAddedToJob** - emitted in addInternalTask/addOutsourcedTask:
```php
new TaskAddedToJob(
    jobId: $this->id,
    taskId: $task->getId(),
    taskType: $task->getType()->value,
    sequenceOrder: $task->getSequenceOrder(),
)
```

**ApprovalGateUpdated** - emitted on proof/plates/paper changes:
```php
new ApprovalGateUpdated(
    jobId: $this->id,
    gateType: 'proof_sent' | 'proof_approved' | 'plates_status' | 'paper_status',
    previousValue: $previousValue,
    newValue: $newValue,
)
```

**JobCancelled** - emitted when status changes to Cancelled:
```php
new JobCancelled(
    jobId: $this->id,
    recalledTaskIds: [], // Future: tasks with scheduled assignments
    preservedTaskIds: [], // Future: tasks already completed
)
```

---

## Feature Checklist

### Domain Events

- [x] **Create JobCreated event**
  - Description: Event emitted when a new job is created
  - Files: `src/Event/Job/JobCreated.php`

- [x] **Create TaskAddedToJob event**
  - Description: Event emitted when a task is added to a job
  - Files: `src/Event/Job/TaskAddedToJob.php`

- [x] **Create ApprovalGateUpdated event**
  - Description: Event emitted when approval gate status changes
  - Files: `src/Event/Job/ApprovalGateUpdated.php`

- [x] **Create JobCancelled event**
  - Description: Event emitted when job is cancelled
  - Files: `src/Event/Job/JobCancelled.php`

### Entity Integration

- [x] **Add RecordsDomainEvents trait to Job**
  - Description: Enable domain event recording on Job entity
  - Files: `src/Entity/Job.php`

- [x] **Record JobCreated in constructor**
  - Description: Emit event when job is created
  - Files: `src/Entity/Job.php`

- [x] **Record TaskAddedToJob in addInternalTask/addOutsourcedTask**
  - Description: Emit event when tasks are added
  - Files: `src/Entity/Job.php`

- [x] **Record ApprovalGateUpdated on state changes**
  - Description: Emit event when proof/plates/paper status changes
  - Files: `src/Entity/Job.php`

- [x] **Record JobCancelled on status change to Cancelled**
  - Description: Emit event when job is cancelled
  - Files: `src/Entity/Job.php`

---

## Testing Requirements

### Unit Tests

- [x] JobCreated event: creation with all fields
- [x] JobCreated event: getEventName() returns correct name
- [x] JobCreated event: toArray() contains all fields
- [x] TaskAddedToJob event: creation with all fields
- [x] TaskAddedToJob event: getEventName() returns correct name
- [x] TaskAddedToJob event: toArray() contains all fields
- [x] ApprovalGateUpdated event: creation with all fields
- [x] ApprovalGateUpdated event: all gate types
- [x] ApprovalGateUpdated event: toArray() contains all fields
- [x] JobCancelled event: creation with all fields
- [x] JobCancelled event: getEventName() returns correct name
- [x] JobCancelled event: toArray() contains all fields
- [x] Job entity: records JobCreated on construction
- [x] Job entity: records TaskAddedToJob when task added
- [x] Job entity: records ApprovalGateUpdated on proof changes
- [x] Job entity: records ApprovalGateUpdated on plates changes
- [x] Job entity: records ApprovalGateUpdated on paper changes
- [x] Job entity: records JobCancelled on status change to Cancelled
- [x] Job entity: no event when status unchanged
- [x] Job entity: events cleared after pull

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.1.18`

---

## Release Notes Draft

```markdown
## v0.1.18 â€“ Job Domain Events

**Release Date:** 2025-12-14

### Summary

Adds domain events to the Job aggregate, capturing significant state changes for audit trails and future event-driven integrations.

### What's New

- JobCreated event - emitted when a new job is created
- TaskAddedToJob event - emitted when a task is added to a job
- ApprovalGateUpdated event - emitted when proof/plates/paper status changes
- JobCancelled event - emitted when job status changes to Cancelled
- RecordsDomainEvents trait integration with Job entity

### Technical

- Follows established pattern from Station domain events (v0.1.7)
- Events are immutable and self-contained
- All events extend DomainEvent base class
- Symfony Messenger integration ready
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo docs committed
- [x] CI verified
