# Release v0.2.17 – Assignment Domain Events

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.2.17`

---

## Overview

This release completes the Assignment Domain Events by adding the remaining two events: ConflictDetected and ScheduleUpdated. The other four events (TaskAssigned, TaskUnassigned, TaskRescheduled, TaskCompletionToggled) were already implemented in v0.2.10 and v0.2.14.

Key deliverables:
- ConflictDetected event - emitted when validation detects conflicts
- ScheduleUpdated event - generic event for any schedule change
- Event integration with Schedule entity
- Unit tests for new events

---

## Prerequisites

- [x] `v0.2.16` released (Business Calendar API)
- [x] TaskAssigned event (v0.2.10)
- [x] TaskUnassigned event (v0.2.10)
- [x] TaskRescheduled event (v0.2.14)
- [x] TaskCompletionToggled event (v0.2.10)
- [x] ValidationConflict DTO

---

## Scope

### In Scope

- ConflictDetected event with conflict details
- ScheduleUpdated event for generic schedule changes
- Event recording in Schedule entity
- Unit tests for both events
- Integration with existing event infrastructure

### Out of Scope

- Event handlers/listeners (future release)
- Event persistence (event sourcing)
- Event publishing to message queue
- Real-time notifications

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-007 (schedule versioning) |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |

---

## Technical Notes

### ConflictDetected Event

Emitted when the Validation Service returns conflicts during assignment/reschedule. Contains the conflict details for logging/monitoring.

```php
new ConflictDetected(
    scheduleId: 'schedule-uuid',
    taskId: 'task-uuid',
    targetId: 'station-uuid',
    conflictType: 'StationConflict',
    message: 'Station already has a task at this time',
    relatedTaskId: 'other-task-uuid',
);
```

### ScheduleUpdated Event

Generic event emitted after any schedule modification. Useful for cache invalidation and notifications.

```php
new ScheduleUpdated(
    scheduleId: 'schedule-uuid',
    version: 42,
    changeType: 'assignment', // assignment, unassignment, reschedule, completion
    affectedTaskIds: ['task-1', 'task-2'],
);
```

### Event Usage

- **ConflictDetected**: Emitted by AssignmentService when validation returns conflicts
- **ScheduleUpdated**: Emitted by Schedule entity after any state change

---

## Feature Checklist

### Events

- [x] **ConflictDetected Event**
  - Description: Event for validation conflicts
  - Files: `src/Event/Schedule/ConflictDetected.php`
  - Tests: `tests/Unit/Event/Schedule/ConflictDetectedTest.php`

- [x] **ScheduleUpdated Event**
  - Description: Generic schedule change event
  - Files: `src/Event/Schedule/ScheduleUpdated.php`
  - Tests: `tests/Unit/Event/Schedule/ScheduleUpdatedTest.php`

### Integration

- [x] **Schedule Entity Integration**
  - Description: Record ScheduleUpdated event on changes
  - Files: `src/Entity/Schedule.php` (modify)
  - Tests: `tests/Unit/Entity/ScheduleTest.php` (add tests)

---

## Testing Requirements

### Unit Tests

- [x] ConflictDetected - event construction with all fields
- [x] ConflictDetected - getEventName returns correct name
- [x] ConflictDetected - toArray includes all fields
- [x] ConflictDetected - handles null relatedTaskId
- [x] ScheduleUpdated - event construction with all fields
- [x] ScheduleUpdated - getEventName returns correct name
- [x] ScheduleUpdated - toArray includes all fields
- [x] ScheduleUpdated - handles empty affectedTaskIds
- [x] Schedule entity - records ScheduleUpdated on assignTask
- [x] Schedule entity - records ScheduleUpdated on unassignTask
- [x] Schedule entity - records ScheduleUpdated on rescheduleTask
- [x] Schedule entity - records ScheduleUpdated on toggleTaskCompletion

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.17`

---

## Release Notes Draft

```markdown
## v0.2.17 – Assignment Domain Events

**Release Date:** 2025-12-14

### Summary

Completes the Assignment Domain Events with ConflictDetected and ScheduleUpdated events.

### What's New

- **ConflictDetected** - Event emitted when validation detects conflicts
- **ScheduleUpdated** - Generic event for schedule changes

### Technical

- Full event infrastructure for schedule changes
- Supports conflict logging and monitoring
- PHPStan level 8 compliant
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo updated
- [ ] Next release (v0.2.18 - Task Completion Toggle) ready to start
