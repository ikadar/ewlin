# Release v0.1.0 – Station Entity

> **Status:** ✅ Released
>
> **Milestone:** M1 (Core Domain MVP)
>
> **Release Date:** 2025-12-12
>
> **Git Tag:** `v0.1.0`

---

## Overview

This release introduces the **Station** aggregate root to the PHP/Symfony backend. A Station represents a physical machine or workstation in the print shop (e.g., "Komori G37" offset press, "Massicot" cutter). This is the foundational entity of the Station Management bounded context.

### Why This Matters

- Stations are **required before any scheduling** can occur
- All internal tasks reference a Station
- Station operating schedules determine **when tasks can be scheduled**
- Station status controls **availability for new assignments**

---

## Prerequisites

- [x] `v0.0.7` released (CI Fixes, all M0 infrastructure complete)
- [x] `v0.0.8` released (Repository restructuring with git submodules)
- [x] Docker containers running (MariaDB, Redis, PHP-FPM, Nginx)
- [x] Symfony 7 project initialized (`services/php-api/`)
- [x] StationCategory entity exists (created in this release)
- [x] StationGroup entity exists (created in this release)

> **Note:** v0.1.0 created Station, StationCategory, and StationGroup together as they are interdependent. A Station cannot exist without a Category and Group.

---

## Scope

### In Scope

| Item | Description |
|------|-------------|
| Station Entity | PHP entity class with all attributes |
| StationStatus Enum | Available, InUse, Maintenance, OutOfService |
| Station Repository | Doctrine repository with basic queries |
| Database Migration | Create `stations` table |
| Unit Tests | Entity validation, status transitions |
| Stub References | CategoryId and GroupId as string references (entities in next releases) |

### Out of Scope

| Item | Reason |
|------|--------|
| API Endpoints | Covered in v0.1.1 |
| OperatingSchedule | Covered in v0.1.2 |
| Schedule Exceptions | Covered in v0.1.3 |
| StationCategory full entity | Covered in v0.1.4 (stub only here) |
| StationGroup full entity | Covered in v0.1.5 (stub only here) |
| Domain Events | Covered in v0.1.7 |

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Domain Model](../domain-model/domain-model.md) | Station (Aggregate Root), StationStatus |
| [Domain Vocabulary](../domain-model/domain-vocabulary.md) | Station, StationCategory, StationGroup, OperatingSchedule |
| [Business Rules](../domain-model/business-rules.md) | BR-STATION-001 through BR-STATION-008 |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-005 (Technology Stack), ADR-006 (Aggregates), ADR-007 (Repository Interfaces) |
| [Service Boundaries](../architecture/service-boundaries.md) | Station Management Service |

### API

| Document | Sections |
|----------|----------|
| [API Interface Drafts](../requirements/api-interface-drafts.md) | Section 1: Station Management API |

---

## Domain Model Reference

### Station (Aggregate Root)

```
┌─────────────────────────────────────────────────────────────┐
│                         Station                              │
├─────────────────────────────────────────────────────────────┤
│  id: StationId (UUID)                                       │
│  name: string                                                │
│  status: StationStatus                                       │
│  categoryId: StationCategoryId                              │
│  groupId: StationGroupId                                    │
│  capacity: integer (default: 1)                             │
│  operatingSchedule: OperatingSchedule (JSON) [v0.1.2]       │
│  exceptions: ScheduleException[] [v0.1.3]                   │
│  createdAt: DateTime                                        │
│  updatedAt: DateTime                                        │
├─────────────────────────────────────────────────────────────┤
│  + changeName(name: string): void                           │
│  + changeStatus(status: StationStatus): void                │
│  + updateOperatingSchedule(schedule): void [v0.1.2]         │
│  + addException(exception): void [v0.1.3]                   │
│  + isAvailable(): boolean                                   │
│  + canAcceptTask(): boolean                                 │
└─────────────────────────────────────────────────────────────┘
```

### StationStatus Enum

| Value | Description | Can Accept Tasks? |
|-------|-------------|-------------------|
| `Active` | Station is operational and ready | ✅ Yes |
| `Inactive` | Station is temporarily disabled | ❌ No |
| `Maintenance` | Station is under scheduled maintenance | ❌ No |
| `OutOfService` | Station is broken or decommissioned | ❌ No |

### State Transitions

```
                    ┌──────────────┐
                    │    Active    │◄────────────────┐
                    └──────┬───────┘                 │
                           │                         │
              ┌────────────┼────────────┐           │
              │            │            │           │
              ▼            ▼            ▼           │
        ┌──────────┐ ┌───────────┐  ┌─────────────┐│
        │ Inactive │ │Maintenance│  │OutOfService ││
        └────┬─────┘ └─────┬─────┘  └──────┬──────┘│
             │             │               │       │
             └─────────────┴───────────────┴───────┘
                      (all can return to Active)
```

---

## Business Rules (v0.1.0 Scope)

| Rule ID | Description | Enforcement |
|---------|-------------|-------------|
| **BR-STATION-001** | Station must have a unique identifier | Database: UUID primary key |
| **BR-STATION-002** | Station must belong to a category | Entity: Required field, DB: NOT NULL |
| **BR-STATION-003** | Station must belong to a group | Entity: Required field, DB: NOT NULL |
| **BR-STATION-007** | Only Available status can accept tasks | Method: `canAcceptTask()` returns false for other statuses |

### Rules Deferred to Later Releases

| Rule ID | Description | Release |
|---------|-------------|---------|
| BR-STATION-004 | Operating schedule required | v0.1.2 |
| BR-STATION-005 | Schedule slots cannot overlap | v0.1.2 |
| BR-STATION-006 | One task at a time (capacity=1) | v0.2.x (Assignment) |
| BR-STATION-008 | Exceptions override schedule | v0.1.3 |

---

## Database Schema

### Table: `stations`

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `CHAR(36)` | PRIMARY KEY | UUID v4 |
| `name` | `VARCHAR(100)` | NOT NULL, UNIQUE | Display name |
| `status` | `VARCHAR(20)` | NOT NULL, DEFAULT 'Available' | StationStatus enum |
| `category_id` | `CHAR(36)` | NOT NULL | FK to station_categories (stub) |
| `group_id` | `CHAR(36)` | NOT NULL | FK to station_groups (stub) |
| `capacity` | `TINYINT UNSIGNED` | NOT NULL, DEFAULT 1 | Concurrent task limit |
| `operating_schedule` | `JSON` | NULL | Weekly pattern (v0.1.2) |
| `created_at` | `DATETIME` | NOT NULL | Creation timestamp |
| `updated_at` | `DATETIME` | NOT NULL | Last update timestamp |

### Indexes

| Name | Columns | Type | Purpose |
|------|---------|------|---------|
| `PRIMARY` | `id` | Primary | Unique identifier |
| `idx_station_name` | `name` | Unique | Ensure unique names |
| `idx_station_category` | `category_id` | Index | Category lookups |
| `idx_station_group` | `group_id` | Index | Group lookups |
| `idx_station_status` | `status` | Index | Filter by status |

### Stub Tables (Minimal for FK)

#### Table: `station_categories` (stub)

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `CHAR(36)` | PRIMARY KEY |
| `name` | `VARCHAR(100)` | NOT NULL |

#### Table: `station_groups` (stub)

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `CHAR(36)` | PRIMARY KEY |
| `name` | `VARCHAR(100)` | NOT NULL |
| `max_concurrent` | `TINYINT UNSIGNED` | NULL (null = unlimited) |

---

## Entity Design

### Station Entity

```php
namespace App\Entity;

#[ORM\Entity(repositoryClass: StationRepository::class)]
#[ORM\Table(name: 'stations')]
#[ORM\HasLifecycleCallbacks]
class Station
{
    #[ORM\Id]
    #[ORM\Column(type: 'guid')]
    private string $id;

    #[ORM\Column(length: 100, unique: true)]
    private string $name;

    #[ORM\Column(length: 20, enumType: StationStatus::class)]
    private StationStatus $status;

    #[ORM\Column(name: 'category_id', type: 'guid')]
    private string $categoryId;

    #[ORM\Column(name: 'group_id', type: 'guid')]
    private string $groupId;

    #[ORM\Column(type: 'smallint', options: ['unsigned' => true, 'default' => 1])]
    private int $capacity = 1;

    #[ORM\Column(type: 'json', nullable: true)]
    private ?array $operatingSchedule = null;

    #[ORM\Column(name: 'created_at', type: 'datetime_immutable')]
    private \DateTimeImmutable $createdAt;

    #[ORM\Column(name: 'updated_at', type: 'datetime_immutable')]
    private \DateTimeImmutable $updatedAt;

    // Constructor, getters, domain methods...
}
```

### StationStatus Enum

```php
namespace App\Entity;

enum StationStatus: string
{
    case Active = 'active';
    case Inactive = 'inactive';
    case OutOfService = 'out_of_service';
    case Maintenance = 'maintenance';

    public function canAcceptTasks(): bool
    {
        return $this === self::Active;
    }

    public function label(): string
    {
        return match ($this) {
            self::Active => 'Active',
            self::Inactive => 'Inactive',
            self::OutOfService => 'Out of Service',
            self::Maintenance => 'Maintenance',
        };
    }
}
```

---

## File Structure

```
services/php-api/
├── src/
│   ├── Entity/
│   │   ├── Station.php                    # Station aggregate root
│   │   ├── StationStatus.php              # Status enum
│   │   ├── StationCategory.php            # Stub entity
│   │   └── StationGroup.php               # Stub entity
│   ├── Repository/
│   │   ├── StationRepository.php          # Station repository
│   │   ├── StationCategoryRepository.php  # Stub repository
│   │   └── StationGroupRepository.php     # Stub repository
│   └── ...
├── migrations/
│   └── Version20251212000000.php          # Create tables migration
└── tests/
    └── Unit/
        └── Entity/
            ├── StationTest.php            # Station unit tests
            └── StationStatusTest.php      # Enum tests
```

---

## Feature Checklist

### Entity Layer

- [x] **Create StationStatus enum**
  - Description: Enum with Active, Inactive, OutOfService, Maintenance values
  - File: `src/Entity/StationStatus.php`
  - Tests: `tests/Unit/Entity/StationStatusTest.php`

- [x] **Create Station entity**
  - Description: Aggregate root with all attributes and domain methods
  - File: `src/Entity/Station.php`
  - Tests: `tests/Unit/Entity/StationTest.php`

- [x] **Create StationCategory stub entity**
  - Description: Minimal entity for FK reference
  - File: `src/Entity/StationCategory.php`
  - Tests: None (stub only)

- [x] **Create StationGroup stub entity**
  - Description: Minimal entity with maxConcurrent setting
  - File: `src/Entity/StationGroup.php`
  - Tests: None (stub only)

### Repository Layer

- [x] **Create StationRepository**
  - Description: Doctrine repository with findByStatus, findByGroup, findByCategory, findActiveStations, findByCode
  - File: `src/Repository/StationRepository.php`
  - Tests: Integration tests (v0.1.1)

- [x] **Create stub repositories**
  - Description: Minimal repositories for category and group
  - Files: `src/Repository/StationCategoryRepository.php`, `StationGroupRepository.php`
  - Tests: None (stub only)

### Database

- [x] **Create database migration**
  - Description: Create stations, station_categories, station_groups tables
  - File: `migrations/Version20251212000000.php`
  - Tests: Migration runs successfully

### Domain Methods

- [x] **Implement Station::changeName()**
  - Description: Update station name with validation
  - Validation: Non-empty, max 100 chars
  - Tests: Valid/invalid name scenarios

- [x] **Implement Station::changeStatus()**
  - Description: Update station status
  - Validation: Valid StationStatus value
  - Tests: All status transitions

- [x] **Implement Station::isAvailable()**
  - Description: Returns true if status is Active
  - Tests: All status cases

- [x] **Implement Station::canAcceptTask()**
  - Description: Returns true if station can accept new task assignments
  - Logic: `status === Active`
  - Tests: All status cases

---

## Testing Requirements

### Unit Tests

| Test Class | Test Cases |
|------------|------------|
| `StationStatusTest` | All enum values exist |
| | `canAcceptTasks()` returns correct boolean |
| `StationTest` | Constructor sets all required fields |
| | `changeName()` updates name |
| | `changeName()` rejects empty name |
| | `changeName()` rejects name > 100 chars |
| | `changeStatus()` updates status |
| | `isAvailable()` returns true for Available |
| | `isAvailable()` returns false for other statuses |
| | `canAcceptTask()` returns correct values |
| | Timestamps are set on creation |

### Integration Tests (Deferred to v0.1.1)

- [ ] StationRepository::save() persists to database
- [ ] StationRepository::findById() retrieves station
- [ ] StationRepository::findByStatus() filters correctly
- [ ] Unique name constraint enforced

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (50 tests, 88 assertions)
- [x] Migration runs successfully on clean database
- [x] Code follows Symfony best practices
- [x] PHPStan passes (level 5+)
- [x] CHANGELOG.md updated
- [x] Release document completed
- [x] Git tag created: `v0.1.0`

---

## Technical Notes

### UUID Generation

Use `symfony/uid` for UUID generation:
```php
use Symfony\Component\Uid\Uuid;

$station = new Station(
    id: Uuid::v4()->toRfc4122(),
    name: 'Komori G37',
    // ...
);
```

### Timestamps

Use Doctrine lifecycle callbacks:
```php
#[ORM\PrePersist]
public function setCreatedAt(): void
{
    $this->createdAt = new \DateTimeImmutable();
    $this->updatedAt = new \DateTimeImmutable();
}

#[ORM\PreUpdate]
public function setUpdatedAt(): void
{
    $this->updatedAt = new \DateTimeImmutable();
}
```

### Operating Schedule (Placeholder)

The `operating_schedule` JSON column will be used in v0.1.2. For now:
- Column exists but is nullable
- Default value is `null`
- Structure will be defined in v0.1.2

---

## Release Notes

```markdown
## v0.1.0 – Station Entity

**Release Date:** 2025-12-12

### Summary

Introduces the Station entity to the Flux scheduling system. Stations represent
physical machines in the print shop where tasks are performed.

### What's New

- **Station entity** with UUID, name, code, description, status, category, group, operating hours, and concurrent capacity
- **StationStatus enum** (Active, Inactive, OutOfService, Maintenance)
- **StationCategory stub entity** for work type classification
- **StationGroup stub entity** with maxConcurrent setting
- **Database migration** creating stations, station_categories, station_groups tables
- **Repository classes** with query methods (findByStatus, findByCategory, findByGroup, findActiveStations, findByCode)
- **Domain methods** for status management and availability checks
- **Comprehensive test suite** (50 tests, 88 assertions)

### Database Changes

- New table: `stations`
- New table: `station_categories` (stub)
- New table: `station_groups` (stub)

### Breaking Changes

None (first release of Station Management)

### Migration Guide

Run migrations after deployment:
```bash
php bin/console doctrine:migrations:migrate
```
```

---

## Post-Release

- [x] GitHub release created
- [x] Migration verified on development environment
- [ ] Proceed to v0.1.1 (Station API Endpoints)

---

## Appendix: Domain Vocabulary Quick Reference

| Term | Definition |
|------|------------|
| **Station** | Physical machine or workstation in the print shop |
| **StationStatus** | Operating state: Available, InUse, Maintenance, OutOfService |
| **StationCategory** | Classification by work type (e.g., "Offset Press", "Finishing") |
| **StationGroup** | Logical grouping with concurrency limits |
| **Capacity** | Number of concurrent tasks (typically 1) |
| **OperatingSchedule** | Weekly pattern of availability (v0.1.2) |
| **ScheduleException** | One-time override to regular schedule (v0.1.3) |
