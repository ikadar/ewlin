# Release v0.2.14 – Reschedule Task

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.2.14`

---

## Overview

This release implements the ability to reschedule an already assigned task. Rescheduling allows changing the scheduled start time and/or target (station/provider) of an assigned task without having to unassign and reassign it manually.

Key deliverables:
- PUT /api/v1/tasks/{taskId}/assign endpoint
- Revalidation via Validation Service
- Schedule.rescheduleTask() method
- TaskRescheduled domain event
- RescheduleService for orchestrating the flow

---

## Prerequisites

- [x] `v0.2.13` released (Unassign Task)
- [x] Schedule entity with assignment management
- [x] ValidationServiceClient for revalidation
- [x] EndTimeCalculator for new end time calculation

---

## Scope

### In Scope

- PUT /api/v1/tasks/{taskId}/assign endpoint
- RescheduleService for business logic orchestration
- Schedule.rescheduleTask() method with TaskRescheduled event
- TaskRescheduled domain event
- Revalidation of new assignment via Validation Service
- End time recalculation for new schedule
- Proper error handling (task not assigned, validation failed)
- Unit tests for service and entity logic
- Integration tests for endpoint

### Out of Scope

- Batch rescheduling (multiple tasks at once)
- Automatic conflict resolution
- Undo/redo functionality
- Moving task to different job

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-007 (version increment) |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |

---

## Technical Notes

### Endpoint Design

```
PUT /api/v1/tasks/{taskId}/assign

Request Body:
{
  "targetId": "uuid",           // Required - station or provider ID
  "scheduledStart": "ISO-8601", // Required - new scheduled start time
  "bypassPrecedence": false     // Optional - bypass precedence validation
}

Response 200 OK:
{
  "taskId": "uuid",
  "targetId": "uuid",
  "isOutsourced": boolean,
  "scheduledStart": "ISO-8601",
  "scheduledEnd": "ISO-8601" | null,
  "isCompleted": boolean,
  "completedAt": "ISO-8601" | null
}

Response 400 Bad Request:
{
  "error": "InvalidRequest",
  "message": "Task is not assigned"
}

Response 404 Not Found:
{
  "error": "NotFound",
  "message": "Task not found: {taskId}"
}

Response 409 Conflict:
{
  "error": "ValidationFailed",
  "message": "Reschedule validation failed",
  "conflicts": [...],
  "suggestedStart": "ISO-8601" | null
}
```

### Service Flow

1. Find task by ID (404 if not found)
2. Check task status is "Assigned" (400 if not)
3. Get current schedule and verify task is assigned
4. Validate target exists (station or provider)
5. Build proposed assignment for revalidation
6. Validate via Validation Service (exclude current assignment from conflicts)
7. Calculate new scheduled end time
8. Call schedule.rescheduleTask() with new assignment
9. Persist changes
10. Return updated assignment

### Schedule.rescheduleTask() Method

```php
public function rescheduleTask(TaskAssignment $newAssignment): void
{
    if (!$this->hasAssignment($newAssignment->taskId)) {
        throw new \InvalidArgumentException(
            "Task '{$newAssignment->taskId}' is not assigned to this schedule."
        );
    }

    $oldAssignment = $this->getAssignment($newAssignment->taskId);
    $this->assignments[$newAssignment->taskId] = $newAssignment->jsonSerialize();
    $this->incrementVersion();

    $this->recordEvent(new TaskRescheduled(
        scheduleId: $this->id,
        taskId: $newAssignment->taskId,
        oldTargetId: $oldAssignment->targetId,
        newTargetId: $newAssignment->targetId,
        oldScheduledStart: $oldAssignment->scheduledStart->format(...),
        newScheduledStart: $newAssignment->scheduledStart->format(...),
        // ... etc
    ));
}
```

### Validation Considerations

When rescheduling, the Validation Service should NOT treat the current assignment as a conflict. The SnapshotBuilder should exclude the task being rescheduled from the existing assignments to avoid self-conflict.

---

## Feature Checklist

### Domain Events

- [x] **TaskRescheduled**
  - Description: Event emitted when a task assignment is rescheduled
  - Files: `src/Event/Schedule/TaskRescheduled.php`
  - Tests: `tests/Unit/Event/Schedule/TaskRescheduledTest.php`

### Entity Updates

- [x] **Schedule.rescheduleTask()**
  - Description: Method for updating an existing assignment
  - Files: `src/Entity/Schedule.php` (modify)
  - Tests: `tests/Unit/Entity/ScheduleTest.php` (add tests)

### Services

- [x] **RescheduleService**
  - Description: Service for orchestrating task rescheduling
  - Files: `src/Service/RescheduleService.php`
  - Tests: `tests/Unit/Service/RescheduleServiceTest.php`
  - Methods:
    - `rescheduleTask(string $taskId, AssignTaskRequest $request): TaskAssignment`

### Controller

- [x] **TaskController::reschedule()**
  - Description: PUT endpoint for rescheduling tasks
  - Files: `src/Controller/Api/V1/TaskController.php` (modify)
  - Tests: `tests/Integration/Controller/Api/V1/TaskControllerTest.php` (add tests)

---

## Testing Requirements

### Unit Tests

- [x] TaskRescheduled - event creation and serialization
- [x] Schedule.rescheduleTask() - successful reschedule
- [x] Schedule.rescheduleTask() - task not assigned throws exception
- [x] Schedule.rescheduleTask() - version incremented
- [x] Schedule.rescheduleTask() - event recorded
- [x] RescheduleService - successful reschedule
- [x] RescheduleService - task not found
- [x] RescheduleService - task not assigned
- [x] RescheduleService - validation fails with conflicts
- [x] RescheduleService - target not found

### Integration Tests

- [x] PUT /api/v1/tasks/{taskId}/assign - success (same target, new time)
- [x] PUT /api/v1/tasks/{taskId}/assign - success (different target)
- [x] PUT /api/v1/tasks/{taskId}/assign - task not found (404)
- [x] PUT /api/v1/tasks/{taskId}/assign - task not assigned (400)
- [x] PUT /api/v1/tasks/{taskId}/assign - validation conflict (409)
- [x] PUT /api/v1/tasks/{taskId}/assign - verifies schedule version incremented
- [x] PUT /api/v1/tasks/{taskId}/assign - target not found (404)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.14`

---

## Release Notes Draft

```markdown
## v0.2.14 – Reschedule Task

**Release Date:** 2025-12-14

### Summary

Implements the ability to reschedule an assigned task, allowing changes to the scheduled start time and/or target without manual unassign/reassign.

### What's New

- **PUT /api/v1/tasks/{taskId}/assign** - Endpoint for rescheduling tasks
- **Schedule.rescheduleTask()** - Method for updating existing assignments
- **TaskRescheduled** - Domain event for reschedule operations
- **RescheduleService** - Business logic orchestration

### Technical

- Revalidation via Validation Service
- End time recalculation for new schedule
- BR-SCHED-007: Schedule version increments on reschedule
- PHPStan level 8 compliant
```

---

## Post-Release

- [x] GitHub release created
- [x] Monorepo updated
- [ ] Next release (v0.2.15 - Schedule Snapshot) ready to start
