# Release v0.3.21 â€“ Station Compact API

> **Status:** ðŸ”´ Not Started
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** TBD
>
> **Git Tag:** `v0.3.21`

---

## Overview

Backend API endpoint for station compact operation. The endpoint accepts a station ID and automatically removes empty time gaps between tiles on that station, moving them as early as possible while respecting precedence rules.

---

## Prerequisites

- [x] EndTimeCalculator service (for downtime-aware scheduling)
- [x] Precedence validation logic
- [x] Assignment repository

---

## Scope

### In Scope

- **API endpoint** `POST /api/stations/{id}/compact`
- **CompactStationService** implementing the algorithm
- Respects precedence rules (tile cannot start before predecessor ends)
- Updates all affected assignments in single transaction
- Returns updated assignments in response

### Out of Scope

- Frontend UI (see v0.3.22)
- Compact all stations at once (post-MVP)
- Compact with custom target time

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-003 (Precedence) |

---

## Technical Notes

### API Endpoint

```
POST /api/stations/{id}/compact

Response 200:
{
  "compactedCount": 3,
  "assignments": [
    { "id": "...", "scheduledStart": "...", "scheduledEnd": "..." },
    ...
  ]
}

Response 404: Station not found
Response 400: No assignments to compact
```

### Algorithm

For each tile on the station, from earliest to latest:

1. **Find earliest valid position:**
   - Cannot start before predecessor's `scheduledEnd` (if predecessor is scheduled)
   - Cannot start before current time (no past scheduling)
   - Cannot overlap with previous tile on same station

2. **Calculate new start time:**
   ```
   earliestStart = max(
     predecessorEnd,        // Precedence constraint
     previousTileEnd,       // Station constraint (capacity-1)
     now                    // No past scheduling
   )
   ```

3. **Move tile if beneficial:**
   - If `earliestStart < currentStart`, update assignment
   - Recalculate `scheduledEnd` using EndTimeCalculator

### Service Structure

```php
class CompactStationService
{
    public function __construct(
        private readonly AssignmentRepository $assignmentRepository,
        private readonly TaskRepository $taskRepository,
        private readonly EndTimeCalculator $endTimeCalculator,
        private readonly EntityManagerInterface $em,
    ) {}

    /**
     * @return array<TaskAssignment> Updated assignments
     */
    public function compactStation(Station $station): array
    {
        // 1. Get all assignments for station, ordered by scheduledStart
        // 2. For each assignment, calculate earliest valid start
        // 3. Update if earlier position available
        // 4. Flush all changes in single transaction
    }
}
```

---

## Feature Checklist

### Service

- [ ] **CompactStationService**
  - Description: Service implementing the compact algorithm
  - Files: `services/php-api/src/Service/CompactStationService.php`

- [ ] **Calculate earliest valid position**
  - Description: Find earliest start respecting all constraints
  - Files: `services/php-api/src/Service/CompactStationService.php`

- [ ] **Predecessor lookup**
  - Description: Find predecessor task and its assignment
  - Files: `services/php-api/src/Service/CompactStationService.php`

### Controller

- [ ] **API endpoint**
  - Description: `POST /api/stations/{id}/compact`
  - Files: `services/php-api/src/Controller/StationController.php`

- [ ] **OpenAPI documentation**
  - Description: Document endpoint in API spec
  - Files: `services/php-api/src/Controller/StationController.php`

### Tests

- [ ] **Unit tests for CompactStationService**
  - Description: Test algorithm with various scenarios
  - Files: `services/php-api/tests/Service/CompactStationServiceTest.php`

- [ ] **Integration test for endpoint**
  - Description: Test full request/response cycle
  - Files: `services/php-api/tests/Controller/StationControllerTest.php`

---

## Testing Requirements

### Unit Tests

- [ ] Compact removes gaps between tiles
- [ ] Compact respects precedence (doesn't move before predecessor ends)
- [ ] Compact respects station capacity (no overlaps)
- [ ] Compact handles mixed jobs on same station
- [ ] Compact is no-op when already compact
- [ ] Compact respects "no past scheduling" rule
- [ ] EndTimeCalculator is used for scheduledEnd

### Integration Tests

- [ ] POST returns 200 with updated assignments
- [ ] POST returns 404 for unknown station
- [ ] POST returns 400 when nothing to compact
- [ ] Transaction rolls back on error

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [ ] All feature checklist items completed
- [ ] PHPStan level 8 passes
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] OpenAPI documentation complete
- [ ] PR created and merged to main
- [ ] Git tag created: `v0.3.21`

---

## Release Notes Draft

```markdown
## v0.3.21 â€“ Station Compact API

**Release Date:** TBD

### Summary

New API endpoint for compacting station schedules. Automatically removes empty gaps between tiles, moving them as early as possible while respecting precedence rules.

### API

- `POST /api/stations/{id}/compact` - Compact all tiles on station

### Technical

- CompactStationService implements the algorithm
- Uses EndTimeCalculator for downtime-aware scheduling
- Single transaction for all assignment updates
- Returns updated assignments in response
```

---

## File Structure

```
services/php-api/src/
â”œâ”€â”€ Controller/
â”‚   â””â”€â”€ StationController.php            # POST /api/stations/{id}/compact
â”œâ”€â”€ Service/
â”‚   â””â”€â”€ CompactStationService.php        # Compact algorithm

services/php-api/tests/
â”œâ”€â”€ Service/
â”‚   â””â”€â”€ CompactStationServiceTest.php    # Unit tests
â””â”€â”€ Controller/
    â””â”€â”€ StationControllerTest.php        # Integration tests
```
