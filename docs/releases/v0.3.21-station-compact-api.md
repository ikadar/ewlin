# Release v0.3.21 – Station Compact API

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Release Date:** 2025-12-17
>
> **Git Tag:** `v0.3.21`

---

## Overview

Backend API endpoint for station compact operation. The endpoint accepts a station ID and automatically removes empty time gaps between tiles on that station, moving them as early as possible while respecting precedence rules.

---

## Prerequisites

- [x] EndTimeCalculator service (for downtime-aware scheduling)
- [x] Precedence validation logic
- [x] Assignment repository

---

## Scope

### In Scope

- **API endpoint** `POST /api/v1/stations/{id}/compact`
- **CompactStationService** implementing the algorithm
- Respects precedence rules (tile cannot start before predecessor ends)
- Updates all affected assignments in single transaction
- Returns updated assignments in response

### Out of Scope

- Frontend UI (see v0.3.22)
- Compact all stations at once (post-MVP)
- Compact with custom target time

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-003 (Precedence) |

---

## Technical Notes

### API Endpoint

```
POST /api/v1/stations/{id}/compact

Response 200:
{
  "compactedCount": 3,
  "assignments": [
    { "taskId": "...", "targetId": "...", "scheduledStart": "...", "scheduledEnd": "..." },
    ...
  ]
}

Response 404: Station not found
Response 400: No assignments to compact
```

### Algorithm

For each tile on the station, from earliest to latest:

1. **Find earliest valid position:**
   - Cannot start before predecessor's `scheduledEnd` (if predecessor is scheduled)
   - Cannot start before current time (no past scheduling)
   - Cannot overlap with previous tile on same station

2. **Calculate new start time:**
   ```
   earliestStart = max(
     predecessorEnd,        // Precedence constraint
     previousTileEnd,       // Station constraint (capacity-1)
     now                    // No past scheduling
   )
   ```

3. **Move tile if beneficial:**
   - If `earliestStart < currentStart`, update assignment
   - Recalculate `scheduledEnd` using EndTimeCalculator

---

## Feature Checklist

### Service

- [x] **CompactStationService**
  - Description: Service implementing the compact algorithm
  - Files: `services/php-api/src/Service/CompactStationService.php`

- [x] **Calculate earliest valid position**
  - Description: Find earliest start respecting all constraints
  - Files: `services/php-api/src/Service/CompactStationService.php`

- [x] **Predecessor lookup**
  - Description: Find predecessor task and its assignment
  - Files: `services/php-api/src/Service/CompactStationService.php`

### Controller

- [x] **API endpoint**
  - Description: `POST /api/v1/stations/{id}/compact`
  - Files: `services/php-api/src/Controller/Api/V1/StationController.php`

- [x] **OpenAPI documentation**
  - Description: Document endpoint in API spec
  - Files: `services/php-api/src/Controller/Api/V1/StationController.php`

### Response DTO

- [x] **CompactResponse DTO**
  - Description: Response structure for compact endpoint
  - Files: `services/php-api/src/DTO/Station/CompactResponse.php`

### Tests

- [x] **Unit tests for CompactStationService**
  - Description: Test algorithm with various scenarios (7 tests)
  - Files: `services/php-api/tests/Unit/Service/CompactStationServiceTest.php`

- [x] **Integration test for endpoint**
  - Description: Test full request/response cycle (3 tests)
  - Files: `services/php-api/tests/Integration/Controller/Api/V1/StationControllerTest.php`

---

## Testing Requirements

### Unit Tests

- [x] Compact removes gaps between tiles
- [x] Compact respects precedence (doesn't move before predecessor ends)
- [x] Compact handles mixed jobs on same station
- [x] Compact is no-op when already compact (past assignments)
- [x] Station not found throws exception
- [x] No schedule throws exception
- [x] No assignments throws exception

### Integration Tests

- [x] POST returns 404 for unknown station
- [x] POST returns 400 when nothing to compact
- [x] POST returns 400 when no schedule exists

### E2E Tests

**Not required** - This is a backend-only release. PHPUnit integration tests cover API behavior. Frontend E2E tests will be added in v0.3.22 (Station Compact UI).

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] PHPStan level 8 passes
- [x] All unit tests passing (1145 tests)
- [x] All integration tests passing
- [x] OpenAPI documentation complete
- [x] PR created and merged to main
- [x] Git tag created: `v0.3.21`

---

## Release Notes Draft

```markdown
## v0.3.21 – Station Compact API

**Release Date:** 2025-12-17

### Summary

New API endpoint for compacting station schedules. Automatically removes empty gaps between tiles, moving them as early as possible while respecting precedence rules.

### API

- `POST /api/v1/stations/{id}/compact` - Compact all tiles on station

### Technical

- CompactStationService implements the algorithm
- Uses EndTimeCalculator for downtime-aware scheduling
- Single transaction for all assignment updates
- Returns compactedCount and updated assignments in response
```

---

## File Structure

```
services/php-api/src/
├── Controller/
│   └── Api/V1/StationController.php        # POST /api/v1/stations/{id}/compact
├── DTO/
│   └── Station/CompactResponse.php         # Response DTO
├── Service/
│   └── CompactStationService.php           # Compact algorithm

services/php-api/tests/
├── Unit/Service/
│   └── CompactStationServiceTest.php       # Unit tests (7)
└── Integration/Controller/Api/V1/
    └── StationControllerTest.php           # Integration tests (3)
```
