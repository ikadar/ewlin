# Release v0.3.13 – Real-Time Validation During Drag

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-16
>
> **Git Tag:** `v0.3.13`

---

## Overview

This release implements real-time validation during drag operations using the `@flux/schedule-validator` package. As the user drags a task tile over the scheduling grid, the system validates the proposed position in real-time (<10ms) and provides visual feedback. It also implements the precedence safeguard with auto-snap to valid positions and Alt-key bypass.

---

## Prerequisites

- [x] v0.3.12 - Column Focus on Drag released
- [x] @flux/schedule-validator package available
- [x] DndContext with drag state management
- [x] StationColumn with droppable functionality

---

## Scope

### In Scope

- **Real-time validation** - Validate proposed position on each drag move (<10ms)
- **Valid drop indicator** - Green highlight/ring on valid drop zone
- **Invalid drop indicator** - Red highlight/ring on invalid drop zone
- **Precedence safeguard** - Auto-snap to valid position when precedence would be violated
- **Alt-key bypass** - Allow precedence violation when Alt is held, show red halo warning
- **Validation result caching** - Avoid redundant validation calls

### Out of Scope

- Actual assignment creation on drop (v0.3.14)
- Server-side validation confirmation (v0.3.14)
- Conflict display in Problèmes section (v0.3.14)
- Station availability validation visual (relies on existing unavailability overlay)

---

## Related Documentation

### UX/UI Specification

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Real-time validation, visual feedback |
| [Business Rules](../domain-model/business-rules.md) | UI-001 to UI-005, VAL-001 to VAL-003 |

### Technical

| Package | Usage |
|---------|-------|
| `@flux/schedule-validator` | `validateAssignment()`, `getSuggestedStartForPrecedence()` |

---

## Technical Notes

### Validation Integration

```typescript
import { validateAssignment, getSuggestedStartForPrecedence } from '@flux/schedule-validator';

// Create proposed assignment from drag position
const proposed: ProposedAssignment = {
  taskId: draggedTask.id,
  stationId: targetStation.id,
  scheduledStart: yPositionToTime(snappedY, startHour).toISOString(),
  scheduledEnd: calculateEndTime(...), // Based on task duration
  bypassPrecedence: isAltPressed,
};

// Validate in real-time
const result = validateAssignment(proposed, snapshot);
```

### Performance Requirements

- Validation must complete in <10ms
- Use `isValidAssignment()` for quick checks during drag
- Full `validateAssignment()` on drop for detailed conflicts

### Visual Feedback States

| State | Visual | Class |
|-------|--------|-------|
| Valid drop zone | Green ring/highlight | `ring-2 ring-green-500` |
| Invalid drop zone | Red ring/highlight | `ring-2 ring-red-500` |
| Precedence violation with Alt | Red halo warning | `ring-2 ring-red-500 ring-opacity-50` |

### Precedence Auto-Snap

When precedence would be violated:
1. Get `suggestedStart` from validation result
2. Convert to Y position
3. Snap overlay to that position instead
4. Show indicator at snapped position

### Alt-Key Detection

```typescript
const [isAltPressed, setIsAltPressed] = useState(false);

useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Alt') setIsAltPressed(true);
  };
  const handleKeyUp = (e: KeyboardEvent) => {
    if (e.key === 'Alt') setIsAltPressed(false);
  };
  window.addEventListener('keydown', handleKeyDown);
  window.addEventListener('keyup', handleKeyUp);
  return () => {
    window.removeEventListener('keydown', handleKeyDown);
    window.removeEventListener('keyup', handleKeyUp);
  };
}, []);
```

---

## Feature Checklist

### Validator Integration

- [x] **Install @flux/schedule-validator in web app**
  - Description: Add validator package to web app dependencies
  - Files: `apps/web/package.json`

- [x] **Create validation hook**
  - Description: Hook to validate proposed assignment during drag
  - Files: `apps/web/src/hooks/useDropValidation.ts`

### Drag Move Handler

- [x] **Add onDragMove handler**
  - Description: Track cursor position during drag for real-time validation
  - Files: `apps/web/src/App.tsx`

- [x] **Calculate proposed assignment**
  - Description: Convert drag position to ProposedAssignment
  - Files: `apps/web/src/App.tsx`

- [x] **Track validation state**
  - Description: Store current validation result in state
  - Files: `apps/web/src/App.tsx`

### Visual Feedback

- [x] **Valid drop zone indicator**
  - Description: Green ring on StationColumn when drop would be valid
  - Files: `apps/web/src/components/StationColumns/StationColumn.tsx`

- [x] **Invalid drop zone indicator**
  - Description: Red ring on StationColumn when drop would be invalid
  - Files: `apps/web/src/components/StationColumns/StationColumn.tsx`

- [x] **Pass validation state to column**
  - Description: Pass isValid/isInvalid state from App to StationColumn
  - Files: `apps/web/src/App.tsx`, `apps/web/src/components/SchedulingGrid/SchedulingGrid.tsx`

### Precedence Safeguard

- [x] **Detect precedence conflict**
  - Description: Check if validation result contains PrecedenceConflict
  - Files: `apps/web/src/App.tsx`

- [x] **Calculate auto-snap position**
  - Description: Use suggestedStart from validation result
  - Files: `apps/web/src/App.tsx`

- [x] **Show snap indicator**
  - Description: Visual indicator at snapped position (amber warning on column)
  - Files: `apps/web/src/components/StationColumns/StationColumn.tsx`

### Alt-Key Bypass

- [x] **Track Alt key state**
  - Description: Global keyboard listener for Alt key
  - Files: `apps/web/src/App.tsx`

- [x] **Pass bypass flag to validator**
  - Description: Set bypassPrecedence: true when Alt is pressed
  - Files: `apps/web/src/App.tsx`

- [x] **Show bypass warning visual**
  - Description: Amber ring effect when bypassing precedence
  - Files: `apps/web/src/components/StationColumns/StationColumn.tsx`

### Type Updates

- [x] **Add validation state types**
  - Description: Types for validation result state
  - Files: `apps/web/src/App.tsx`

---

## Testing Requirements

### Unit Tests

- [x] useDropValidation hook returns valid for valid position
- [x] useDropValidation hook returns invalid for conflict
- [x] useDropValidation hook returns suggestedStart for precedence conflict
- [x] StationColumn shows green ring when isValidDrop is true
- [x] StationColumn shows red ring when isInvalidDrop is true
- [x] StationColumn shows amber ring when showBypassWarning is true
- [x] Bypass warning takes priority over valid/invalid states

### Integration Tests

- [x] Validation runs during drag move
- [x] Visual feedback updates in real-time
- [x] Precedence auto-snap works correctly
- [x] Alt bypass allows precedence violation

### Manual Testing

- [x] Drag task over valid position - green indicator
- [x] Drag task over invalid position - red indicator
- [x] Drag task that would violate precedence - snaps to valid position
- [x] Hold Alt while dragging - bypasses precedence safeguard
- [x] Validation feedback responds within 10ms (no perceivable lag)

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing (377 tests)
- [x] TypeScript compiles without errors
- [x] Lint passes
- [x] Documentation updated
- [x] Merged to ux-ui-development branch

---

## Release Notes Draft

```markdown
## v0.3.13 – Real-Time Validation During Drag

**Release Date:** 2025-12-16

### Summary

Real-time validation during drag operations using @flux/schedule-validator. Visual feedback shows valid (green) and invalid (red) drop zones. Precedence safeguard auto-snaps to valid positions with Alt-key bypass option.

### What's New

- Real-time validation on drag move (<10ms)
- Green indicator for valid drop zones
- Red indicator for invalid drop zones
- Precedence safeguard with auto-snap
- Alt-key bypass for precedence rules (shows red halo warning)

### Technical

- @flux/schedule-validator integration
- useDropValidation hook
- Keyboard listener for Alt key
- onDragMove handler for real-time position tracking
```

---

## File Structure

```
apps/web/src/
├── App.tsx                              # Drag handlers, validation state, Alt key
├── hooks/
│   └── useDropValidation.ts             # Validation hook
├── components/
│   ├── SchedulingGrid/
│   │   └── SchedulingGrid.tsx           # Pass validation state
│   ├── StationColumns/
│   │   └── StationColumn.tsx            # Valid/invalid visual feedback
│   └── DragPreview/
│       └── DragPreview.tsx              # Snap indicator, bypass warning
```
