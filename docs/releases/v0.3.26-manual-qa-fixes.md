# Release v0.3.26 – Manual QA Fixes

> **Status:** ✅ Released
>
> **Milestone:** M3 (Frontend Integration)
>
> **Release Date:** 2025-12-18
>
> **Git Tag:** `v0.3.26`

---

## Overview

Bug fixes discovered during manual QA testing of the Grid Tile Repositioning feature (v0.3.25). The main issues were:

1. **Collision detection failure** - dnd-kit's default collision detection couldn't detect the correct station column when dragging grid tiles
2. **Validator not rebuilt** - The v0.3.24 precedence validator changes weren't compiled
3. **Mock data issues** - Group capacity and BAT approval settings caused unnecessary validation conflicts

---

## Prerequisites

- [x] v0.3.25 - Grid Tile Repositioning released
- [x] v0.3.24 - No Conflict for Unscheduled Predecessors released

---

## Scope

### In Scope

- Custom collision detection using `document.elementsFromPoint()`
- Reschedule validation bypass (existing tiles can be repositioned regardless of conflicts)
- Validator package rebuild
- Mock data fixes (group capacity, BAT approval probability)

### Out of Scope

- New features
- Backend changes
- API changes

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-VALID-001 (Precedence validation) |

---

## Technical Notes

### Root Cause Analysis

#### 1. Collision Detection Failure

**Problem:** When dragging a grid tile, dnd-kit's default `rectIntersection` collision detection returned `null` for the correct station column, but detected other columns.

**Investigation:**
- dnd-kit's cached rect values became stale during drag operations
- The draggable element (ghost placeholder) inside the droppable (station column) caused detection issues
- `pointerWithin` collision detection also failed due to internal filtering

**Solution:** Custom collision detection using `document.elementsFromPoint()`:
```typescript
const pointerBasedCollision: CollisionDetection = ({
  droppableContainers,
  pointerCoordinates,
}) => {
  const elements = document.elementsFromPoint(
    pointerCoordinates.x,
    pointerCoordinates.y
  );
  const stationColumnElement = elements.find(el =>
    el.getAttribute('data-testid')?.startsWith('station-column-')
  );
  // ... find matching droppable container
};
```

#### 2. DragPreview Pointer Events

**Problem:** Without `pointer-events-none` on the DragPreview component, an infinite update loop occurred.

**Root Cause:** The DragPreview follows the cursor. When it captures pointer events:
1. PointerSensor receives events from DragPreview instead of underlying elements
2. This triggers continuous state updates in dnd-kit
3. Results in "Maximum update depth exceeded" error

**Solution:** Added `pointer-events-none` class to DragPreview component.

#### 3. Validator Not Rebuilt

**Problem:** The v0.3.24 changes to precedence validation (allowing unscheduled predecessors) were in the source code but not compiled to the `dist/` folder.

**Solution:** Ran `pnpm build` in the validator package.

#### 4. Mock Data Configuration

**Problem:**
- `grp-cutting` (Massicots) had `maxConcurrent: 1` but 2 stations in the group
- BAT approval had only 50% probability, causing many ApprovalGateConflicts

**Solution:**
- Changed `maxConcurrent` from 1 to 2
- Changed BAT approval probability from 50% to 90%

---

## Feature Checklist

### Collision Detection

- [x] **Custom collision detection function**
  - Description: Uses `document.elementsFromPoint()` to find station column under pointer
  - Files: `apps/web/src/App.tsx`

- [x] **MeasuringStrategy.Always**
  - Description: Ensures dnd-kit remeasures droppables on every render
  - Files: `apps/web/src/App.tsx`

### Drag Preview

- [x] **pointer-events-none on DragPreview**
  - Description: Prevents DragPreview from capturing pointer events
  - Files: `apps/web/src/components/DragPreview/DragPreview.tsx`

### Validation

- [x] **Reschedule bypass**
  - Description: Existing tiles can be repositioned regardless of validation conflicts
  - Files: `apps/web/src/App.tsx`

- [x] **isRescheduleDrag state**
  - Description: Tracks whether current drag is reschedule vs new placement
  - Files: `apps/web/src/App.tsx`

### Validator Package

- [x] **Rebuild validator package**
  - Description: Compile v0.3.24 changes to dist/
  - Files: `packages/validator/dist/`

### Mock Data

- [x] **Group capacity fix**
  - Description: Changed Massicots maxConcurrent from 1 to 2
  - Files: `apps/web/src/mock/generators/stations.ts`

- [x] **BAT approval probability**
  - Description: Changed approval probability from 50% to 90%
  - Files: `apps/web/src/mock/generators/jobs.ts`

- [x] **Local compact implementation**
  - Description: Compact feature works in mock mode (no API call)
  - Files: `apps/web/src/App.tsx`

### Column Collapse

- [x] **Disable column collapse during reschedule**
  - Description: Columns stay full width when repositioning existing tiles
  - Files: `apps/web/src/App.tsx`, `apps/web/src/components/SchedulingGrid/SchedulingGrid.tsx`

---

## Testing Requirements

### Unit Tests

- [x] All 465 existing unit tests passing
- [x] No new unit tests required (bug fixes only)

### E2E Tests

- [x] All 9 grid-tile-repositioning E2E tests passing

### Manual Testing

- [x] Drag grid tile within same station column - green highlight appears
- [x] Drop grid tile - reschedule succeeds
- [x] Drag from sidebar - validation conflicts shown appropriately
- [x] No infinite loop errors during drag

---

## Definition of Done

- [x] All feature checklist items completed
- [x] All unit tests passing (465 tests)
- [x] All E2E tests passing (9 tests)
- [x] Manual testing completed
- [x] Documentation updated

---

## Release Notes Draft

```markdown
## v0.3.26 – Manual QA Fixes

**Release Date:** 2025-12-18

### Summary

Bug fixes for Grid Tile Repositioning (v0.3.25) discovered during manual QA testing. Resolves collision detection issues, infinite loop errors, and validation false positives.

### Bug Fixes

- Fixed collision detection not recognizing correct station column during drag
- Fixed infinite loop error when dragging tiles (DragPreview pointer events)
- Fixed reschedule being blocked by pre-existing validation conflicts
- Fixed validator package not rebuilt after v0.3.24 changes
- Fixed mock data causing unnecessary GroupCapacity and ApprovalGate conflicts
- Fixed compact feature not working in mock mode
- Fixed column collapse during reschedule drag

### Technical Changes

- Custom collision detection using `document.elementsFromPoint()`
- Added `pointer-events-none` to DragPreview component
- Added `isRescheduleDrag` state for validation bypass and column collapse control
- Local compact implementation for mock mode
- Rebuilt @flux/schedule-validator package
```

---

## Files Changed

```
apps/web/src/App.tsx
  - Custom collision detection (pointerBasedCollision)
  - isRescheduleDrag state
  - MeasuringStrategy.Always
  - Reschedule validation bypass
  - Local compact implementation (mock mode)
  - Pass isRescheduleDrag to SchedulingGrid

apps/web/src/components/SchedulingGrid/SchedulingGrid.tsx
  - isRescheduleDrag prop
  - Column collapse disabled during reschedule

apps/web/src/components/DragPreview/DragPreview.tsx
  - pointer-events-none class

apps/web/src/mock/generators/stations.ts
  - maxConcurrent: 2 for grp-cutting

apps/web/src/mock/generators/jobs.ts
  - 90% BAT approval probability

packages/validator/dist/
  - Rebuilt from source
```
