# Release v0.2.15 – Schedule Snapshot Endpoint

> **Status:** ✅ Released
>
> **Milestone:** M2 (Scheduling Core)
>
> **Target Date:** 2025-12-14
>
> **Git Tag:** `v0.2.15`

---

## Overview

This release implements the Schedule Snapshot API endpoint that returns the complete current schedule state. The snapshot includes all entities (stations, jobs, tasks, assignments) and metadata for the frontend to render the schedule grid. This endpoint is the primary data source for the scheduling UI.

Key deliverables:
- GET /api/v1/schedule/snapshot endpoint
- Full schedule snapshot with all entities
- snapshotVersion for optimistic locking/caching
- Conflict and late job inclusion (placeholder arrays for MVP)

---

## Prerequisites

- [x] `v0.2.14` released (Reschedule Task)
- [x] SnapshotBuilder with entity building methods
- [x] Schedule entity with assignments
- [x] ScheduleSnapshot DTO

---

## Scope

### In Scope

- GET /api/v1/schedule/snapshot endpoint
- SnapshotBuilder.buildFullSnapshot() method
- All stations aggregation with operating schedules
- All station categories and groups
- All outsourced providers
- All jobs (non-cancelled) with tasks
- All assignments from current schedule
- Version for optimistic locking
- Empty conflicts and lateJobs arrays (calculated by Validation Service)
- Unit tests for full snapshot building
- Integration tests for endpoint

### Out of Scope

- Server-side conflict calculation (done by Validation Service)
- Server-side late job calculation (done by Validation Service)
- Pagination (full snapshot for MVP)
- Filtering by date range
- Real-time updates via WebSocket

---

## Related Documentation

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | BR-SCHED-007 (schedule versioning) |

### Architecture

| Document | Sections |
|----------|----------|
| [Decision Records](../architecture/decision-records.md) | ADR-010 (Isomorphic validation) |

---

## Technical Notes

### Endpoint Design

```
GET /api/v1/schedule/snapshot

Response 200 OK:
{
  "version": 42,
  "generatedAt": "2025-12-14T10:00:00+00:00",
  "stations": [...],
  "categories": [...],
  "groups": [...],
  "providers": [...],
  "jobs": [...],
  "tasks": [...],
  "assignments": [...],
  "conflicts": [],
  "lateJobs": []
}
```

### Data Aggregation

The full snapshot aggregates:
1. **Stations** - All active/inactive stations with operating schedules and exceptions
2. **Categories** - All station categories with similarity criteria
3. **Groups** - All station groups with maxConcurrent settings
4. **Providers** - All outsourced providers with supported action types
5. **Jobs** - All non-cancelled jobs with workshopExitDate
6. **Tasks** - All tasks from included jobs
7. **Assignments** - All assignments from current schedule

### Conflict and Late Jobs

For MVP, conflicts and lateJobs are returned as empty arrays. The Validation Service calculates these on the frontend when needed. In future releases, we may pre-calculate these server-side.

### Repository Methods Needed

The SnapshotBuilder needs to query all entities:
- `StationRepository::findAll()` - Get all stations
- `StationCategoryRepository::findAll()` - Get all categories
- `StationGroupRepository::findAll()` - Get all groups
- `OutsourcedProviderRepository::findAll()` - Get all providers
- `JobRepository::findNonCancelled()` - Get all non-cancelled jobs

---

## Feature Checklist

### Controller

- [x] **ScheduleController::snapshot()**
  - Description: GET endpoint returning full schedule snapshot
  - Files: `src/Controller/Api/V1/ScheduleController.php`
  - Tests: `tests/Integration/Controller/Api/V1/ScheduleControllerTest.php`

### Services

- [x] **SnapshotBuilder::buildFullSnapshot()**
  - Description: Builds complete schedule snapshot with all entities
  - Files: `src/Service/SnapshotBuilder.php` (modify)
  - Tests: `tests/Unit/Service/SnapshotBuilderTest.php`

### Repository

- [x] **JobRepository::findNonCancelled()**
  - Description: Query for non-cancelled jobs with eager loading
  - Files: `src/Repository/JobRepository.php` (modify)
  - Tests: Covered by integration tests

---

## Testing Requirements

### Unit Tests

- [x] SnapshotBuilder.buildFullSnapshot() - returns all stations
- [x] SnapshotBuilder.buildFullSnapshot() - returns all categories
- [x] SnapshotBuilder.buildFullSnapshot() - returns all groups
- [x] SnapshotBuilder.buildFullSnapshot() - returns all providers
- [x] SnapshotBuilder.buildFullSnapshot() - returns non-cancelled jobs
- [x] SnapshotBuilder.buildFullSnapshot() - returns all assignments
- [x] SnapshotBuilder.buildFullSnapshot() - includes schedule version
- [x] SnapshotBuilder.buildFullSnapshot() - returns version 1 when no schedule
- [x] SnapshotBuilder.buildFullSnapshot() - includes empty conflicts/lateJobs
- [x] SnapshotBuilder.buildFullSnapshot() - includes generatedAt timestamp

### Integration Tests

- [x] GET /api/v1/schedule/snapshot - returns 200 with valid structure
- [x] GET /api/v1/schedule/snapshot - includes all stations
- [x] GET /api/v1/schedule/snapshot - includes version from schedule
- [x] GET /api/v1/schedule/snapshot - empty schedule returns version 1
- [x] GET /api/v1/schedule/snapshot - includes non-cancelled jobs with tasks
- [x] GET /api/v1/schedule/snapshot - includes assignments
- [x] GET /api/v1/schedule/snapshot - includes providers
- [x] GET /api/v1/schedule/snapshot - returns empty conflicts/lateJobs

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [x] All feature checklist items completed
- [x] All unit tests passing
- [x] All integration tests passing
- [x] PHPStan level 8 passing
- [x] Code reviewed and approved
- [x] CHANGELOG.md updated
- [x] Git tag created: `v0.2.15`

---

## Release Notes Draft

```markdown
## v0.2.15 – Schedule Snapshot Endpoint

**Release Date:** 2025-12-14

### Summary

Implements the Schedule Snapshot API endpoint that returns the complete current schedule state for the frontend scheduling UI.

### What's New

- **GET /api/v1/schedule/snapshot** - Full schedule state endpoint
- **SnapshotBuilder.buildFullSnapshot()** - Aggregates all scheduling entities
- **snapshotVersion** - For optimistic locking and cache invalidation

### Technical

- Aggregates stations, categories, groups, providers, jobs, tasks, assignments
- Empty conflicts/lateJobs arrays (calculated client-side by Validation Service)
- PHPStan level 8 compliant
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Monorepo updated
- [ ] Next release (v0.2.16 - Business Calendar) ready to start
