# Release v0.3.29 â€“ Job Focus & Conflict Visual Feedback

> **Status:** ðŸŸ¡ In Progress
>
> **Milestone:** M3 (Frontend Integration)
>
> **Target Date:** 2025-12-22
>
> **Git Tag:** `v0.3.29`
>
> **Implements:** [REQ-01](../ux-ui/additional-requirements/refactored-new-requirements-en.md#req-01-job-focus-visual-effect), [REQ-12](../ux-ui/additional-requirements/refactored-new-requirements-en.md#req-12-persistent-visual-feedback-for-precedence-violations)

---

## Overview

This release implements two visual feedback enhancements:

1. **REQ-01 - Job Focus Visual Effect:** When a job is selected (focused), all non-selected job tiles are muted, not just during drag operations. This provides consistent visual focus on the selected job.

2. **REQ-12 - Persistent Conflict Visual Feedback:** Tiles with precedence conflicts show a persistent amber glow, making conflicts visible at all times (not just during drag).

**Prerequisite:** v0.3.28 fixed the Alt+drag bypass bug, so conflicts are now correctly recorded. This release builds on that to show visual feedback on the tiles.

---

## Prerequisites

- [x] `v0.3.28` released (Alt+Drag Bypass Bug Fix - conflicts are now recorded)

---

## Scope

### In Scope

- **REQ-01:** Extend `isMuted` logic to work when job is selected (not just during drag)
- **REQ-12:** Add `hasConflict` prop to Tile component
- **REQ-12:** Amber glow on conflict tiles: `box-shadow: 0 0 12px 4px #F59E0B99`
- **REQ-12:** Conflict glow overrides selection glow
- E2E tests for visual feedback states
- Test fixtures for both scenarios

### Out of Scope

- Job deselection methods (REQ-02/03 - next release v0.3.30)
- Real-time drag snapping (REQ-08/09 - v0.3.31)
- Any backend changes

---

## Related Documentation

### Requirements

| Document | Sections |
|----------|----------|
| [Refactored Requirements](../ux-ui/additional-requirements/refactored-new-requirements-en.md) | REQ-01, REQ-12 |
| [UI Interaction Stories](../ux-ui/specifications/ui-interaction-stories.md) | US-UI-002 (Job Focus), US-UI-004 (Validation) |

### Domain Model

| Document | Sections |
|----------|----------|
| [Business Rules](../domain-model/business-rules.md) | UI-002 (Alt-key bypass), BR-SCHED-003 |

### UX-UI

| Document | Sections |
|----------|----------|
| [Drag and Drop](../ux-ui/01-interaction-patterns/drag-drop.md) | Alt-Key Bypass |
| [Conflict Indicators](../ux-ui/04-visual-feedback/conflict-indicators.md) | Precedence Violation |

---

## Technical Notes

### REQ-01: Job Focus Visual Effect

**Current behavior:**
- Glow effect on selected tiles: Already implemented (`isSelected` prop)
- Muting effect: Only active during drag (`activeJobId !== undefined`)

**Required change:**
- Muting should also work when job is selected (`selectedJobId !== undefined`)

**Implementation:**
```typescript
// Current Tile.tsx logic:
const isMuted = activeJobId !== undefined && activeJobId !== jobId;

// New logic:
const isMuted = (activeJobId !== undefined && activeJobId !== jobId) ||
                (selectedJobId !== undefined && selectedJobId !== jobId);
```

**Files affected:**
- `apps/web/src/components/scheduling/Tile.tsx` - Add `selectedJobId` prop and extend muting logic
- `apps/web/src/components/scheduling/SchedulingGrid.tsx` - Pass `selectedJobId` to tiles

### REQ-12: Persistent Conflict Visual Feedback

**Current behavior:**
- Conflicts are recorded in `snapshot.conflicts` (fixed in v0.3.28)
- Jobs appear in "Problemes" section with amber styling
- Tiles do NOT show visual indication of conflict

**Required change:**
- Tiles with `PrecedenceConflict` should show amber glow

**Implementation:**
```typescript
// Tile.tsx - new prop
interface TileProps {
  // ... existing props
  hasConflict?: boolean;
}

// Style calculation
const glowStyle = useMemo(() => {
  if (hasConflict) {
    // Conflict glow overrides selection glow
    return 'box-shadow: 0 0 12px 4px #F59E0B99';
  }
  if (isSelected) {
    return `box-shadow: 0 0 12px 4px ${jobColor}99`;
  }
  return undefined;
}, [hasConflict, isSelected, jobColor]);
```

**Conflict tile detection:**
```typescript
// In SchedulingGrid or parent component
const conflictTaskIds = useMemo(() => {
  return snapshot.conflicts
    .filter(c => c.type === 'PrecedenceConflict')
    .map(c => c.taskId);
}, [snapshot.conflicts]);

// Pass to Tile
<Tile hasConflict={conflictTaskIds.includes(task.id)} />
```

---

## Feature Checklist

### REQ-01: Job Focus Visual Effect

- [x] **Extend Tile muting logic**
  - Description: Mute non-selected job tiles when any job is selected
  - Files: `apps/web/src/components/Tile/Tile.tsx`
  - Tests: E2E test

- [x] **Pass selectedJobId to Tile components**
  - Description: SchedulingGrid passes selectedJobId to all tiles
  - Files: `apps/web/src/components/SchedulingGrid/SchedulingGrid.tsx`
  - Tests: E2E test

### REQ-12: Persistent Conflict Visual Feedback

- [x] **Add hasConflict prop to Tile**
  - Description: New prop for conflict state
  - Files: `apps/web/src/components/Tile/Tile.tsx`
  - Tests: E2E test

- [x] **Implement amber glow for conflict tiles**
  - Description: `box-shadow: 0 0 12px 4px #F59E0B99` on conflict
  - Files: `apps/web/src/components/scheduling/Tile.tsx`
  - Tests: E2E test

- [x] **Conflict glow overrides selection glow**
  - Description: When tile has conflict AND is selected, show amber (not job color)
  - Files: `apps/web/src/components/Tile/Tile.tsx`
  - Tests: E2E test

- [x] **Pass conflict state to tiles**
  - Description: Calculate conflictTaskIds and pass to Tile components
  - Files: `apps/web/src/components/SchedulingGrid/SchedulingGrid.tsx`
  - Tests: E2E test

### Testing

- [x] **E2E test: Visual feedback**
  - Description: Test muting and conflict glow (combined)
  - Files: `apps/web/playwright/visual-feedback.spec.ts`

- [x] **Reused existing test fixtures**
  - Description: Uses `test` and `alt-bypass` fixtures
  - Files: No new fixtures needed

---

## Testing Requirements

### Unit Tests

- [x] N/A - Visual logic is simple enough to verify via E2E

### E2E Tests

- [x] Select job â†’ non-selected job tiles are muted
- [ ] Deselect job â†’ all tiles return to normal (skipped - REQ-02/03 not implemented yet)
- [x] Create precedence conflict via Alt+drop â†’ tile shows amber glow
- [x] Move conflicting task to valid position â†’ amber glow disappears
- [x] Select job with conflict tile â†’ amber glow (not job color glow)

### Manual Testing

- [ ] Start dev server: `pnpm dev`
- [ ] REQ-01: Load `http://localhost:5173/?fixture=test` - verify job focus muting
- [ ] REQ-12: Load `http://localhost:5173/?fixture=alt-bypass` - verify conflict amber glow

---

## Manual QA Test Plan

### Test Fixtures

| Fixture | URL | Purpose |
|---------|-----|---------|
| `test` | `http://localhost:5173/?fixture=test` | REQ-01: Multiple jobs (3 jobs, 3 tiles) |
| `alt-bypass` | `http://localhost:5173/?fixture=alt-bypass` | REQ-12: Conflict testing (2 sequential tasks) |

### Test Scenarios

#### Scenario 1: Job Focus Mutes Other Tiles (REQ-01)

**Fixture:** `test`

**Preconditions:**
- 3 jobs visible (TEST-001, TEST-002, TEST-003)
- 3 tiles on the grid (2 on Komori, 1 on Heidelberg)

**Steps:**
1. Click on job TEST-001 in the Jobs List to select it
2. Observe the grid tiles

**Expected Results:**
- [ ] Selected job's tile (TEST-001 on Komori) has glow effect
- [ ] Other jobs' tiles (TEST-002, TEST-003) are muted (`filter: saturate(0.2); opacity: 0.6`)
- [ ] Select a different job â†’ muting updates to show new selection

#### Scenario 2: Conflict Tile Shows Amber Glow (REQ-12)

**Fixture:** `alt-bypass`

**Preconditions:**
- Task 1 (BYPASS-001) is scheduled at 10:00-11:00 on Komori
- Task 2 is unscheduled, must start after 11:00

**Steps:**
1. Select the job
2. Drag Task 2 to 09:00 (before Task 1 ends)
3. Hold Alt and drop
4. Observe the placed tile

**Expected Results:**
- [ ] Task 2 tile shows amber glow (`box-shadow: 0 0 12px 4px #F59E0B99`)
- [ ] Job appears in "Problemes" section
- [ ] Amber glow persists (not just during drag)

#### Scenario 3: Conflict Glow Overrides Selection Glow

**Preconditions:**
- Task 2 has a recorded precedence conflict (from Scenario 2)

**Steps:**
1. Select the job (if not already selected)
2. Observe Task 2 tile

**Expected Results:**
- [ ] Task 2 shows amber glow (NOT job color glow)
- [ ] Other tiles from same job show job color glow
- [ ] Muted tiles from other jobs remain muted

#### Scenario 4: Conflict Cleared When Task Moved to Valid Position

**Preconditions:**
- Task 2 has a recorded precedence conflict

**Steps:**
1. Drag Task 2 to 12:00 (after Task 1 ends)
2. Drop the task

**Expected Results:**
- [ ] Task 2 now at valid position (12:00)
- [ ] Amber glow disappears
- [ ] Job disappears from "Problemes" section
- [ ] If job selected, tile shows normal job color glow

---

## Definition of Done

All items must be checked for the release to be considered complete:

- [ ] All feature checklist items completed
- [ ] All E2E tests passing
- [ ] Manual testing completed
- [ ] Lint and TypeScript checks passing
- [ ] Documentation updated (this file)
- [ ] Roadmap updated (mark v0.3.29 as complete)
- [ ] Git tag created: `v0.3.29`
- [ ] GitHub release created

---

## Release Notes Draft

```markdown
## v0.3.29 â€“ Job Focus & Conflict Visual Feedback

**Release Date:** 2025-12-22

### Summary

Two visual feedback enhancements that improve scheduling clarity:
1. Non-selected job tiles are now muted when any job is focused
2. Tiles with precedence conflicts show persistent amber glow

### What's New

- **Job Focus Visual Effect (REQ-01):** When you select a job, all other job tiles
  are muted (desaturated + reduced opacity), making it easier to focus on the
  selected job's tasks.

- **Persistent Conflict Visual Feedback (REQ-12):** Tiles placed with precedence
  violations (via Alt+drop) now show a persistent amber glow, making conflicts
  visible at all times. The amber glow takes priority over the selection glow.

### Technical Details

- Extended `isMuted` logic in Tile component
- Added `hasConflict` prop to Tile component
- Conflict detection from `snapshot.conflicts` array

### Manual QA

Test URL: `http://localhost:5173/?fixture=alt-bypass`

1. Select a job â†’ other job tiles become muted
2. Create conflict via Alt+drop â†’ tile shows amber glow
3. Move tile to valid position â†’ amber glow disappears

### Related

- Prerequisite: v0.3.28 (Alt+Drag Bypass Bug Fix)
- Next: v0.3.30 (Job Deselection Methods)
```

---

## Post-Release

- [ ] GitHub release created
- [ ] Verify on ux-ui-development branch
- [ ] Proceed to v0.3.30 (REQ-02/03) implementation
